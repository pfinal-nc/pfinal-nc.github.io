import{_ as i,o as a,c as n,ac as h}from"./chunks/framework.CxPy2qzZ.js";const g=JSON.parse('{"title":"PHP 8.x é«˜é˜¶å®æˆ˜ï¼šæ¶æ„ã€æ€§èƒ½ä¸å·¥ç¨‹åŒ– | ç°ä»£PHPå¼€å‘æŒ‡å—","description":"æ·±å…¥æ¢ç´¢PHP 8.xæ–°ç‰¹æ€§ã€æ¶æ„è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–å’Œå·¥ç¨‹åŒ–å®è·µã€‚æ¶µç›–Attributesã€Enumsã€Fibersã€Laravelæ¡†æ¶ã€APIè®¾è®¡ã€å¹¶å‘ç¼–ç¨‹ã€DevOpsç­‰é«˜çº§ä¸»é¢˜ã€‚","frontmatter":{"title":"PHP 8.x é«˜é˜¶å®æˆ˜ï¼šæ¶æ„ã€æ€§èƒ½ä¸å·¥ç¨‹åŒ– | ç°ä»£PHPå¼€å‘æŒ‡å—","description":"æ·±å…¥æ¢ç´¢PHP 8.xæ–°ç‰¹æ€§ã€æ¶æ„è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–å’Œå·¥ç¨‹åŒ–å®è·µã€‚æ¶µç›–Attributesã€Enumsã€Fibersã€Laravelæ¡†æ¶ã€APIè®¾è®¡ã€å¹¶å‘ç¼–ç¨‹ã€DevOpsç­‰é«˜çº§ä¸»é¢˜ã€‚","keywords":["PHP 8.x","Laravel","æ¶æ„è®¾è®¡","æ€§èƒ½ä¼˜åŒ–","å·¥ç¨‹åŒ–","Attributes","Enums","Fibers","å¼‚æ­¥ç¼–ç¨‹","DevOps","APIè®¾è®¡","ä»£ç è´¨é‡"],"category":["åç«¯å¼€å‘"],"tags":["php","Laravel","æ¶æ„è®¾è®¡"],"date":"2025-12-18T15:30:00.000Z","recommend":"åç«¯å·¥ç¨‹","head":[["link",{"rel":"canonical","href":"https://friday-go.icu/dev/backend/php/ç°ä»£PHPå¼€å‘å®æˆ˜"}],["meta",{"name":"keywords","content":"PHP 8.x,Laravel,æ¶æ„è®¾è®¡,æ€§èƒ½ä¼˜åŒ–,å·¥ç¨‹åŒ–,Attributes,Enums,Fibers,å¼‚æ­¥ç¼–ç¨‹,DevOps,APIè®¾è®¡,ä»£ç è´¨é‡, PFinalClub, Golangæ•™ç¨‹, Goåç«¯å¼€å‘, Goå¾®æœåŠ¡, PHP, Python, æŠ€æœ¯åšå®¢"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"TechArticle\\",\\"headline\\":\\"PHP 8.x é«˜é˜¶å®æˆ˜ï¼šæ¶æ„ã€æ€§èƒ½ä¸å·¥ç¨‹åŒ– | ç°ä»£PHPå¼€å‘æŒ‡å—\\",\\"url\\":\\"https://friday-go.icu/dev/backend/php/ç°ä»£PHPå¼€å‘å®æˆ˜\\",\\"datePublished\\":\\"2025-12-18T15:30:00.000Z\\",\\"dateModified\\":1766143110000,\\"author\\":{\\"@type\\":\\"Person\\",\\"name\\":\\"PFinalå—ä¸\\",\\"url\\":\\"https://friday-go.icu/about\\"},\\"publisher\\":{\\"@type\\":\\"Organization\\",\\"name\\":\\"PFinalClub\\",\\"logo\\":{\\"@type\\":\\"ImageObject\\",\\"url\\":\\"https://friday-go.icu/logo.png\\"}},\\"description\\":\\"æ·±å…¥æ¢ç´¢PHP 8.xæ–°ç‰¹æ€§ã€æ¶æ„è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–å’Œå·¥ç¨‹åŒ–å®è·µã€‚æ¶µç›–Attributesã€Enumsã€Fibersã€Laravelæ¡†æ¶ã€APIè®¾è®¡ã€å¹¶å‘ç¼–ç¨‹ã€DevOpsç­‰é«˜çº§ä¸»é¢˜ã€‚\\",\\"inLanguage\\":\\"zh-CN\\",\\"mainEntityOfPage\\":{\\"@type\\":\\"WebPage\\",\\"@id\\":\\"https://friday-go.icu/dev/backend/php/ç°ä»£PHPå¼€å‘å®æˆ˜\\"},\\"keywords\\":[\\"PHP 8.x\\",\\"Laravel\\",\\"æ¶æ„è®¾è®¡\\",\\"æ€§èƒ½ä¼˜åŒ–\\",\\"å·¥ç¨‹åŒ–\\",\\"Attributes\\",\\"Enums\\",\\"Fibers\\",\\"å¼‚æ­¥ç¼–ç¨‹\\",\\"DevOps\\",\\"APIè®¾è®¡\\",\\"ä»£ç è´¨é‡\\"],\\"articleSection\\":[\\"åç«¯å¼€å‘\\"]}"],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"BreadcrumbList\\",\\"itemListElement\\":[{\\"@type\\":\\"ListItem\\",\\"position\\":1,\\"name\\":\\"é¦–é¡µ\\",\\"item\\":{\\"@id\\":\\"https://friday-go.icu\\",\\"@type\\":\\"WebPage\\"}},{\\"@type\\":\\"ListItem\\",\\"position\\":2,\\"name\\":\\"å¼€å‘ä¸ç³»ç»Ÿ\\",\\"item\\":{\\"@id\\":\\"https://friday-go.icu/dev\\",\\"@type\\":\\"WebPage\\"}},{\\"@type\\":\\"ListItem\\",\\"position\\":3,\\"name\\":\\"åç«¯\\",\\"item\\":{\\"@id\\":\\"https://friday-go.icu/dev/backend\\",\\"@type\\":\\"WebPage\\"}},{\\"@type\\":\\"ListItem\\",\\"position\\":4,\\"name\\":\\"PHP\\",\\"item\\":{\\"@id\\":\\"https://friday-go.icu/dev/backend/php\\",\\"@type\\":\\"WebPage\\"}},{\\"@type\\":\\"ListItem\\",\\"position\\":5,\\"name\\":\\"PHP 8.x é«˜é˜¶å®æˆ˜ï¼šæ¶æ„ã€æ€§èƒ½ä¸å·¥ç¨‹åŒ– | ç°ä»£PHPå¼€å‘æŒ‡å—\\",\\"item\\":{\\"@id\\":\\"https://friday-go.icu/dev/backend/php/ç°ä»£PHPå¼€å‘å®æˆ˜\\",\\"@type\\":\\"Article\\"}}]}"]]},"headers":[],"relativePath":"dev/backend/php/ç°ä»£PHPå¼€å‘å®æˆ˜.md","filePath":"dev/backend/php/ç°ä»£PHPå¼€å‘å®æˆ˜.md","lastUpdated":1766143110000}'),l={name:"dev/backend/php/ç°ä»£PHPå¼€å‘å®æˆ˜.md"};function p(t,s,k,e,r,E){return a(),n("div",{"data-pagefind-body":!0,"data-pagefind-meta":"date:1766071800000"},s[0]||(s[0]=[h(`<h1 id="ğŸš€-php-8-x-é«˜é˜¶å®æˆ˜-æ¶æ„ã€æ€§èƒ½ä¸å·¥ç¨‹åŒ–" tabindex="-1">ğŸš€ PHP 8.x é«˜é˜¶å®æˆ˜ï¼šæ¶æ„ã€æ€§èƒ½ä¸å·¥ç¨‹åŒ– <a class="header-anchor" href="#ğŸš€-php-8-x-é«˜é˜¶å®æˆ˜-æ¶æ„ã€æ€§èƒ½ä¸å·¥ç¨‹åŒ–" aria-label="Permalink to &quot;ğŸš€ PHP 8.x é«˜é˜¶å®æˆ˜ï¼šæ¶æ„ã€æ€§èƒ½ä¸å·¥ç¨‹åŒ–&quot;">â€‹</a></h1><blockquote><p><strong>é¢å‘ä¸­é«˜çº§PHPå¼€å‘è€…çš„ç°ä»£åŒ–å¼€å‘æŒ‡å—</strong></p></blockquote><h2 id="ğŸ“š-å¿«é€Ÿå¯¼èˆª" tabindex="-1">ğŸ“š å¿«é€Ÿå¯¼èˆª <a class="header-anchor" href="#ğŸ“š-å¿«é€Ÿå¯¼èˆª" aria-label="Permalink to &quot;ğŸ“š å¿«é€Ÿå¯¼èˆª&quot;">â€‹</a></h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><h3 id="ğŸ¯-æ ¸å¿ƒç‰¹æ€§" tabindex="-1">ğŸ¯ æ ¸å¿ƒç‰¹æ€§ <a class="header-anchor" href="#ğŸ¯-æ ¸å¿ƒç‰¹æ€§" aria-label="Permalink to &quot;ğŸ¯ æ ¸å¿ƒç‰¹æ€§&quot;">â€‹</a></h3><ul><li><a href="#11-attributes-æ³¨è§£-phpå…ƒç¼–ç¨‹çš„æ­£å¼å¼€ç«¯">Attributes (æ³¨è§£)</a> - PHPå…ƒç¼–ç¨‹çš„æ­£å¼å¼€ç«¯</li><li><a href="#12-enums-æšä¸¾-æ„å»ºç±»å‹å®‰å…¨çš„çŠ¶æ€æœº">Enums (æšä¸¾)</a> - æ„å»ºç±»å‹å®‰å…¨çš„çŠ¶æ€æœº</li><li><a href="#13-fibers-çº¤ç¨‹-phpåŸç”Ÿåç¨‹çš„åŸºçŸ³">Fibers (çº¤ç¨‹)</a> - PHPåŸç”Ÿåç¨‹çš„åŸºçŸ³</li></ul><h3 id="ğŸ—ï¸-æ¶æ„è®¾è®¡" tabindex="-1">ğŸ—ï¸ æ¶æ„è®¾è®¡ <a class="header-anchor" href="#ğŸ—ï¸-æ¶æ„è®¾è®¡" aria-label="Permalink to &quot;ğŸ—ï¸ æ¶æ„è®¾è®¡&quot;">â€‹</a></h3><ul><li><a href="#ç¬¬2ç« è¶…è¶Šmvcæ„å»ºå¯æ‰©å±•çš„æœåŠ¡åŒ–æ¶æ„">è¶…è¶ŠMVCæ¶æ„</a> - æ„å»ºå¯æ‰©å±•çš„æœåŠ¡åŒ–æ¶æ„</li><li><a href="#ç¬¬3ç« æ¡†æ¶é«˜çº§åº”ç”¨ä¸åŸç†-ä»¥laravelä¸ºä¾‹">Laravelé«˜çº§åº”ç”¨</a> - æ¡†æ¶åŸç†ä¸é«˜çº§ç‰¹æ€§</li><li><a href="#ç¬¬4ç« é«˜æ€§èƒ½apiè®¾è®¡ä¸å®ç°">é«˜æ€§èƒ½APIè®¾è®¡</a> - APIæ€§èƒ½ä¼˜åŒ–ç­–ç•¥</li></ul><h3 id="âš¡-æ€§èƒ½ä¼˜åŒ–" tabindex="-1">âš¡ æ€§èƒ½ä¼˜åŒ– <a class="header-anchor" href="#âš¡-æ€§èƒ½ä¼˜åŒ–" aria-label="Permalink to &quot;âš¡ æ€§èƒ½ä¼˜åŒ–&quot;">â€‹</a></h3><ul><li><a href="#ç¬¬5ç« å¹¶å‘ä¸å¼‚æ­¥phpé‡Šæ”¾æè‡´æ€§èƒ½">å¹¶å‘ä¸å¼‚æ­¥ç¼–ç¨‹</a> - é‡Šæ”¾æè‡´æ€§èƒ½</li><li><a href="#ç¬¬6ç« åšä¸å¯æ‘§çš„ä»£ç è´¨é‡">ä»£ç è´¨é‡ä¿éšœ</a> - åšä¸å¯æ‘§çš„ä»£ç è´¨é‡</li><li><a href="#ç¬¬7ç« ç°ä»£devopsæµç¨‹">DevOpsæµç¨‹</a> - ç°ä»£DevOpså®è·µ</li></ul><h3 id="ğŸ”-å¯è§‚æµ‹æ€§" tabindex="-1">ğŸ” å¯è§‚æµ‹æ€§ <a class="header-anchor" href="#ğŸ”-å¯è§‚æµ‹æ€§" aria-label="Permalink to &quot;ğŸ” å¯è§‚æµ‹æ€§&quot;">â€‹</a></h3><ul><li><a href="#ç¬¬8ç« ç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§-observability">ç”Ÿäº§ç¯å¢ƒç›‘æ§</a> - ç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§</li></ul></div><hr><h2 id="ğŸ“–-è¯¦ç»†ç›®å½•" tabindex="-1">ğŸ“– è¯¦ç»†ç›®å½• <a class="header-anchor" href="#ğŸ“–-è¯¦ç»†ç›®å½•" aria-label="Permalink to &quot;ğŸ“– è¯¦ç»†ç›®å½•&quot;">â€‹</a></h2><h3 id="ç¬¬ä¸€éƒ¨åˆ†-è¯­è¨€æ ¸å¿ƒä¸é«˜çº§ç‰¹æ€§-the-php-8-x-core" tabindex="-1">ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯­è¨€æ ¸å¿ƒä¸é«˜çº§ç‰¹æ€§ (The PHP 8.x Core) <a class="header-anchor" href="#ç¬¬ä¸€éƒ¨åˆ†-è¯­è¨€æ ¸å¿ƒä¸é«˜çº§ç‰¹æ€§-the-php-8-x-core" aria-label="Permalink to &quot;ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯­è¨€æ ¸å¿ƒä¸é«˜çº§ç‰¹æ€§ (The PHP 8.x Core)&quot;">â€‹</a></h3><ul><li><a href="#ç¬¬1ç« php-8x-æ–°ç‰¹æ€§æ·±åº¦è§£æä¸åº”ç”¨">ç¬¬1ç« ï¼šPHP 8.x æ–°ç‰¹æ€§æ·±åº¦è§£æä¸åº”ç”¨</a><ul><li><a href="#11-attributes-æ³¨è§£-phpå…ƒç¼–ç¨‹çš„æ­£å¼å¼€ç«¯">1.1 Attributes (æ³¨è§£): PHPå…ƒç¼–ç¨‹çš„æ­£å¼å¼€ç«¯</a></li><li><a href="#12-enums-æšä¸¾-æ„å»ºç±»å‹å®‰å…¨çš„çŠ¶æ€æœº">1.2 Enums (æšä¸¾): æ„å»ºç±»å‹å®‰å…¨çš„çŠ¶æ€æœº</a></li><li><a href="#13-fibers-çº¤ç¨‹-phpåŸç”Ÿåç¨‹çš„åŸºçŸ³">1.3 Fibers (çº¤ç¨‹): PHPåŸç”Ÿåç¨‹çš„åŸºçŸ³</a></li></ul></li></ul><h3 id="ç¬¬äºŒéƒ¨åˆ†-ç°ä»£æ¶æ„ä¸è®¾è®¡-advanced-architecture-design" tabindex="-1">ç¬¬äºŒéƒ¨åˆ†ï¼šç°ä»£æ¶æ„ä¸è®¾è®¡ (Advanced Architecture &amp; Design) <a class="header-anchor" href="#ç¬¬äºŒéƒ¨åˆ†-ç°ä»£æ¶æ„ä¸è®¾è®¡-advanced-architecture-design" aria-label="Permalink to &quot;ç¬¬äºŒéƒ¨åˆ†ï¼šç°ä»£æ¶æ„ä¸è®¾è®¡ (Advanced Architecture &amp; Design)&quot;">â€‹</a></h3><ul><li><a href="#ç¬¬2ç« è¶…è¶Šmvcæ„å»ºå¯æ‰©å±•çš„æœåŠ¡åŒ–æ¶æ„">ç¬¬2ç« ï¼šè¶…è¶ŠMVCï¼šæ„å»ºå¯æ‰©å±•çš„æœåŠ¡åŒ–æ¶æ„</a></li></ul><h3 id="ç¬¬ä¸‰éƒ¨åˆ†-ä¸“é¢˜æ·±æ½œ-topical-deep-dives" tabindex="-1">ç¬¬ä¸‰éƒ¨åˆ†ï¼šä¸“é¢˜æ·±æ½œ (Topical Deep Dives) <a class="header-anchor" href="#ç¬¬ä¸‰éƒ¨åˆ†-ä¸“é¢˜æ·±æ½œ-topical-deep-dives" aria-label="Permalink to &quot;ç¬¬ä¸‰éƒ¨åˆ†ï¼šä¸“é¢˜æ·±æ½œ (Topical Deep Dives)&quot;">â€‹</a></h3><ul><li><a href="#ç¬¬3ç« æ¡†æ¶é«˜çº§åº”ç”¨ä¸åŸç†-ä»¥laravelä¸ºä¾‹">ç¬¬3ç« ï¼šæ¡†æ¶é«˜çº§åº”ç”¨ä¸åŸç† (ä»¥Laravelä¸ºä¾‹)</a></li><li><a href="#ç¬¬4ç« é«˜æ€§èƒ½apiè®¾è®¡ä¸å®ç°">ç¬¬4ç« ï¼šé«˜æ€§èƒ½APIè®¾è®¡ä¸å®ç°</a></li></ul><h3 id="ç¬¬å››éƒ¨åˆ†-å¹¶å‘ä¸å¼‚æ­¥php-é‡Šæ”¾æè‡´æ€§èƒ½" tabindex="-1">ç¬¬å››éƒ¨åˆ†ï¼šå¹¶å‘ä¸å¼‚æ­¥PHPï¼šé‡Šæ”¾æè‡´æ€§èƒ½ <a class="header-anchor" href="#ç¬¬å››éƒ¨åˆ†-å¹¶å‘ä¸å¼‚æ­¥php-é‡Šæ”¾æè‡´æ€§èƒ½" aria-label="Permalink to &quot;ç¬¬å››éƒ¨åˆ†ï¼šå¹¶å‘ä¸å¼‚æ­¥PHPï¼šé‡Šæ”¾æè‡´æ€§èƒ½&quot;">â€‹</a></h3><ul><li><a href="#ç¬¬5ç« å¹¶å‘ä¸å¼‚æ­¥phpé‡Šæ”¾æè‡´æ€§èƒ½">ç¬¬5ç« ï¼šå¹¶å‘ä¸å¼‚æ­¥PHPï¼šé‡Šæ”¾æè‡´æ€§èƒ½</a></li></ul><h3 id="ç¬¬äº”éƒ¨åˆ†-åšä¸å¯æ‘§çš„ä»£ç è´¨é‡" tabindex="-1">ç¬¬äº”éƒ¨åˆ†ï¼šåšä¸å¯æ‘§çš„ä»£ç è´¨é‡ <a class="header-anchor" href="#ç¬¬äº”éƒ¨åˆ†-åšä¸å¯æ‘§çš„ä»£ç è´¨é‡" aria-label="Permalink to &quot;ç¬¬äº”éƒ¨åˆ†ï¼šåšä¸å¯æ‘§çš„ä»£ç è´¨é‡&quot;">â€‹</a></h3><ul><li><a href="#ç¬¬6ç« åšä¸å¯æ‘§çš„ä»£ç è´¨é‡">ç¬¬6ç« ï¼šåšä¸å¯æ‘§çš„ä»£ç è´¨é‡</a></li></ul><h3 id="ç¬¬å…­éƒ¨åˆ†-å·¥ç¨‹åŒ–ä¸å¯è§‚æµ‹æ€§-engineering-observability" tabindex="-1">ç¬¬å…­éƒ¨åˆ†ï¼šå·¥ç¨‹åŒ–ä¸å¯è§‚æµ‹æ€§ (Engineering &amp; Observability) <a class="header-anchor" href="#ç¬¬å…­éƒ¨åˆ†-å·¥ç¨‹åŒ–ä¸å¯è§‚æµ‹æ€§-engineering-observability" aria-label="Permalink to &quot;ç¬¬å…­éƒ¨åˆ†ï¼šå·¥ç¨‹åŒ–ä¸å¯è§‚æµ‹æ€§ (Engineering &amp; Observability)&quot;">â€‹</a></h3><ul><li><a href="#ç¬¬7ç« ç°ä»£devopsæµç¨‹">ç¬¬7ç« ï¼šç°ä»£DevOpsæµç¨‹</a></li><li><a href="#ç¬¬8ç« ç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§-observability">ç¬¬8ç« ï¼šç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§ (Observability)</a></li></ul><h3 id="é™„å½•" tabindex="-1">é™„å½• <a class="header-anchor" href="#é™„å½•" aria-label="Permalink to &quot;é™„å½•&quot;">â€‹</a></h3><ul><li><a href="#é™„å½•">é™„å½•</a></li></ul><hr><h2 id="ğŸ¯-å¯¼è¨€-php-8-x-æ–°èŒƒå¼ä¸æ–°æœºé‡" tabindex="-1">ğŸ¯ å¯¼è¨€ï¼šPHP 8.x - æ–°èŒƒå¼ä¸æ–°æœºé‡ <a class="header-anchor" href="#ğŸ¯-å¯¼è¨€-php-8-x-æ–°èŒƒå¼ä¸æ–°æœºé‡" aria-label="Permalink to &quot;ğŸ¯ å¯¼è¨€ï¼šPHP 8.x - æ–°èŒƒå¼ä¸æ–°æœºé‡&quot;">â€‹</a></h2><p>æ¬¢è¿æ¥åˆ°PHP 8.xçš„æ—¶ä»£ã€‚</p><p>å¦‚æœä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„PHPå¼€å‘è€…ï¼Œä½ ä¸€å®šè§è¯äº†è¿™é—¨è¯­è¨€çš„å·¨å¤§å˜è¿ã€‚ä»PHP 5çš„â€œä¸€æŠŠæ¢­â€è„šæœ¬å°å­ï¼Œåˆ°PHP 7å¸¦æ¥çš„æ€§èƒ½é©å‘½ï¼Œå†åˆ°ä»Šå¤©ï¼ŒPHP 8.xæ­£åœ¨å¼•é¢†æˆ‘ä»¬è¿›å…¥ä¸€ä¸ªå…¨æ–°çš„ç¼–ç¨‹èŒƒå¼ã€‚å®ƒä¸å†ä»…ä»…æ˜¯Webä¸–ç•Œé‡Œé‚£ä¸ªâ€œæœ€å¥½çš„è¯­è¨€â€ï¼Œå®ƒæ­£åœ¨æˆä¸ºä¸€é—¨ç‰¹æ€§ä¸°å¯Œã€ç±»å‹ä¸¥è°¨ã€æ€§èƒ½å“è¶Šçš„ç°ä»£åŒ–é€šç”¨åç«¯è¯­è¨€ã€‚</p><p>JITç¼–è¯‘å™¨çš„å¼•å…¥ï¼Œè®©PHPé¦–æ¬¡æ‹¥æœ‰äº†ä¸é™æ€è¯­è¨€åœ¨æŸäº›åœºæ™¯ä¸‹æ°æ‰‹è…•çš„æ½œåŠ›ï¼›Fibersï¼ˆçº¤ç¨‹ï¼‰çš„è½åœ°ï¼Œä¸ºPHPæ‰“å¼€äº†åŸç”Ÿåç¨‹çš„å¤§é—¨ï¼Œè®©é«˜å¹¶å‘ã€å¼‚æ­¥ç¼–ç¨‹ä¸å†æ˜¯Swooleç­‰æ‰©å±•çš„ä¸“åˆ©ï¼›è€ŒAttributesï¼ˆæ³¨è§£ï¼‰ã€Enumsï¼ˆæšä¸¾ï¼‰ã€æ›´å¼ºå¤§çš„ç±»å‹ç³»ç»Ÿï¼Œåˆ™å°†PHPçš„å·¥ç¨‹åŒ–èƒ½åŠ›å’Œä»£ç å¥å£®æ€§æ¨å‘äº†å‰æ‰€æœªæœ‰çš„é«˜åº¦ã€‚</p><p>è¿™æœ¬å°å†Œå­ä¸æ˜¯ä¸ºåˆå­¦è€…å‡†å¤‡çš„ã€‚å®ƒå‡è®¾ä½ å·²ç»ç†Ÿæ‚‰PHPçš„è¯­æ³•ã€äº†è§£MVCæ¡†æ¶ï¼Œå¹¶æ‹¥æœ‰å®é™…çš„é¡¹ç›®ç»éªŒã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼š</p><ol><li><strong>æ·±åº¦æŒ–æ˜PHP 8.xçš„æ ¸å¿ƒç‰¹æ€§</strong>ï¼Œå¹¶æ¢è®¨å®ƒä»¬åœ¨çœŸå®é¡¹ç›®ä¸­çš„æœ€ä½³å®è·µã€‚</li><li><strong>è¶…è¶ŠåŸºç¡€çš„æ¡†æ¶ä½¿ç”¨</strong>ï¼Œæ¢è®¨å¦‚ä½•æ„å»ºå¯æ‰©å±•ã€å¯ç»´æŠ¤çš„ç°ä»£åŒ–æœåŠ¡æ¶æ„ã€‚</li><li><strong>èšç„¦æ€§èƒ½ä¸å¹¶å‘</strong>ï¼Œå­¦ä¹ å¦‚ä½•åˆ©ç”¨å¼‚æ­¥PHPå’Œå„ç§å·¥å…·å°†ä½ çš„åº”ç”¨æ€§èƒ½æ¨å‘æè‡´ã€‚</li><li><strong>æ‹¥æŠ±DevOpsä¸å·¥ç¨‹åŒ–</strong>ï¼ŒæŒæ¡ä»ä»£ç è´¨é‡æ§åˆ¶åˆ°ç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§çš„å…¨æµç¨‹æŠ€èƒ½ã€‚</li></ol><p>åœ¨è¿™ä¸ªæ—¶ä»£ï¼Œä¸€åä¼˜ç§€çš„PHPå·¥ç¨‹å¸ˆä¸å†æ˜¯â€œCURD Boyâ€ï¼Œè€Œåº”æ˜¯ä¸€åå…·å¤‡æ¶æ„æ€ç»´ã€æ€§èƒ½è§†é‡å’Œå·¥ç¨‹åŒ–ç´ å…»çš„<strong>Tå‹äººæ‰</strong>ï¼šä»¥PHPä¸ºæ·±åº¦æ ¹åŸºï¼ŒåŒæ—¶å¹¿æ³›æ¶‰çŒæ¶æ„è®¾è®¡ã€DevOpsã€å‰ç«¯æ„å»ºã€æ•°æ®åº“ä¼˜åŒ–ç­‰é¢†åŸŸã€‚</p><p>å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢PHP 8.xå¸¦æ¥çš„æ–°èŒƒå¼ä¸æ–°æœºé‡ã€‚</p><hr><h2 id="ğŸ¯-ç¬¬ä¸€éƒ¨åˆ†-è¯­è¨€æ ¸å¿ƒä¸é«˜çº§ç‰¹æ€§-the-php-8-x-core" tabindex="-1">ğŸ¯ ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯­è¨€æ ¸å¿ƒä¸é«˜çº§ç‰¹æ€§ (The PHP 8.x Core) <a class="header-anchor" href="#ğŸ¯-ç¬¬ä¸€éƒ¨åˆ†-è¯­è¨€æ ¸å¿ƒä¸é«˜çº§ç‰¹æ€§-the-php-8-x-core" aria-label="Permalink to &quot;ğŸ¯ ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯­è¨€æ ¸å¿ƒä¸é«˜çº§ç‰¹æ€§ (The PHP 8.x Core)&quot;">â€‹</a></h2><h3 id="ğŸ“–-ç¬¬1ç« -php-8-x-æ–°ç‰¹æ€§æ·±åº¦è§£æä¸åº”ç”¨" tabindex="-1">ğŸ“– ç¬¬1ç« ï¼šPHP 8.x æ–°ç‰¹æ€§æ·±åº¦è§£æä¸åº”ç”¨ <a class="header-anchor" href="#ğŸ“–-ç¬¬1ç« -php-8-x-æ–°ç‰¹æ€§æ·±åº¦è§£æä¸åº”ç”¨" aria-label="Permalink to &quot;ğŸ“– ç¬¬1ç« ï¼šPHP 8.x æ–°ç‰¹æ€§æ·±åº¦è§£æä¸åº”ç”¨&quot;">â€‹</a></h3><h5 id="_1-1-attributes-æ³¨è§£-phpå…ƒç¼–ç¨‹çš„æ­£å¼å¼€ç«¯" tabindex="-1">1.1 Attributes (æ³¨è§£): PHPå…ƒç¼–ç¨‹çš„æ­£å¼å¼€ç«¯ <a class="header-anchor" href="#_1-1-attributes-æ³¨è§£-phpå…ƒç¼–ç¨‹çš„æ­£å¼å¼€ç«¯" aria-label="Permalink to &quot;1.1 Attributes (æ³¨è§£): PHPå…ƒç¼–ç¨‹çš„æ­£å¼å¼€ç«¯&quot;">â€‹</a></h5><div class="tip custom-block"><p class="custom-block-title">ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</p><p>Attributesï¼ˆæ³¨è§£ï¼‰æ˜¯PHP 8å¼•å…¥çš„å…ƒç¼–ç¨‹ç‰¹æ€§ï¼Œå…è®¸ä½ å°†ç»“æ„åŒ–çš„ã€ç±»å‹å®‰å…¨çš„å…ƒæ•°æ®ç›´æ¥é™„åŠ åˆ°ä»£ç å£°æ˜ä¸Šã€‚</p></div><p>åœ¨PHP 8ä¹‹å‰ï¼Œæˆ‘ä»¬é•¿æœŸä¾èµ–PHPDocï¼ˆ<code>/** ... */</code>ï¼‰æ¥ä¸ºä»£ç æ·»åŠ &quot;å…ƒæ•°æ®&quot;ã€‚æ— è®ºæ˜¯Symfonyçš„è·¯ç”±/ORMå®šä¹‰ï¼Œè¿˜æ˜¯Swaggerçš„APIæ–‡æ¡£ç”Ÿæˆï¼Œéƒ½ç¦»ä¸å¼€å¯¹æ³¨é‡Šå—çš„è§£æã€‚è¿™ç§æ–¹å¼ä¸ä»…æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”ç¼ºä¹è¯­è¨€å±‚é¢çš„åŸç”Ÿæ”¯æŒï¼Œå®¹æ˜“å‡ºé”™ã€‚</p><p>PHP 8çš„ <strong>Attributes</strong>ï¼ˆé€šå¸¸ç§°ä¸ºæ³¨è§£ï¼‰å½»åº•æ”¹å˜äº†è¿™ä¸€ç°çŠ¶ã€‚å®ƒå…è®¸ä½ å°†ç»“æ„åŒ–çš„ã€ç±»å‹å®‰å…¨çš„å…ƒæ•°æ®ç›´æ¥é™„åŠ åˆ°ç±»ã€æ–¹æ³•ã€å±æ€§ã€å‚æ•°ç­‰ä»£ç å£°æ˜ä¸Šã€‚è¿™ä¸ä»…ä»…æ˜¯è¯­æ³•ç³–ï¼Œè€Œæ˜¯PHPå…ƒç¼–ç¨‹èƒ½åŠ›çš„æ­£å¼å¼€ç«¯ã€‚</p><p><strong>1. å®šä¹‰ä¸€ä¸ªAttribute</strong></p><p>Attributeæœ¬èº«å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„PHPç±»ï¼Œåªæ˜¯å®ƒè‡ªå·±è¢«ä¸€ä¸ª<code>#[Attribute]</code>æ‰€æ³¨è§£ã€‚</p><p><code>#[Attribute]</code>æ³¨è§£æœ¬èº«å¯ä»¥æ¥å—ä¸€äº›æ ‡å¿—ä½ï¼Œç”¨äºé™å®šä½ çš„è‡ªå®šä¹‰Attributeèƒ½ç”¨åœ¨ä»€ä¹ˆåœ°æ–¹ï¼š</p><ul><li><code>Attribute::TARGET_CLASS</code></li><li><code>Attribute::TARGET_FUNCTION</code></li><li><code>Attribute::TARGET_METHOD</code></li><li><code>Attribute::TARGET_PROPERTY</code></li><li><code>Attribute::TARGET_CLASS_CONSTANT</code></li><li><code>Attribute::TARGET_PARAMETER</code></li><li><code>Attribute::TARGET_ALL</code> (é»˜è®¤å€¼)</li></ul><p><strong>å®æˆ˜ç¤ºä¾‹ï¼šåˆ›å»ºä¸€ä¸ªç®€å•çš„è·¯ç”±Attribute</strong></p><p>è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª<code>#[Route]</code>æ³¨è§£ï¼Œç”¨äºæ ‡è®°æ§åˆ¶å™¨æ–¹æ³•å¯¹åº”çš„URLè·¯å¾„å’Œè¯·æ±‚æ–¹æ³•ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Attribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Attribute</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_METHOD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Route</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $path,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;GET&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ) {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>æˆ‘ä»¬é™å®šäº†<code>#[Route]</code>åªèƒ½ç”¨äºæ–¹æ³•ä¸Š (<code>Attribute::TARGET_METHOD</code>)ã€‚</li><li>æ„é€ å‡½æ•°ä½¿ç”¨äº†PHP 8çš„â€œæ„é€ å‡½æ•°å±æ€§æå‡â€è¯­æ³•ï¼Œä»£ç éå¸¸ç®€æ´ã€‚</li></ul><p><strong>2. ä½¿ç”¨Attribute</strong></p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨è¿™ä¸ª<code>#[Route]</code>äº†ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserController</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Route</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/users/{id}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">method</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;GET&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> find</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ... find user logic</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Finding user with ID: {</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Route</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/users&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">method</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;POST&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $data)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ... create user logic</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;User created.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>çœ‹åˆ°äº†å—ï¼Ÿè·¯ç”±å®šä¹‰ä¸å†æ˜¯é…ç½®æ–‡ä»¶é‡Œçš„ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿä¸æ˜¯ä¸€æ®µæ³¨é‡Šï¼Œè€Œæ˜¯ä¸ä¸šåŠ¡é€»è¾‘ç´§å¯†ç»“åˆã€å¯è¢«é™æ€åˆ†æçš„<strong>ä»£ç </strong>ã€‚</p><p><strong>3. è¯»å–Attributeï¼ˆæ ¸å¿ƒï¼‰</strong></p><p>å®šä¹‰å’Œä½¿ç”¨åªæ˜¯ç¬¬ä¸€æ­¥ï¼ŒçœŸæ­£è®©Attributeå‘æŒ¥å¨åŠ›çš„æ˜¯é€šè¿‡<strong>åå°„ (Reflection)</strong> æ¥è¯»å–å®ƒä»¬ã€‚</p><p>è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„è·¯ç”±å™¨ï¼Œå®ƒèƒ½é€šè¿‡åå°„åˆ†æ<code>UserController</code>ï¼Œå¹¶æ ¹æ®è¯·æ±‚çš„URLæ‰§è¡Œå¯¹åº”çš„æ–¹æ³•ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å‡è®¾è¿™æ˜¯ä½ çš„å…¥å£æ–‡ä»¶ index.php</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$requestUri </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $_SERVER[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;REQUEST_URI&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$requestMethod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $_SERVER[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;REQUEST_METHOD&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$controller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserController</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$reflectionClass </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ReflectionClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($controller);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">foreach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($reflectionClass</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $method) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $attributes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getAttributes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Route</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    foreach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($attributes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $attribute) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /** </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@var</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Route</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> $route */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $route </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $attribute</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ç®€å•çš„è·¯å¾„åŒ¹é… (å®é™…åº”ç”¨ä¸­ä¼šæ›´å¤æ‚)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å°† /users/{id} è½¬æ¢ä¸ºæ­£åˆ™ /users/(\\w+)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $pattern </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> preg_replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\\{</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">(</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\\w</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">)</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\\}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;(\\w+)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, $route</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">path);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">preg_match</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;#^</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$pattern</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$#&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, $requestUri, $matches) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $route</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $requestMethod) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ç§»é™¤å®Œæ•´åŒ¹é…é¡¹</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            array_shift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($matches); </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // æ‰§è¡Œæ§åˆ¶å™¨æ–¹æ³•å¹¶ä¼ å…¥å‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            echo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">invoke</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($controller, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$matches);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;404 Not Found&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p><strong>ä»£ç è§£è¯»</strong>:</p><ol><li>æˆ‘ä»¬é€šè¿‡<code>ReflectionClass</code>è·å–<code>UserController</code>çš„æ‰€æœ‰æ–¹æ³•ã€‚</li><li>ä½¿ç”¨<code>$method-&gt;getAttributes(Route::class)</code>æ¥è·å–æ¯ä¸ªæ–¹æ³•ä¸Šé™„åŠ çš„<code>#[Route]</code>æ³¨è§£å®ä¾‹ã€‚</li><li><code>$attribute-&gt;newInstance()</code>ä¼šåˆ›å»º<code>Route</code>ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œå…¶æ„é€ å‡½æ•°å‚æ•°å°±æ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶ä¼ å…¥çš„<code>(&#39;/users/{id}&#39;, &#39;GET&#39;)</code>ã€‚</li><li>ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»<code>$route</code>å®ä¾‹ä¸­è·å–<code>path</code>å’Œ<code>method</code>å±æ€§ï¼Œè¿›è¡Œè·¯ç”±åŒ¹é…å’Œåˆ†å‘ã€‚</li></ol><p><strong>4. æ›´å¤šå®æˆ˜åœºæ™¯</strong></p><p>Attributesçš„å¨åŠ›è¿œä¸æ­¢äºè·¯ç”±ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œå®ƒä»¬æ˜¯æ„å»ºæ¸…æ™°ã€è§£è€¦ã€å£°æ˜å¼ä»£ç çš„åˆ©å™¨ã€‚</p><p><strong>åœºæ™¯ä¸€ï¼šè®¿é—®æ§åˆ¶ (Access Control)</strong></p><p>æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª<code>#[Auth]</code>æ³¨è§£æ¥ä¿æŠ¤éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„è·¯ç”±ã€‚</p><ul><li><strong>å®šä¹‰Attribute:</strong></li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/Attribute/Auth.php</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Attribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Attribute</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_METHOD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Auth</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> array</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> $roles éœ€è¦çš„è§’è‰²ï¼Œä¸ºç©ºåˆ™åªéœ€ç™»å½•</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $roles </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>ä½¿ç”¨Attribute:</strong></li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/Controller/UserController.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserController</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Route</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/profile&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">method</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;GET&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åªéœ€ç™»å½•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> profile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Route</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/admin/dashboard&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">method</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;GET&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">roles</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ADMIN&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;SUPER_ADMIN&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// éœ€è¦ç‰¹å®šè§’è‰²</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> dashboard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>åœ¨è·¯ç”±å™¨ä¸­é›†æˆæ£€æŸ¥:</strong></li></ul><p>æˆ‘ä»¬å¯ä»¥åœ¨ä¹‹å‰çš„è·¯ç”±åˆ†å‘é€»è¾‘ä¸­ï¼Œå¢åŠ å¯¹<code>#[Auth]</code>æ³¨è§£çš„æ£€æŸ¥ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// index.php (è·¯ç”±åˆ†å‘éƒ¨åˆ†)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$methods </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $reflectionClass</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">foreach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($methods </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $method) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $routeAttributes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getAttributes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Route</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($routeAttributes)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ£€æŸ¥Authæ³¨è§£</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $authAttributes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getAttributes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Auth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($authAttributes)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ä¼ªä»£ç ï¼šå®ç°ä½ çš„è®¤è¯é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $isLoggedIn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Auth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$isLoggedIn) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;HTTP/1.1 401 Unauthorized&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Unauthorized&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /** </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@var</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Auth</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> $auth */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $auth </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $authAttributes[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($auth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">roles) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Auth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hasAnyRole</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($auth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">roles)) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;HTTP/1.1 403 Forbidden&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Forbidden&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... åç»­è·¯ç”±åŒ¹é…å’Œæ‰§è¡Œé€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>åœºæ™¯äºŒï¼šè¯·æ±‚æ•°æ®è½¬æ¢ä¸éªŒè¯ (DTO Validation)</strong></p><p>æˆ‘ä»¬å¯ä»¥ç”¨Attributeæ¥æ ‡è®°DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰çš„å±æ€§ï¼Œä»è€Œå®ç°è‡ªåŠ¨åŒ–çš„éªŒè¯å’Œç±»å‹è½¬æ¢ã€‚</p><ul><li><strong>å®šä¹‰Attribute:</strong></li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/Attribute/Validation/Rule.php</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Attribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Attribute</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_PROPERTY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Rule</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $rule) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// e.g., &#39;required|email&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>åˆ›å»ºDTOå¹¶ä½¿ç”¨Attribute:</strong></li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/DTO/CreateUserDTO.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CreateUserDTO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Rule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;required|string|max:255&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $name;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Rule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;required|email&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $email;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Rule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;required|int|min:18&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $age;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>åˆ›å»ºä¸€ä¸ªValidatoræœåŠ¡:</strong></li></ul><p>è¿™ä¸ªæœåŠ¡é€šè¿‡åå°„è¯»å–DTOå®ä¾‹çš„å±æ€§æ³¨è§£ï¼Œå¹¶æ‰§è¡ŒéªŒè¯ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/Service/Validator.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Validator</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> validate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $dto)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> array</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $errors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $reflection </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ReflectionClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($dto);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        foreach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($reflection</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $property) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            $attributes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $property</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getAttributes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Rule</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($attributes)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            /** </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@var</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Rule</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> $rule */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            $rule </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $attributes[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            $value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $property</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isInitialized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($dto) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $property</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($dto) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ä¼ªä»£ç ï¼šæ­¤å¤„é›†æˆçœŸå®çš„éªŒè¯åº“ï¼Œå¦‚ illuminate/validation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            $validationErrors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runValidationLibrary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($property</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), $value, $rule</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rule);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($validationErrors)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                $errors[$property</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $validationErrors;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $errors;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ç°åœ¨ï¼Œåœ¨ä½ çš„æ§åˆ¶å™¨ä¸­ï¼Œä½ å¯ä»¥å°†è¯·æ±‚æ•°æ®å¡«å……åˆ°DTOï¼Œç„¶åç”¨Validatorè¿›è¡ŒéªŒè¯ï¼Œä»£ç å˜å¾—æå…¶å¹²å‡€ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// UserController.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $request, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Validator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $validator)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $dto </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> CreateUserDTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $dto</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $dto</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">email </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;email&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $dto</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)$request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;age&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $errors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $validator</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">validate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($dto);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($errors)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($errors, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">422</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... DTOéªŒè¯é€šè¿‡ï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>æ€»ç»“</strong></p><p>Attributeså°†å…ƒæ•°æ®ä»â€œæ˜“ç¢çš„â€æ³¨é‡Šå’Œâ€œé¥è¿œçš„â€é…ç½®æ–‡ä»¶ä¸­è§£æ”¾å‡ºæ¥ï¼Œä½¿å…¶æˆä¸ºä¸ä¸šåŠ¡ä»£ç å¹¶å­˜ã€ç±»å‹å®‰å…¨ã€å¯è¢«é™æ€åˆ†æçš„ä¸€ç­‰å…¬æ°‘ã€‚å®ƒæ˜¯æ„å»ºç°ä»£ã€å¯ç»´æŠ¤ã€é«˜è¡¨ç°åŠ›PHPåº”ç”¨å’Œæ¡†æ¶çš„åŸºçŸ³ã€‚</p><hr><h5 id="_1-2-enums-æšä¸¾-æ„å»ºç±»å‹å®‰å…¨çš„çŠ¶æ€æœº" tabindex="-1">1.2 Enums (æšä¸¾): æ„å»ºç±»å‹å®‰å…¨çš„çŠ¶æ€æœº <a class="header-anchor" href="#_1-2-enums-æšä¸¾-æ„å»ºç±»å‹å®‰å…¨çš„çŠ¶æ€æœº" aria-label="Permalink to &quot;1.2 Enums (æšä¸¾): æ„å»ºç±»å‹å®‰å…¨çš„çŠ¶æ€æœº&quot;">â€‹</a></h5><p>åœ¨PHP 8.1ä¹‹å‰ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ç±»å¸¸é‡æ¥è¡¨ç¤ºä¸€ç»„å›ºå®šçš„ç›¸å…³çŠ¶æ€ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Post</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> STATUS_DRAFT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;draft&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> STATUS_PUBLISHED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;published&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> STATUS_ARCHIVED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;archived&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $status;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>è¿™ç§æ–¹å¼æœ‰å‡ ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ï¼š</p><ol><li><strong>ç±»å‹ä¸å®‰å…¨</strong>: <code>setStatus</code>æ–¹æ³•çš„å‚æ•°åº”è¯¥æ˜¯<code>string</code>ï¼Œä½†ä»»ä½•å­—ç¬¦ä¸²éƒ½å¯ä»¥è¢«ä¼ å…¥ï¼Œè€Œä¸ä»…ä»…æ˜¯æˆ‘ä»¬å®šä¹‰çš„é‚£ä¸‰ä¸ªå¸¸é‡ã€‚</li><li><strong>é€»è¾‘åˆ†æ•£</strong>: å¦‚æœæƒ³è·å–æŸä¸ªçŠ¶æ€å¯¹åº”çš„ä¸­æ–‡æ ‡ç­¾ï¼ˆå¦‚ &#39;draft&#39; -&gt; &#39;è‰ç¨¿&#39;ï¼‰ï¼Œä½ å¯èƒ½éœ€è¦å†™ä¸€ä¸ªåºå¤§çš„<code>switch</code>æˆ–ä¸€ä¸ªå…³è”æ•°ç»„ï¼Œè¿™äº›é€»è¾‘ä¸çŠ¶æ€å®šä¹‰æœ¬èº«æ˜¯åˆ†ç¦»çš„ã€‚</li><li><strong>å¯è¯»æ€§å·®</strong>: å½“ä½ çœ‹åˆ°ä¸€ä¸ªå‡½æ•°è¿”å›<code>&#39;draft&#39;</code>æ—¶ï¼Œä½ æ— æ³•ç¡®å®šå®ƒå°±æ˜¯<code>Post::STATUS_DRAFT</code>ï¼Œå¯èƒ½åªæ˜¯ä¸€ä¸ªæ°å¥½åŒå€¼çš„æ™®é€šå­—ç¬¦ä¸²ã€‚</li></ol><p>PHP 8.1çš„**Enumsï¼ˆæšä¸¾ï¼‰**å®Œç¾åœ°è§£å†³äº†è¿™äº›é—®é¢˜ã€‚</p><p><strong>1. Backed Enums (æ ‡é‡æšä¸¾)</strong></p><p>å½“æšä¸¾éœ€è¦ä¸æ•°æ®åº“æˆ–APIç­‰å¤–éƒ¨ç³»ç»Ÿäº¤äº’æ—¶ï¼Œå®ƒä»¬é€šå¸¸éœ€è¦ä¸€ä¸ªæ ‡é‡å€¼ï¼ˆ<code>string</code>æˆ–<code>int</code>ï¼‰ã€‚è¿™å°±æ˜¯<code>Backed Enums</code>ã€‚</p><p>è®©æˆ‘ä»¬ç”¨æšä¸¾é‡æ„ä¸Šé¢çš„ä¾‹å­ï¼š</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">enum</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PostStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Draft</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;draft&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Published</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;published&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Archived</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;archived&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º<code>Post</code>ç±»çš„<code>status</code>å±æ€§æ·»åŠ ä¸¥æ ¼çš„ç±»å‹çº¦æŸã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Post</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $status;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PostStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $status)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $status;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$post </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// $post-&gt;setStatus(&#39;draft&#39;);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // TypeError! å¿…é¡»ä¼ å…¥PostStatuså®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PostStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Draft</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ­£ç¡®</span></span></code></pre></div><p>ä»…ä»…æ˜¯è¿™æ ·ï¼Œå°±å·²ç»é€šè¿‡è¯­è¨€æœ¬èº«é˜²æ­¢äº†ä¸€æ•´ç±»æ— æ•ˆçŠ¶æ€çš„bugã€‚</p><p><strong>2. ä¸ºæšä¸¾æ·»åŠ è¡Œä¸º (Methods)</strong></p><p>æšä¸¾çœŸæ­£çš„å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒå¯ä»¥æ‹¥æœ‰æ–¹æ³•ï¼Œå°†ä¸çŠ¶æ€ç›¸å…³çš„é€»è¾‘å†…èšåœ¨ä¸€èµ·ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">enum</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PostStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Draft</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;draft&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Published</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;published&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Archived</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;archived&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> label</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> match</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            self::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Draft</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;è‰ç¨¿&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            self::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Published</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;å·²å‘å¸ƒ&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            self::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Archived</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;å·²å½’æ¡£&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> match</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            self::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Draft</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;grey&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            self::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Published</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;green&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            self::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Archived</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;red&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ç°åœ¨ï¼Œåœ¨è§†å›¾ï¼ˆå¦‚Bladeæ¨¡æ¿ï¼‰ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸ä¼˜é›…åœ°æ¸²æŸ“çŠ¶æ€æ ‡ç­¾ï¼š</p><div class="language-html vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- post.blade.php --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> style</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;color: {{ $post-&gt;status-&gt;color() }};&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {{ $post-&gt;status-&gt;label() }}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><p>æ‰€æœ‰çš„çŠ¶æ€ç›¸å…³é€»è¾‘éƒ½è¢«å°è£…åœ¨<code>PostStatus</code>æšä¸¾å†…éƒ¨ï¼Œä¸šåŠ¡ä»£ç åªè´Ÿè´£è°ƒç”¨ï¼Œå®Œå…¨æ— éœ€å…³å¿ƒå®ç°ç»†èŠ‚ã€‚è¿™æå¤§åœ°æé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚</p><p><strong>3. é™æ€æ–¹æ³•ä¸æ¥å£</strong></p><p>æšä¸¾è¿˜å¯ä»¥å®ç°æ¥å£å’Œä½¿ç”¨Traitï¼Œæ‹¥æœ‰é™æ€æ–¹æ³•ã€‚<code>Backed Enums</code>é»˜è®¤å®ç°<code>BackedEnum</code>æ¥å£ï¼Œæä¾›äº†<code>from()</code>å’Œ<code>tryFrom()</code>ä¸¤ä¸ªæœ‰ç”¨çš„é™æ€æ–¹æ³•ã€‚</p><ul><li><code>from(string|int $value)</code>: ä»æ ‡é‡å€¼æŸ¥æ‰¾æšä¸¾æˆå‘˜ï¼Œæ‰¾ä¸åˆ°ä¼šæŠ›å‡º<code>ValueError</code>ã€‚</li><li><code>tryFrom(string|int $value)</code>: åŠŸèƒ½åŒä¸Šï¼Œä½†æ‰¾ä¸åˆ°æ—¶ä¼šè¿”å›<code>null</code>ã€‚</li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;published&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¿”å› PostStatus::Published</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryFrom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;deleted&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¿”å› null</span></span></code></pre></div><p><code>tryFrom</code>åœ¨å¤„ç†æ¥è‡ªç”¨æˆ·è¾“å…¥æˆ–å¤–éƒ¨APIçš„ä¸å¯ä¿¡æ•°æ®æ—¶å°¤å…¶æœ‰ç”¨ã€‚</p><p><strong>æ€»ç»“</strong></p><p>åœ¨ç°ä»£PHPå¼€å‘ä¸­ï¼Œ<strong>ä»»ä½•ä¸€ç»„æœ‰é™ã€å›ºå®šçš„ç›¸å…³çŠ¶æ€ï¼Œéƒ½åº”è¯¥ä¼˜å…ˆä½¿ç”¨æšä¸¾æ¥å®ç°</strong>ã€‚</p><ul><li><strong>ç”¨æˆ·è§’è‰²</strong>: <code>enum UserRole: string { case Member = &#39;member&#39;; case Admin = &#39;admin&#39;; }</code></li><li><strong>è®¢å•çŠ¶æ€</strong>: <code>enum OrderStatus: int { case Pending = 1; case Paid = 2; case Shipped = 3; }</code></li><li><strong>é€šçŸ¥ç±»å‹</strong>: <code>enum NotificationType { case NewComment; case FriendRequest; }</code> (è¿™æ˜¯ä¸€ä¸ªPure Enumï¼Œå› ä¸ºå®ƒä¸éœ€è¦æ ‡é‡å€¼)</li></ul><p>ä½¿ç”¨æšä¸¾èƒ½è®©ä½ çš„ä»£ç æ›´å¥å£®ã€æ›´å…·è¡¨ç°åŠ›ã€æ›´æ˜“äºç»´æŠ¤ï¼Œå¹¶ä»è¯­è¨€å±‚é¢æ¶ˆé™¤å› æ— æ•ˆçŠ¶æ€å¯¼è‡´çš„æ½œåœ¨bugã€‚</p><hr><h5 id="_1-3-fibers-çº¤ç¨‹-phpåŸç”Ÿåç¨‹çš„åŸºçŸ³" tabindex="-1">1.3 Fibers (çº¤ç¨‹): PHPåŸç”Ÿåç¨‹çš„åŸºçŸ³ <a class="header-anchor" href="#_1-3-fibers-çº¤ç¨‹-phpåŸç”Ÿåç¨‹çš„åŸºçŸ³" aria-label="Permalink to &quot;1.3 Fibers (çº¤ç¨‹): PHPåŸç”Ÿåç¨‹çš„åŸºçŸ³&quot;">â€‹</a></h5><p>åœ¨PHP 8.1ä¹‹å‰ï¼Œè¦å®ç°é«˜å¹¶å‘çš„å¼‚æ­¥I/Oï¼Œæˆ‘ä»¬å‡ ä¹å”¯ä¸€çš„é€‰æ‹©å°±æ˜¯ä¾èµ–Swooleã€Workermanæˆ–ReactPHPè¿™æ ·çš„ç¬¬ä¸‰æ–¹æ‰©å±•/åº“ã€‚å®ƒä»¬é€šè¿‡Cæ‰©å±•æˆ–äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰å®ç°äº†è‡ªå·±çš„åç¨‹è°ƒåº¦ã€‚</p><p>PHP 8.1å¼•å…¥çš„<strong>Fibersï¼ˆçº¤ç¨‹ï¼‰</strong>ï¼Œé¦–æ¬¡åœ¨è¯­è¨€å±‚é¢æä¾›äº†åç¨‹çš„åº•å±‚æ”¯æŒã€‚</p><p><strong>é‡è¦æ¦‚å¿µ</strong>: Fiberä¸æ˜¯å¼€ç®±å³ç”¨çš„â€œasync/awaitâ€ã€‚å®ƒæ˜¯ä¸€ç§æ›´åº•å±‚çš„æœºåˆ¶ï¼Œå¯ä»¥è®©ä½ åˆ›å»ºèƒ½å¤Ÿè¢«<strong>æš‚åœ (suspend)</strong> å’Œ<strong>æ¢å¤ (resume)</strong> çš„ä»£ç å—ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºâ€œå¯ä¸­æ–­çš„å‡½æ•°â€ã€‚</p><p><strong>1. é—®é¢˜æ‰€åœ¨ï¼šé˜»å¡I/O</strong></p><p>æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸¤ä¸ªç¼“æ…¢çš„APIè·å–æ•°æ®ï¼š</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchApiData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $url)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Fetching </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$url</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">...</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> file_get_contents</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($url); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é˜»å¡ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Finished </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$url</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> microtime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$dataA </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchApiData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://localhost:8001/slow-api&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å‡è®¾è€—æ—¶ 1s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$dataB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchApiData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://localhost:8002/slow-api&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å‡è®¾è€—æ—¶ 1s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> microtime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Total time: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> .</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $start) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¾“å‡º: Total time: ~2s</span></span></code></pre></div><p>ç”±äº<code>file_get_contents</code>æ˜¯é˜»å¡çš„ï¼Œç¨‹åºå¿…é¡»ç­‰å¾…ç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆåæ‰èƒ½å¼€å§‹ç¬¬äºŒä¸ªã€‚æ€»è€—æ—¶æ˜¯ä¸¤è€…ä¹‹å’Œã€‚</p><p><strong>2. Fiberå¦‚ä½•å·¥ä½œ</strong></p><p>Fiberå…è®¸æˆ‘ä»¬åœ¨é˜»å¡ç‚¹ï¼ˆå¦‚ç­‰å¾…ç½‘ç»œI/Oï¼‰æš‚åœå½“å‰å‡½æ•°çš„æ‰§è¡Œï¼Œå¹¶è®©å‡ºCPUå»æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚å½“I/Oæ“ä½œå®Œæˆåï¼Œå†æ¢å¤è¯¥å‡½æ•°çš„æ‰§è¡Œã€‚</p><p>æ ¸å¿ƒAPIéå¸¸ç®€å•ï¼š</p><ul><li><code>$fiber = new Fiber(callable $callback)</code>: åˆ›å»ºä¸€ä¸ªçº¤ç¨‹ã€‚</li><li><code>$fiber-&gt;start()</code>: å¯åŠ¨çº¤ç¨‹ã€‚</li><li><code>Fiber::suspend()</code>: åœ¨çº¤ç¨‹å†…éƒ¨è°ƒç”¨ï¼Œæš‚åœçº¤ç¨‹å¹¶è¿”å›ä¸€ä¸ªå€¼ç»™ä¸»ç¨‹åºã€‚</li><li><code>$fiber-&gt;resume()</code>: åœ¨ä¸»ç¨‹åºä¸­è°ƒç”¨ï¼Œæ¢å¤ä¸€ä¸ªè¢«æš‚åœçš„çº¤ç¨‹ã€‚</li></ul><p><strong>3. æ‰‹åŠ¨å®ç°ä¸€ä¸ªç®€å•çš„å¹¶å‘è°ƒåº¦å™¨</strong></p><p>ä¸ºäº†çœŸæ­£ç†è§£Fiberï¼Œæˆ‘ä»¬æ¥æ„å»ºä¸€ä¸ªèƒ½å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„è°ƒåº¦å™¨ã€‚åœ¨çœŸå®é¡¹ç›®ä¸­ä½ ä¸ä¼šè¿™ä¹ˆåšï¼Œä½†è¿™æ˜¯ç†è§£å…¶åŸç†çš„æœ€ä½³æ–¹å¼ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Scheduler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SplQueue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $taskQueue;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $waitingTasks </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// [stream_socket =&gt; Fiber]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">taskQueue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SplQueue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> addTask</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Fiber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $task)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">taskQueue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enqueue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($task);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">taskQueue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">waitingTasks)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 1. å¯åŠ¨æ–°ä»»åŠ¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">taskQueue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                $task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">taskQueue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dequeue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                $socket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $task</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æœŸæœ›è¿”å›ä¸€ä¸ªsocketèµ„æº</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">waitingTasks[(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)$socket] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $task;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 2. ç›‘å¬æ‰€æœ‰ç­‰å¾…ä¸­çš„socket</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">waitingTasks)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            $readSockets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> array_map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($task) =&gt; $task</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getReturn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">waitingTasks);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ä½¿ç”¨stream_selectè¿›è¡Œéé˜»å¡I/Oç›‘å¬</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            stream_select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($readSockets, $write, $except, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 3. æ¢å¤å·²å°±ç»ªçš„ä»»åŠ¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            foreach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($readSockets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $readySocket) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                $key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)$readySocket;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">waitingTasks[$key])) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    $task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">waitingTasks[$key];</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                    unset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">waitingTasks[$key]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    $task</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ¢å¤æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿ç”¨éé˜»å¡streamé‡å†™APIè¯·æ±‚å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> nonBlockingFetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $host, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $path)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Fiber</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Fiber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($host, $path) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $socket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> stream_socket_client</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tcp://</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$host</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:80&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, $errno, $errstr, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">STREAM_CLIENT_ASYNC_CONNECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        stream_set_blocking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($socket, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $request </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;GET </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$path</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> HTTP/1.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\r\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Host: </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$host</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\r\\n\\r\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        fwrite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($socket, $request);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        Fiber</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">suspend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($socket); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æš‚åœï¼å°†socketè¿”å›ç»™è°ƒåº¦å™¨</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å½“è¢«resumeæ—¶ï¼Œä»è¿™é‡Œç»§ç»­æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($socket, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8192</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// --- ä¸»ç¨‹åº ---</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$scheduler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Scheduler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$scheduler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addTask</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nonBlockingFetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;localhost&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/slow-api-1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å‡è®¾åœ¨80ç«¯å£</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$scheduler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addTask</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nonBlockingFetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;localhost&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/slow-api-2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> microtime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$scheduler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> microtime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Total time: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> .</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $start) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¾“å‡º: Total time: ~1s</span></span></code></pre></div><p><strong>ä»£ç è§£è¯»</strong>:</p><ol><li><code>nonBlockingFetch</code>å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªFiberã€‚å®ƒä½¿ç”¨éé˜»å¡çš„<code>stream_socket_client</code>å‘èµ·è¯·æ±‚åï¼Œç«‹åˆ»è°ƒç”¨<code>Fiber::suspend($socket)</code>æš‚åœè‡ªå·±ï¼Œå¹¶å°†socketå¥æŸ„äº¤ç»™è°ƒåº¦å™¨ã€‚</li><li><code>Scheduler</code>çš„<code>run</code>æ–¹æ³•æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯ã€‚å®ƒå¯åŠ¨ä»»åŠ¡ï¼Œæ”¶é›†æ‰€æœ‰è¢«æš‚åœä»»åŠ¡çš„socketå¥æŸ„ã€‚</li><li>æ ¸å¿ƒæ˜¯<code>stream_select</code>ï¼Œå®ƒä¼šéé˜»å¡åœ°ç­‰å¾…è¿™äº›socketä¸­ä»»ä½•ä¸€ä¸ªå˜å¾—å¯è¯»ï¼ˆå³æœåŠ¡å™¨è¿”å›äº†æ•°æ®ï¼‰ã€‚</li><li>ä¸€æ—¦<code>stream_select</code>è¿”å›ï¼Œè°ƒåº¦å™¨å°±çŸ¥é“å“ªä¸ªsocketå‡†å¤‡å¥½äº†ï¼Œç„¶åæ‰¾åˆ°å¯¹åº”çš„Fiberï¼Œè°ƒç”¨<code>$task-&gt;resume()</code>æ¢å¤å®ƒçš„æ‰§è¡Œã€‚</li><li>è¢«æ¢å¤çš„Fiberä»<code>Fiber::suspend()</code>ä¹‹åç»§ç»­æ‰§è¡Œï¼Œè¯»å–æ•°æ®å¹¶æœ€ç»ˆè¿”å›ã€‚</li></ol><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¸¤ä¸ªAPIè¯·æ±‚çš„ç­‰å¾…æ—¶é—´é‡å äº†ï¼Œæ€»è€—æ—¶è¿‘ä¼¼äºæœ€é•¿çš„é‚£ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬ç”¨PHPåŸç”Ÿä»£ç å®ç°äº†å¹¶å‘ã€‚</p><p><strong>æ€»ç»“ä¸å±•æœ›</strong></p><ul><li><strong>Fibersæ˜¯åº•å±‚å·¥å…·</strong>: ä½ å‡ ä¹æ°¸è¿œä¸ä¼šç›´æ¥åœ¨ä¸šåŠ¡ä»£ç ä¸­åƒä¸Šé¢é‚£æ ·ä½¿ç”¨Fiberã€‚å®ƒå¤ªåº•å±‚ï¼Œå¤ªå¤æ‚ã€‚</li><li><strong>ç†è§£åŸç†æ˜¯å…³é”®</strong>: ç†è§£Fiberçš„â€œæš‚åœ/æ¢å¤â€æ¨¡å‹ï¼Œæ˜¯ä¸ºäº†è®©ä½ æ˜ç™½é‚£äº›ä¸Šå±‚æ¡†æ¶ï¼ˆSwoole, Workerman, RoadRunnerï¼‰æ˜¯å¦‚ä½•åˆ©ç”¨è¿™ä¸ªæœºåˆ¶æ¥å®ç°æ˜“äºä½¿ç”¨çš„é«˜çº§APIçš„ï¼ˆå¦‚åç¨‹MySQLå®¢æˆ·ç«¯ã€åç¨‹Rediså®¢æˆ·ç«¯ï¼‰ã€‚</li><li><strong>æ¡†æ¶çš„ä»·å€¼</strong>: Laravel Octaneã€Hyperfã€imiç­‰æ¡†æ¶å·²ç»é›†æˆäº†åç¨‹ç¯å¢ƒã€‚å®ƒä»¬ä¸ºä½ å¤„ç†äº†å¤æ‚çš„è°ƒåº¦å™¨å’Œäº‹ä»¶å¾ªç¯ï¼Œè®©ä½ èƒ½ä»¥è¿‘ä¹åŒæ­¥çš„ç¼–ç æ–¹å¼ï¼Œäº«å—å¼‚æ­¥å¸¦æ¥çš„å·¨å¤§æ€§èƒ½æå‡ã€‚</li></ul><p>æŒæ¡Fiberçš„åŸç†ï¼Œæ˜¯è¿ˆå‘PHPé«˜æ€§èƒ½æœåŠ¡ç«¯ç¼–ç¨‹çš„ç¬¬ä¸€æ­¥ï¼Œå®ƒè®©ä½ èƒ½æ›´æ·±åˆ»åœ°ç†è§£å’Œä½¿ç”¨ç°ä»£PHPåº”ç”¨æœåŠ¡å™¨ã€‚</p><hr><h5 id="_1-4-ç±»å‹ç³»ç»Ÿè¿›é˜¶" tabindex="-1">1.4 ç±»å‹ç³»ç»Ÿè¿›é˜¶ <a class="header-anchor" href="#_1-4-ç±»å‹ç³»ç»Ÿè¿›é˜¶" aria-label="Permalink to &quot;1.4 ç±»å‹ç³»ç»Ÿè¿›é˜¶&quot;">â€‹</a></h5><p>PHP 8.x çš„ç±»å‹ç³»ç»Ÿå·²ç»ä»â€œå¯é€‰çš„æç¤ºâ€æ¼”å˜ä¸ºæ„å»ºå¥å£®ã€å¯ç»´æŠ¤ã€è‡ªæ–‡æ¡£åŒ–åº”ç”¨çš„å¼ºå¤§åŸºçŸ³ã€‚å¯¹äºæœ‰ç»éªŒçš„å¼€å‘è€…æ¥è¯´ï¼ŒæŒæ¡è¿™äº›é«˜çº§ç±»å‹ç‰¹æ€§ï¼Œæ˜¯æå‡ä»£ç è´¨é‡å’Œæ¶æ„èƒ½åŠ›çš„å¿…ç»ä¹‹è·¯ã€‚</p><p><strong>1. Union Types (è”åˆç±»å‹) - PHP 8.0</strong></p><p>åœ¨PHP 8.0ä¹‹å‰ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°æˆ–å±æ€§å¯ä»¥æ¥å—å¤šç§ç±»å‹ï¼Œæˆ‘ä»¬åªèƒ½ä¾èµ–PHPDocï¼Œè€Œæ— æ³•åœ¨è¯­è¨€å±‚é¢è¿›è¡Œçº¦æŸã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// PHP 7.x çš„æ–¹å¼</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserRepository</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">|</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> $identifier</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">|</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">null</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> find</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($identifier)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">is_int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($identifier)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // find by ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">is_string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($identifier)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // find by username</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>è”åˆç±»å‹å…è®¸ä½ åœ¨å‡½æ•°ç­¾åä¸­åŸç”Ÿå£°æ˜â€œæˆ–â€çš„å…³ç³»ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// PHP 8.0+ çš„æ–¹å¼</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserRepository</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> find</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $identifier)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>å®æˆ˜åº”ç”¨</strong>:</p><ul><li><strong>çµæ´»çš„å‡½æ•°å‚æ•°</strong>: å¦‚ä¸Šä¾‹ï¼Œå…è®¸å‡½æ•°æ¥å—ä¸åŒç±»å‹çš„æ ‡è¯†ç¬¦ã€‚</li><li><strong>DTO/å®ä½“å±æ€§</strong>: ä¸€ä¸ªå±æ€§å¯èƒ½åœ¨åˆ›å»ºæ—¶æ˜¯<code>string</code>ï¼Œä½†åœ¨ä»æ•°æ®åº“æ°´åˆåå˜æˆ<code>DateTimeImmutable</code>å¯¹è±¡ã€‚<code>public string|DateTimeImmutable $createdAt;</code></li><li><strong>è¿”å›å€¼</strong>: ä¸€ä¸ªå‡½æ•°å¯èƒ½æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¤±è´¥æ—¶è¿”å›<code>false</code>ã€‚<code>public function process(): User|false</code></li></ul><p><strong>2. Intersection Types (äº¤å‰ç±»å‹) - PHP 8.1</strong></p><p>å¦‚æœè¯´è”åˆç±»å‹æ˜¯â€œæˆ–â€ï¼Œé‚£ä¹ˆäº¤å‰ç±»å‹å°±æ˜¯â€œä¸â€ã€‚å®ƒè¦æ±‚ä¸€ä¸ªå€¼å¿…é¡»åŒæ—¶æ»¡è¶³å¤šä¸ªæ¥å£çš„å¥‘çº¦ã€‚è¿™åœ¨è®¾è®¡éœ€è¦å¤šç§èƒ½åŠ›ç»„åˆçš„å¤æ‚ç³»ç»Ÿæ—¶éå¸¸å¼ºå¤§ã€‚</p><p><strong>å®æˆ˜åº”ç”¨</strong>: å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°æ®å¤„ç†å™¨ï¼Œå®ƒéœ€è¦å¤„ç†çš„å¯¹è±¡å¿…é¡»æ˜¯<strong>å¯è¿­ä»£çš„</strong>ï¼ˆæ¯”å¦‚ç”¨äºå¾ªç¯ï¼‰å¹¶ä¸”<strong>å¯è¢«æŒä¹…åŒ–çš„</strong>ï¼ˆæ¯”å¦‚æœ‰<code>save()</code>æ–¹æ³•ï¼‰ã€‚</p><ul><li><strong>å®šä¹‰æ¥å£</strong>:</li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Persistable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Traversable æ˜¯PHPå†…ç½®æ¥å£ï¼ŒIteratorAggregate å®ç°äº†å®ƒ</span></span></code></pre></div><ul><li><strong>ä½¿ç”¨äº¤å‰ç±»å‹</strong>:</li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Traversable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æˆ–è€… Countable, IteratorAggregate ç­‰</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DataHandler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Traversable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Persistable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $collection)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æˆ‘ä»¬ç°åœ¨å¯ä»¥100%ç¡®å®š$collectionå¯¹è±¡æ—¢å¯ä»¥è¢«foreachå¾ªç¯...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        foreach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($collection </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $item) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ...ä¹Ÿå¯ä»¥è¢«ä¿å­˜ã€‚</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $collection</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>äº¤å‰ç±»å‹æä¾›äº†ä¸€ç§åœ¨ä¸åˆ›å»ºæ–°æ¥å£æˆ–ç»§æ‰¿å¤æ‚ç±»å±‚æ¬¡ç»“æ„çš„æƒ…å†µä¸‹ï¼Œç»„åˆè¡Œä¸ºå¥‘çº¦çš„ä¼˜é›…æ–¹å¼ï¼Œæå¤§åœ°å¢å¼ºäº†ä»£ç çš„çµæ´»æ€§å’Œç±»å‹å®‰å…¨æ€§ã€‚</p><p><strong>3. <code>readonly</code> Properties &amp; Classes - PHP 8.1 / 8.2</strong></p><p><code>readonly</code>æ˜¯å®ç°ä¸å˜æ€§ï¼ˆImmutabilityï¼‰çš„åˆ©å™¨ã€‚ä¸€ä¸ª<code>readonly</code>å±æ€§åªèƒ½åœ¨å£°æ˜çš„ä½œç”¨åŸŸå†…ï¼ˆé€šå¸¸æ˜¯æ„é€ å‡½æ•°ï¼‰è¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åä»»ä½•ä¿®æ”¹éƒ½ä¼šå¯¼è‡´é”™è¯¯ã€‚</p><p>PHP 8.2æ›´è¿›ä¸€æ­¥ï¼Œå…è®¸å°†æ•´ä¸ªç±»æ ‡è®°ä¸º<code>readonly</code>ï¼Œè¿™æ„å‘³ç€å®ƒçš„æ‰€æœ‰å±æ€§éƒ½è‡ªåŠ¨æˆä¸ºåªè¯»å±æ€§ã€‚</p><p><strong>å®æˆ˜åº”ç”¨</strong>: æ„å»ºå€¼å¯¹è±¡ (Value Objects, VO) å’Œæ•°æ®ä¼ è¾“å¯¹è±¡ (DTO)ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// PHP 8.2 çš„æ–¹å¼</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Attribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">readonly</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Money</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $amount, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Currency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $currency</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ) {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Money</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $other)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Money</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">currency </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $other</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">currency) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> InvalidArgumentException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Cannot add different currencies.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // è¿”å›ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œè€Œä¸æ˜¯ä¿®æ”¹å½“å‰å®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $other</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">amount, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">currency);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ª<code>Money</code>å€¼å¯¹è±¡ä¸­ï¼Œ<code>amount</code>å’Œ<code>currency</code>åœ¨åˆ›å»ºåå°±ä¸èƒ½è¢«æ›´æ”¹ã€‚ä»»ä½•è®¡ç®—ï¼ˆå¦‚<code>add</code>ï¼‰éƒ½ä¼šè¿”å›ä¸€ä¸ª<strong>æ–°çš„</strong><code>Money</code>å®ä¾‹ã€‚è¿™ç§ä¸å˜æ€§å¯ä»¥ä»æ ¹æœ¬ä¸Šæ¶ˆé™¤å› å¯¹è±¡çŠ¶æ€è¢«æ„å¤–ä¿®æ”¹è€Œå¯¼è‡´çš„bugï¼Œä½¿ä»£ç è¡Œä¸ºæ›´å¯é¢„æµ‹ã€‚</p><p><strong>4. <code>never</code> Return Type - PHP 8.1</strong></p><p><code>never</code>ç±»å‹æ˜ç¡®è¡¨ç¤ºä¸€ä¸ªå‡½æ•°<strong>æ°¸è¿œä¸ä¼šè¿”å›</strong>ã€‚å®ƒè¦ä¹ˆæŠ›å‡ºå¼‚å¸¸ï¼Œè¦ä¹ˆæ‰§è¡Œ<code>exit()</code>æˆ–<code>die()</code>ï¼Œè¦ä¹ˆè¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ã€‚</p><p><strong>å®æˆ˜åº”ç”¨</strong>:</p><ul><li><strong>é‡å®šå‘å‡½æ•°</strong>:</li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> redirect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $url)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> never</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Location: &#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> .</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $url);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    exit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>å¼‚å¸¸æŠ›å‡ºåŠ©æ‰‹</strong>:</li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> abort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $code, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $message)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> never</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> HttpException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($message, $code);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ä½¿ç”¨<code>never</code>å¯ä»¥å¸®åŠ©é™æ€åˆ†æå·¥å…·å’ŒIDEæ›´å¥½åœ°ç†è§£ä»£ç æµã€‚å®ƒä»¬ä¼šçŸ¥é“è°ƒç”¨<code>redirect()</code>æˆ–<code>abort()</code>ä¹‹åçš„ä»»ä½•ä»£ç éƒ½æ˜¯ä¸å¯è¾¾çš„ï¼ˆunreachableï¼‰ï¼Œä»è€Œå‘ç°æ½œåœ¨çš„é€»è¾‘é”™è¯¯ã€‚</p><hr><h5 id="_1-5-å…¶ä»–å…³é”®ç‰¹æ€§" tabindex="-1">1.5 å…¶ä»–å…³é”®ç‰¹æ€§ <a class="header-anchor" href="#_1-5-å…¶ä»–å…³é”®ç‰¹æ€§" aria-label="Permalink to &quot;1.5 å…¶ä»–å…³é”®ç‰¹æ€§&quot;">â€‹</a></h5><p>è¿™äº›ç‰¹æ€§è™½å°ï¼Œå´èƒ½æå¤§åœ°æå‡æ—¥å¸¸å¼€å‘çš„æ•ˆç‡å’Œä»£ç çš„ä¼˜é›…åº¦ã€‚</p><ul><li><p><strong>Constructor Property Promotion (æ„é€ å‡½æ•°å±æ€§æå‡)</strong>: æˆ‘ä»¬å·²ç»åœ¨å‰é¢çš„ä¾‹å­ä¸­å¤šæ¬¡ä½¿ç”¨ã€‚å®ƒæå¤§åœ°å‡å°‘äº†å®šä¹‰DTOã€VOå’ŒServiceæ—¶çš„æ ·æ¿ä»£ç ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// PHP 7.x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CustomerService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $users;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> LoggerInterface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $logger;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">UserRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $users, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">LoggerInterface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $logger) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $users;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $logger;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// PHP 8.0+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CustomerService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $users,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> LoggerInterface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $logger,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ) {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p><strong><code>match</code> Expression (é«˜çº§ç”¨æ³•)</strong>: <code>match</code>æ˜¯<code>switch</code>çš„ç°ä»£åŒ–ã€æ›´å®‰å…¨ã€æ›´å¼ºå¤§çš„æ›¿ä»£å“ã€‚å®ƒæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆå¯ä»¥è¿”å›å€¼ï¼‰ï¼Œä½¿ç”¨ä¸¥æ ¼æ¯”è¾ƒï¼ˆ<code>===</code>ï¼‰ï¼Œä¸”æ— éœ€<code>break</code>ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ ¹æ®HTTPæ–¹æ³•å’Œå†…å®¹ç±»å‹è¿”å›ä¸åŒçš„å¤„ç†å™¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$handler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> match</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;GET&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> GetHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;POST&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;PUT&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> match</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getHeader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Content-Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;application/json&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JsonHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;application/x-www-form-urlencoded&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> FormHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UnsupportedMediaTypeException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MethodNotAllowedException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div></li><li><p><strong><code>new</code> in Initializers</strong>: åœ¨PHP 8.1ä¹‹å‰ï¼Œä½ ä¸èƒ½åœ¨å‡½æ•°é»˜è®¤å‚æ•°ã€é™æ€å˜é‡æˆ–Attributeå‚æ•°ä¸­ä½¿ç”¨<code>new</code>ã€‚ç°åœ¨å¯ä»¥äº†ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸ºå‡½æ•°å‚æ•°æä¾›é»˜è®¤çš„ä¾èµ–å®ç°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> logMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $message, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">LoggerInterface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $logger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NullLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $logger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($message);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åœ¨Attributeä¸­ä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CurrentUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resolver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserFromSessionResolver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> showProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {}</span></span></code></pre></div></li><li><p><strong>First-class Callable Syntax</strong>: PHP 8.1æä¾›äº†ä¸€ç§æ›´ç®€æ´ã€æ›´æ˜ç¡®çš„æ–¹å¼æ¥åˆ›å»ºé—­åŒ…ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// PHP 7.4 / 8.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Closure</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fromCallable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([$user, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;getName&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($user) =&gt; $user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// PHP 8.1+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div><p><code>...</code>è¯­æ³•åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘è¯¥æ–¹æ³•çš„é—­åŒ…ï¼Œå¹¶ä¸”æ˜¯ä¸Šä¸‹æ–‡æ— å…³çš„ï¼Œé™æ€åˆ†æå·¥å…·å¯ä»¥æ›´å¥½åœ°ç†è§£å®ƒã€‚</p></li></ul><hr><hr><h3 id="ç¬¬äºŒéƒ¨åˆ†-ç°ä»£æ¶æ„ä¸è®¾è®¡-advanced-architecture-design-1" tabindex="-1">ç¬¬äºŒéƒ¨åˆ†ï¼šç°ä»£æ¶æ„ä¸è®¾è®¡ (Advanced Architecture &amp; Design) <a class="header-anchor" href="#ç¬¬äºŒéƒ¨åˆ†-ç°ä»£æ¶æ„ä¸è®¾è®¡-advanced-architecture-design-1" aria-label="Permalink to &quot;ç¬¬äºŒéƒ¨åˆ†ï¼šç°ä»£æ¶æ„ä¸è®¾è®¡ (Advanced Architecture &amp; Design)&quot;">â€‹</a></h3><h4 id="ç¬¬2ç« -è¶…è¶Šmvc-æ„å»ºå¯æ‰©å±•çš„æœåŠ¡åŒ–æ¶æ„" tabindex="-1">ç¬¬2ç« ï¼šè¶…è¶ŠMVCï¼šæ„å»ºå¯æ‰©å±•çš„æœåŠ¡åŒ–æ¶æ„ <a class="header-anchor" href="#ç¬¬2ç« -è¶…è¶Šmvc-æ„å»ºå¯æ‰©å±•çš„æœåŠ¡åŒ–æ¶æ„" aria-label="Permalink to &quot;ç¬¬2ç« ï¼šè¶…è¶ŠMVCï¼šæ„å»ºå¯æ‰©å±•çš„æœåŠ¡åŒ–æ¶æ„&quot;">â€‹</a></h4><p>ç»å…¸çš„MVCï¼ˆModel-View-Controllerï¼‰æ¨¡å¼æ˜¯è®¸å¤šPHPå¼€å‘è€…å…¥é—¨çš„ç¬¬ä¸€ä¸ªæ¶æ„æ¨¡å¼ï¼Œå®ƒåœ¨å¤„ç†ç®€å•çš„CRUDåº”ç”¨æ—¶è¡¨ç°å‡ºè‰²ã€‚ç„¶è€Œï¼Œéšç€ä¸šåŠ¡é€»è¾‘å˜å¾—æ—¥ç›Šå¤æ‚ï¼Œå¼€å‘è€…å¾€å¾€ä¼šé™·å…¥ä¸¤å¤§å›°å¢ƒï¼š</p><ol><li><strong>èƒ–æ§åˆ¶å™¨ (Fat Controller)</strong>: ä¸ºäº†å¿«é€Ÿå®ç°åŠŸèƒ½ï¼Œå¤§é‡ä¸šåŠ¡é€»è¾‘ã€æ•°æ®éªŒè¯ã€ç¬¬ä¸‰æ–¹APIè°ƒç”¨ã€äº‹ä»¶åˆ†å‘ç­‰ä»£ç è¢«å †ç Œåœ¨æ§åˆ¶å™¨æ–¹æ³•ä¸­ï¼Œå¯¼è‡´æ§åˆ¶å™¨å˜å¾—è‡ƒè‚¿ã€éš¾ä»¥æµ‹è¯•å’Œå¤ç”¨ã€‚</li><li><strong>èƒ–æ¨¡å‹ (Fat Model)</strong>: å¦ä¸€ç§æç«¯æ˜¯å°†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å¡è¿›Modelï¼ˆå°¤å…¶æ˜¯Active Recordæ¨¡å¼çš„Modelï¼‰ä¸­ï¼Œå¯¼è‡´æ¨¡å‹ä¸ä»…è¦è´Ÿè´£æ•°æ®æŒä¹…åŒ–ï¼Œè¿˜è¦æ‰¿æ‹…å¤æ‚çš„ä¸šåŠ¡è®¡ç®—å’Œæµç¨‹æ§åˆ¶ï¼Œè¿åäº†å•ä¸€èŒè´£åŸåˆ™ã€‚</li></ol><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥æ›´ç²¾ç»†çš„åˆ†å±‚æ¶æ„ï¼Œå°†ä¸åŒçš„èŒè´£æ¸…æ™°åœ°åˆ†ç¦»åˆ°ä¸åŒçš„ç±»ä¸­ã€‚</p><h5 id="_2-1-ä¸ºä»€ä¹ˆéœ€è¦åˆ†å±‚æ¶æ„" tabindex="-1">2.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å±‚æ¶æ„ <a class="header-anchor" href="#_2-1-ä¸ºä»€ä¹ˆéœ€è¦åˆ†å±‚æ¶æ„" aria-label="Permalink to &quot;2.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å±‚æ¶æ„&quot;">â€‹</a></h5><p>åˆ†å±‚æ¶æ„çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>å…³æ³¨ç‚¹åˆ†ç¦» (Separation of Concerns)</strong>ã€‚é€šè¿‡å¼•å…¥æ–°çš„å±‚æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š</p><ul><li><strong>æå‡ä»£ç çš„å¯æµ‹è¯•æ€§</strong>: å°†ä¸šåŠ¡é€»è¾‘ä»ä¸HTTPè¯·æ±‚ç´§å¯†è€¦åˆçš„æ§åˆ¶å™¨ä¸­å‰¥ç¦»å‡ºæ¥ï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸æ¨¡æ‹ŸHTTPç¯å¢ƒçš„æƒ…å†µä¸‹å¯¹å…¶è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚</li><li><strong>å¢å¼ºä»£ç çš„å¯å¤ç”¨æ€§</strong>: åŒæ ·çš„ä¸šåŠ¡é€»è¾‘å¯èƒ½è¢«å¤šä¸ªåœ°æ–¹è°ƒç”¨ï¼Œä¾‹å¦‚è¢«Webæ§åˆ¶å™¨ã€APIæ§åˆ¶å™¨ã€å‘½ä»¤è¡Œä»»åŠ¡ã€é˜Ÿåˆ—ä»»åŠ¡ç­‰ã€‚å°†å®ƒå°è£…åœ¨ç‹¬ç«‹çš„å±‚ä¸­ï¼Œå°±å¯ä»¥è¢«è½»æ¾å¤ç”¨ã€‚</li><li><strong>æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§</strong>: æ¯ä¸ªå±‚èŒè´£å•ä¸€ï¼Œä¿®æ”¹ä¸šåŠ¡é€»è¾‘æ—¶ï¼Œä½ åªéœ€è¦å…³å¿ƒæœåŠ¡å±‚ï¼›ä¿®æ”¹æ•°æ®è®¿é—®æ–¹å¼æ—¶ï¼Œä½ åªéœ€è¦å…³å¿ƒä»“åº“å±‚ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ–°äººæ›´å®¹æ˜“ä¸Šæ‰‹ã€‚</li><li><strong>é€‚åº”æœªæ¥çš„å˜åŒ–</strong>: å¦‚æœæœ‰ä¸€å¤©ä½ éœ€è¦å°†æ•°æ®åº“ä»MySQLè¿ç§»åˆ°PostgreSQLï¼Œæˆ–è€…ä»Eloquent ORMåˆ‡æ¢åˆ°Doctrineï¼Œä½ åªéœ€è¦é‡å†™ä»“åº“å±‚çš„å®ç°ï¼Œè€ŒæœåŠ¡å±‚å’Œæ§åˆ¶å™¨å±‚å‡ ä¹ä¸å—å½±å“ã€‚</li></ul><h5 id="_2-2-æ¶æ„æ¨¡å¼å®æˆ˜" tabindex="-1">2.2 æ¶æ„æ¨¡å¼å®æˆ˜ <a class="header-anchor" href="#_2-2-æ¶æ„æ¨¡å¼å®æˆ˜" aria-label="Permalink to &quot;2.2 æ¶æ„æ¨¡å¼å®æˆ˜&quot;">â€‹</a></h5><p>ä¸€ä¸ªå…¸å‹ä¸”å®ç”¨çš„åˆ†å±‚æ¶æ„åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒå±‚æ¬¡ï¼š</p><p><strong>1. æœåŠ¡å±‚ (Service Layer)</strong></p><ul><li><strong>èŒè´£</strong>: å°è£…å’Œç¼–æ’æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚å®ƒæ˜¯åº”ç”¨åŠŸèƒ½çš„ç›´æ¥ä½“ç°ã€‚</li><li><strong>ç‰¹ç‚¹</strong>: <ul><li>å®ƒä¸å…³å¿ƒæ•°æ®ä»å“ªé‡Œæ¥ï¼ˆHTTPè¯·æ±‚ã€å‘½ä»¤è¡Œå‚æ•°ï¼‰ï¼Œä¹Ÿä¸å…³å¿ƒæ•°æ®åˆ°å“ªé‡Œå»ï¼ˆæ¸²æŸ“HTMLã€è¿”å›JSONï¼‰ã€‚</li><li>å®ƒè°ƒç”¨ä¸€ä¸ªæˆ–å¤šä¸ªä»“åº“å±‚æ¥è·å–å’ŒæŒä¹…åŒ–æ•°æ®ã€‚</li><li>å®ƒå¯ä»¥è°ƒç”¨å…¶ä»–æœåŠ¡æ¥å®Œæˆæ›´å¤æ‚çš„ä¸šåŠ¡æµç¨‹ã€‚</li><li>å®ƒé€šå¸¸æ˜¯äº‹åŠ¡è¾¹ç•Œçš„ç†æƒ³ä½ç½®ã€‚</li></ul></li></ul><p><strong>ç¤ºä¾‹ï¼šåˆ›å»ºä¸€ä¸ªå¸–å­å‘å¸ƒæœåŠ¡</strong></p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/Service/PostPublisherService.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PostPublisherService</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $postRepository,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $userRepository,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> EventDispatcher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $dispatcher,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ) {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $postId, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $userId)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Post</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $post </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">postRepository</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findOrFail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($postId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">userRepository</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findOrFail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($userId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">can</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;publish&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, $post)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> AuthorizationException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;You are not allowed to publish this post.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Published</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DomainException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Post is already published.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Published</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">published_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DateTimeImmutable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">postRepository</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($post);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åˆ†å‘é¢†åŸŸäº‹ä»¶</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dispatcher</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostWasPublished</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $post;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>2. ä»“åº“å±‚ (Repository Layer)</strong></p><ul><li><strong>èŒè´£</strong>: æŠ½è±¡æ•°æ®è®¿é—®é€»è¾‘ï¼Œå……å½“é¢†åŸŸå¯¹è±¡ï¼ˆå¦‚<code>Post</code>å®ä½“ï¼‰ä¸æ•°æ®æŒä¹…åŒ–æœºåˆ¶ï¼ˆå¦‚æ•°æ®åº“ã€ç¼“å­˜ã€å¤–éƒ¨APIï¼‰ä¹‹é—´çš„ä¸­ä»‹ã€‚</li><li><strong>ç‰¹ç‚¹</strong>: <ul><li>å®ƒæä¾›ä¸€ä¸ªç±»ä¼¼é›†åˆçš„æ¥å£æ¥æ“ä½œé¢†åŸŸå¯¹è±¡ã€‚</li><li>å®ƒçš„å…¬å…±æ–¹æ³•åº”è¯¥è¿”å›é¢†åŸŸå¯¹è±¡æˆ–é¢†åŸŸå¯¹è±¡çš„é›†åˆã€‚</li><li>å®ƒéšè—äº†åº•å±‚çš„æŸ¥è¯¢é€»è¾‘ï¼ˆæ— è®ºæ˜¯Eloquentã€Doctrine Query Builderè¿˜æ˜¯åŸç”ŸSQLï¼‰ã€‚</li></ul></li></ul><p><strong>ç¤ºä¾‹ï¼šå¸–å­çš„ä»“åº“æ¥å£ä¸å®ç°</strong></p><ul><li><strong>å®šä¹‰æ¥å£ (Contract)</strong>:</li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/Repository/PostRepository.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PostRepository</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> findOrFail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $id)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $post)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> findPublished</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $limit, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $offset)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>åŸºäºEloquentçš„å®ç°</strong>:</li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/Repository/Eloquent/PostRepositoryImpl.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PostRepositoryImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PostRepository</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> findOrFail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $id)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Post</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Postæ˜¯Eloquent Model</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findOrFail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $post)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> findPublished</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $limit, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $offset)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> array</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;status&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PostStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Published</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">orderBy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;published_at&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;desc&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">limit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($limit)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($offset)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>é€šè¿‡ä¾èµ–æ¥å£ï¼ˆ<code>PostRepository</code>ï¼‰è€Œä¸æ˜¯å…·ä½“å®ç°ï¼ˆ<code>PostRepositoryImpl</code>ï¼‰ï¼Œæˆ‘ä»¬çš„<code>PostPublisherService</code>å®Œå…¨ä¸çŸ¥é“æ•°æ®æ˜¯å­˜åœ¨MySQLè¿˜æ˜¯å…¶ä»–åœ°æ–¹ï¼Œå®ç°äº†ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®è®¿é—®çš„è§£è€¦ã€‚</p><p><strong>3. æ•°æ®ä¼ è¾“å¯¹è±¡ (Data Transfer Object, DTO)</strong></p><ul><li><strong>èŒè´£</strong>: åœ¨ä¸åŒå±‚ä¹‹é—´ï¼ˆå°¤å…¶æ˜¯æ§åˆ¶å™¨å’ŒæœåŠ¡å±‚ä¹‹é—´ï¼‰ä¼ é€’æ•°æ®ã€‚å®ƒæ˜¯ä¸€ä¸ªç®€å•ã€æ²¡æœ‰è¡Œä¸ºçš„çº¯æ•°æ®å¯¹è±¡ã€‚</li><li><strong>ç‰¹ç‚¹</strong>: <ul><li>é€šå¸¸æ˜¯<code>readonly</code>çš„ï¼Œä»¥ä¿è¯æ•°æ®åœ¨ä¼ é€’è¿‡ç¨‹ä¸­çš„ä¸å˜æ€§ã€‚</li><li>å®ƒçš„å±æ€§æ˜¯å…¬å¼€çš„ï¼Œä¾¿äºè®¿é—®ã€‚</li><li>å®ƒå¯ä»¥åŒ…å«æ¥è‡ªHTTPè¯·æ±‚çš„ç»è¿‡éªŒè¯å’Œç±»å‹è½¬æ¢çš„æ•°æ®ã€‚</li></ul></li></ul><p><strong>ç¤ºä¾‹ï¼šåˆ›å»ºå¸–å­çš„DTO</strong></p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/DTO/CreatePostDTO.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">readonly</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CreatePostDTO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $title,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $content,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $authorId,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $tags,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ) {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fromRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $request)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> self</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ­¤å¤„å¯ä»¥åŒ…å«éªŒè¯é€»è¾‘ï¼Œæˆ–å‡è®¾æ•°æ®å·²ç”±FormRequestéªŒè¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            title</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: $request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;title&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            content</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: $request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;content&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            authorId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: $request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            tags</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: $request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;tags&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, []),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>æ•´åˆä¸‰è€…ï¼šé‡æ„æ§åˆ¶å™¨</strong></p><p>ç°åœ¨ï¼Œæˆ‘ä»¬çš„æ§åˆ¶å™¨å˜å¾—æå…¶â€œç˜¦â€ä¸”æ¸…æ™°ï¼š</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/Controller/PostController.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PostController</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostPublisherService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $publisher) {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $request, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $postId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            $post </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">publisher</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($postId, $request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostResource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($post); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿ç”¨API Resourceè¿”å›JSON</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AuthorizationException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $e) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;message&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">403</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DomainException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $e) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;message&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">422</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ModelNotFoundException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $e) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;message&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Post not found.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">404</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>æ§åˆ¶å™¨çš„èŒè´£å›å½’æœ¬æºï¼šè§£æHTTPè¯·æ±‚ï¼Œè°ƒç”¨ç›¸åº”çš„æœåŠ¡ï¼Œå¤„ç†å¼‚å¸¸ï¼Œå¹¶è¿”å›HTTPå“åº”ã€‚æ‰€æœ‰çš„ä¸šåŠ¡å¤æ‚æ€§éƒ½è¢«ä¼˜é›…åœ°å°è£…åœ¨äº†æœåŠ¡å±‚å’Œä»“åº“å±‚ä¸­ã€‚</p><h5 id="_2-3-é¢†åŸŸé©±åŠ¨è®¾è®¡-ddd-lite-åœ¨phpä¸­çš„å®è·µ" tabindex="-1">2.3 é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD) Lite åœ¨PHPä¸­çš„å®è·µ <a class="header-anchor" href="#_2-3-é¢†åŸŸé©±åŠ¨è®¾è®¡-ddd-lite-åœ¨phpä¸­çš„å®è·µ" aria-label="Permalink to &quot;2.3 é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD) Lite åœ¨PHPä¸­çš„å®è·µ&quot;">â€‹</a></h5><p>é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDomain-Driven Design, DDDï¼‰æ˜¯ä¸€å¥—å¤æ‚çš„è½¯ä»¶å¼€å‘æ–¹æ³•è®ºï¼Œæ—¨åœ¨å°†è½¯ä»¶çš„æ ¸å¿ƒå¤æ‚æ€§èšç„¦äºä¸šåŠ¡é¢†åŸŸæœ¬èº«ã€‚å®Œå…¨å®æ–½DDDå¯¹è®¸å¤šé¡¹ç›®æ¥è¯´è¿‡äºæ²‰é‡ï¼Œä½†æˆ‘ä»¬å¯ä»¥å€Ÿé‰´å…¶æ ¸å¿ƒæ€æƒ³å’Œæ¨¡å¼ï¼ˆå³â€œDDD Liteâ€ï¼‰ï¼Œæ¥æå¤§åœ°æ”¹è¿›æˆ‘ä»¬å·²ç»å»ºç«‹çš„åˆ†å±‚æ¶æ„ã€‚</p><p>DDD Liteçš„æ ¸å¿ƒæ˜¯<strong>ä½¿ç”¨ä»£ç æ¥ç²¾ç¡®åœ°è¡¨è¾¾ä¸šåŠ¡é¢†åŸŸä¸­çš„æ¦‚å¿µå’Œè§„åˆ™</strong>ã€‚</p><p><strong>1. Entity (å®ä½“)</strong></p><p>å®ä½“æ˜¯å…·æœ‰<strong>å”¯ä¸€æ ‡è¯†</strong>å’Œ<strong>ç”Ÿå‘½å‘¨æœŸ</strong>çš„é¢†åŸŸå¯¹è±¡ã€‚å®ƒçš„æ ¸å¿ƒæ˜¯â€œèº«ä»½â€ï¼Œè€Œä¸æ˜¯å±æ€§ã€‚åœ¨æˆ‘ä»¬çš„åˆ†å±‚æ¶æ„ä¸­ï¼Œ<code>Post</code>å’Œ<code>User</code>å°±æ˜¯å…¸å‹çš„å®ä½“ã€‚å®ƒä»¬æœ‰IDï¼Œå³ä½¿å®ƒä»¬çš„å±æ€§ï¼ˆå¦‚<code>Post</code>çš„æ ‡é¢˜ï¼‰å‘ç”Ÿå˜åŒ–ï¼Œå®ƒä»¬ä»ç„¶æ˜¯åŒä¸€ä¸ªå®ä½“ã€‚</p><p><strong>å…³é”®å®è·µ</strong>: å®ä½“çš„å…¬å…±æ–¹æ³•åº”è¯¥ä½“ç°ä¸šåŠ¡è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯<code>get/set</code>ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Post</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... properties</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> archive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Draft</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DomainException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Cannot archive a draft post.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Archived</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">archived_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DateTimeImmutable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> changeTitle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $newTitle, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $editor)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($newTitle)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> InvalidArgumentException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Title cannot be empty.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">title </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $newTitle;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addLog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Title changed by {</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$editor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>è°ƒç”¨<code>$post-&gt;archive()</code>æ¯”<code>$post-&gt;setStatus(PostStatus::Archived)</code>æ›´èƒ½ä½“ç°ä¸šåŠ¡æ„å›¾ã€‚</p><p><strong>2. Value Object (å€¼å¯¹è±¡, VO)</strong></p><p>å€¼å¯¹è±¡æ˜¯æ²¡æœ‰å”¯ä¸€æ ‡è¯†çš„ã€ç”¨äºæè¿°é¢†åŸŸä¸­æŸä¸ªæ–¹é¢å±æ€§çš„å¯¹è±¡ã€‚å®ƒçš„æ ¸å¿ƒæ˜¯å®ƒçš„<strong>å±æ€§å€¼</strong>ï¼Œå¹¶ä¸”å®ƒåº”è¯¥æ˜¯<strong>ä¸å¯å˜çš„ (immutable)</strong>ã€‚ä¸¤ä¸ªå€¼å¯¹è±¡åªè¦æ‰€æœ‰å±æ€§éƒ½ç›¸åŒï¼Œå®ƒä»¬å°±æ˜¯ç­‰ä»·çš„ã€‚</p><p>æˆ‘ä»¬åœ¨<code>readonly</code>ç‰¹æ€§ä¸­å·²ç»æ¥è§¦è¿‡<code>Money</code>çš„ä¾‹å­ã€‚å¦ä¸€ä¸ªç»å…¸ä¾‹å­æ˜¯<code>Address</code>ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/Domain/ValueObject/Address.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">readonly</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Address</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $street,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $city,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $postalCode,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($street) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($city)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> InvalidArgumentException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Street and city cannot be empty.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> equals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $other)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">street </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $other</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">street </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">               $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">city </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $other</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">city </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">               $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">postalCode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $other</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">postalCode;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>å…³é”®å®è·µ</strong>: åœ¨å®ä½“ä¸­ä½¿ç”¨å€¼å¯¹è±¡æ¥æ›¿ä»£ä¸€ç»„é›¶æ•£çš„å±æ€§ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸å¥½çš„å®è·µ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Order</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $shippingStreet;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $shippingCity;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $shippingPostalCode;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¥½çš„å®è·µ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Order</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $shippingAddress;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š</p><ul><li><strong>å†…èšæ€§</strong>: ä¸åœ°å€ç›¸å…³çš„é€»è¾‘ï¼ˆå¦‚éªŒè¯ï¼‰è¢«å°è£…åœ¨<code>Address</code>ç±»ä¸­ã€‚</li><li><strong>ä»£ç å¤ç”¨</strong>: <code>Address</code>å€¼å¯¹è±¡å¯ä»¥åœ¨<code>Order</code>ã€<code>User</code>ã€<code>Warehouse</code>ç­‰å¤šä¸ªå®ä½“ä¸­å¤ç”¨ã€‚</li><li><strong>æ˜ç¡®æ€§</strong>: <code>Address</code>ç±»å‹æ¯”ä¸€ç»„<code>string</code>æ›´èƒ½æ¸…æ™°åœ°è¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µã€‚</li></ul><p><strong>3. Aggregate &amp; Aggregate Root (èšåˆä¸èšåˆæ ¹)</strong></p><p>è¿™æ˜¯DDDä¸­ä¸€ä¸ªæå…¶é‡è¦çš„æ¦‚å¿µã€‚<strong>èšåˆ</strong>æ˜¯ä¸€ç»„ä¸šåŠ¡ä¸Šç´§å¯†å…³è”çš„å®ä½“å’Œå€¼å¯¹è±¡çš„é›†åˆï¼Œå®ƒè¢«è§†ä¸ºä¸€ä¸ªæ•°æ®ä¿®æ”¹çš„å•å…ƒã€‚<strong>èšåˆæ ¹</strong>æ˜¯è¿™ä¸ªé›†åˆä¸­çš„ä¸€ä¸ªç‰¹å®šå®ä½“ï¼Œä½œä¸ºæ•´ä¸ªèšåˆçš„å”¯ä¸€å…¥å£ã€‚</p><p><strong>è§„åˆ™</strong>:</p><ul><li>å¤–éƒ¨å¯¹è±¡åªèƒ½æŒæœ‰å¯¹èšåˆæ ¹çš„å¼•ç”¨ã€‚</li><li>å¯¹èšåˆå†…éƒ¨çš„ä»»ä½•ä¿®æ”¹éƒ½å¿…é¡»é€šè¿‡èšåˆæ ¹çš„æ–¹æ³•æ¥å®Œæˆã€‚</li><li>èšåˆæ ¹è´Ÿè´£ç»´æŠ¤å…¶å†…éƒ¨æ‰€æœ‰å¯¹è±¡çš„ä¸€è‡´æ€§è§„åˆ™ï¼ˆå³â€œä¸å˜é‡â€ï¼‰ã€‚</li></ul><p><strong>å®æˆ˜åº”ç”¨ï¼šè®¢å•(Order)èšåˆ</strong></p><p>ä¸€ä¸ª<code>Order</code>èšåˆå¯èƒ½åŒ…å«ï¼š</p><ul><li><code>Order</code>å®ä½“ï¼ˆèšåˆæ ¹ï¼‰</li><li>ä¸€ç»„<code>OrderItem</code>å®ä½“</li><li>ä¸€ä¸ª<code>Address</code>å€¼å¯¹è±¡ï¼ˆæ”¶è´§åœ°å€ï¼‰</li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Order</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $id;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $shippingAddress;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $items </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OrderStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $status;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> addItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Product</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $product, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $quantity)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OrderStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Pending</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DomainException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Cannot add items to a non-pending order.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($quantity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> InvalidArgumentException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Quantity must be positive.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // èšåˆæ ¹è´Ÿè´£åˆ›å»ºå’Œç®¡ç†å†…éƒ¨å®ä½“</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">items[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OrderItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($product</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id, $product</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">price, $quantity);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">recalculateTotal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ship</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $address)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OrderStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Paid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DomainException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Cannot ship an unpaid order.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">shippingAddress </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $address;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OrderStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Shipped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åˆ†å‘é¢†åŸŸäº‹ä»¶</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OrderWasShipped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... å…¶ä»–æ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>å…³é”®å®è·µ</strong>:</p><ul><li><code>OrderItemRepository</code>æ˜¯ä¸åº”è¯¥å­˜åœ¨çš„ã€‚å¦‚æœä½ éœ€è¦ä¸€ä¸ªè®¢å•é¡¹ï¼Œä½ å¿…é¡»å…ˆé€šè¿‡<code>OrderRepository</code>è·å–<code>Order</code>ï¼Œå†ä»<code>Order</code>å¯¹è±¡ä¸­è·å–å®ƒã€‚</li><li>æ‰€æœ‰ä¸šåŠ¡æ“ä½œï¼Œå¦‚<code>addItem</code>, <code>ship</code>, <code>cancel</code>ï¼Œéƒ½æ˜¯<code>Order</code>èšåˆæ ¹çš„æ–¹æ³•ã€‚è¿™ä¿è¯äº†åœ¨ä»»ä½•æ“ä½œåï¼Œ<code>Order</code>çš„å†…éƒ¨çŠ¶æ€ï¼ˆå¦‚æ€»ä»·ã€çŠ¶æ€ï¼‰éƒ½æ˜¯ä¸€è‡´å’Œæœ‰æ•ˆçš„ã€‚</li></ul><p><strong>4. Domain Event (é¢†åŸŸäº‹ä»¶)</strong></p><p>é¢†åŸŸäº‹ä»¶æ˜¯è¡¨ç¤ºé¢†åŸŸä¸­å·²å‘ç”Ÿäº‹æƒ…çš„å¯¹è±¡ã€‚å®ƒç”¨äºè§£è€¦èšåˆå†…éƒ¨çš„æ ¸å¿ƒé€»è¾‘å’Œåç»­çš„å‰¯ä½œç”¨ï¼ˆå¦‚å‘é€é‚®ä»¶ã€é€šçŸ¥ã€æ›´æ–°å…¶ä»–èšåˆç­‰ï¼‰ã€‚</p><p>æˆ‘ä»¬åœ¨<code>PostPublisherService</code>ä¸­å·²ç»è§è¿‡å®ƒçš„èº«å½±ï¼š<code>$this-&gt;dispatcher-&gt;dispatch(new PostWasPublished($post-&gt;id));</code></p><p><strong>å…³é”®å®è·µ</strong>:</p><ul><li><strong>å‘½å</strong>: ä½¿ç”¨è¿‡å»æ—¶æ€ï¼Œå¦‚<code>OrderWasPlaced</code>, <code>UserRegistered</code>ã€‚</li><li><strong>å†…å®¹</strong>: äº‹ä»¶åº”åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯è®©ç›‘å¬è€…èƒ½å®Œæˆå·¥ä½œï¼Œé€šå¸¸æ˜¯ç›¸å…³å®ä½“çš„IDå’Œå…³é”®æ•°æ®ã€‚</li><li><strong>è§£è€¦</strong>: æ ¸å¿ƒä¸šåŠ¡ï¼ˆå¦‚ä¸‹è®¢å•ï¼‰å®Œæˆåï¼Œç«‹å³åˆ†å‘äº‹ä»¶ã€‚ç„¶åï¼Œä¸€ä¸ªæˆ–å¤šä¸ª<strong>ç›‘å¬å™¨ (Listeners)</strong> ä¼šå¼‚æ­¥ï¼ˆæˆ–åŒæ­¥ï¼‰åœ°å“åº”è¯¥äº‹ä»¶ï¼Œæ‰§è¡Œå‘é€ç¡®è®¤é‚®ä»¶ã€æ‰£å‡åº“å­˜ã€é€šçŸ¥ä»“åº“ç­‰æ“ä½œã€‚è¿™ä½¿å¾—æ ¸å¿ƒä¸šåŠ¡æµç¨‹éå¸¸å¹²å‡€ã€å¿«é€Ÿï¼Œå¹¶ä¸”æ˜“äºæ‰©å±•ã€‚</li></ul><p>é€šè¿‡åº”ç”¨è¿™äº›DDD Liteæ¨¡å¼ï¼Œä½ çš„ä»£ç å°†ä¸å†ä»…ä»…æ˜¯æ•°æ®çš„æ¬è¿å·¥ï¼Œè€Œæ˜¯æˆä¸ºä¸šåŠ¡é¢†åŸŸæœ¬èº«çš„ç²¾å‡†ã€å¥å£®ã€å¯æ¼”è¿›çš„æ¨¡å‹ã€‚</p><p><strong>DDDçš„æƒè¡¡ï¼šä½•æ—¶ä½¿ç”¨ï¼Ÿ</strong></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒDDDå¹¶éé“¶å¼¹ã€‚å®ƒå¸¦æ¥äº†æ›´é«˜çš„è®¤çŸ¥è´Ÿè·å’Œä»£ç é‡ï¼Œå¯¹äºç®€å•çš„ä¸šåŠ¡åœºæ™¯å¯èƒ½å±äºâ€œè¿‡åº¦è®¾è®¡â€ã€‚</p><ul><li><strong>ä½•æ—¶ä½¿ç”¨</strong>: å½“ä½ é¢å¯¹ä¸€ä¸ªå…·æœ‰å¤æ‚ä¸šåŠ¡è§„åˆ™ã€æµç¨‹å’Œä¸å˜é‡çš„æ ¸å¿ƒé¢†åŸŸæ—¶ï¼ˆä¾‹å¦‚ï¼Œç”µå•†çš„è®¢å•å’Œåº“å­˜ç®¡ç†ã€é‡‘èçš„é£æ§å’Œäº¤æ˜“ï¼‰ï¼ŒDDDçš„æŠ•å…¥æ˜¯å€¼å¾—çš„ã€‚å®ƒèƒ½å¸®åŠ©ä½ ç†æ¸…å¤æ‚æ€§ï¼Œæ„å»ºä¸€ä¸ªå¯é•¿æœŸæ¼”è¿›çš„å¥å£®æ¨¡å‹ã€‚</li><li><strong>ä½•æ—¶æ…ç”¨</strong>: å¯¹äºé‚£äº›ä¸šåŠ¡é€»è¾‘ç®€å•ã€ä»¥æ•°æ®å±•ç¤ºä¸ºä¸»çš„CRUDæ¨¡å—ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªåå°çš„æ ‡ç­¾ç®¡ç†ã€æ–‡ç« åˆ†ç±»ç®¡ç†ï¼‰ï¼Œä½¿ç”¨ç®€å•çš„æœåŠ¡å±‚+ä»“åº“å±‚ï¼Œç”šè‡³ä¼ ç»Ÿçš„æ§åˆ¶å™¨+æ¨¡å‹å°±è¶³å¤Ÿäº†ã€‚</li></ul><p>å…³é”®åœ¨äº<strong>æˆ˜ç•¥æ€§åœ°åº”ç”¨DDD</strong>ï¼šåœ¨åº”ç”¨çš„æ ¸å¿ƒã€æœ€å¤æ‚çš„éƒ¨åˆ†é‡‡ç”¨DDDæ€æƒ³ï¼Œè€Œåœ¨éæ ¸å¿ƒã€ç®€å•çš„éƒ¨åˆ†ä¿æŒåŠ¡å®å’Œç®€æ´ã€‚</p><hr><h5 id="_2-4-æ¨¡å—åŒ–ä¸åŒ…å¼€å‘" tabindex="-1">2.4 æ¨¡å—åŒ–ä¸åŒ…å¼€å‘ <a class="header-anchor" href="#_2-4-æ¨¡å—åŒ–ä¸åŒ…å¼€å‘" aria-label="Permalink to &quot;2.4 æ¨¡å—åŒ–ä¸åŒ…å¼€å‘&quot;">â€‹</a></h5><p>å½“åº”ç”¨å˜å¾—åºå¤§æ—¶ï¼Œå³ä½¿æœ‰äº†åˆ†å±‚æ¶æ„ï¼Œ<code>app/Services</code>, <code>app/Repositories</code>ç­‰ç›®å½•ä¹Ÿä¼šå˜å¾—éš¾ä»¥ç®¡ç†ã€‚æ¨¡å—åŒ–æ˜¯å°†å¤§å‹åº”ç”¨æ‹†åˆ†ä¸ºæ›´å°ã€å†…èšã€è‡ªæ²»çš„ä¸šåŠ¡åŠŸèƒ½å•å…ƒçš„è¿‡ç¨‹ã€‚</p><p><strong>1. æŒ‰é¢†åŸŸåˆ’åˆ†ç›®å½•ç»“æ„</strong></p><p>æœ€ç®€å•çš„æ¨¡å—åŒ–æ–¹å¼æ˜¯æ”¹å˜ä½ çš„ç›®å½•ç»“æ„ï¼Œä»æŒ‰æŠ€æœ¯åˆ†å±‚ï¼ˆ<code>Controllers</code>, <code>Models</code>ï¼‰è½¬ä¸ºæŒ‰ä¸šåŠ¡é¢†åŸŸåˆ†å±‚ã€‚</p><ul><li><p><strong>ä¼ ç»Ÿç»“æ„</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>app/</span></span>
<span class="line"><span>â”œâ”€â”€ Http/Controllers/</span></span>
<span class="line"><span>â”‚   â”œâ”€â”€ UserController.php</span></span>
<span class="line"><span>â”‚   â””â”€â”€ ProductController.php</span></span>
<span class="line"><span>â”œâ”€â”€ Models/</span></span>
<span class="line"><span>â”‚   â”œâ”€â”€ User.php</span></span>
<span class="line"><span>â”‚   â””â”€â”€ Product.php</span></span>
<span class="line"><span>â””â”€â”€ Services/</span></span>
<span class="line"><span>    â”œâ”€â”€ UserService.php</span></span>
<span class="line"><span>    â””â”€â”€ ProductService.php</span></span></code></pre></div></li><li><p><strong>æ¨¡å—åŒ–ç»“æ„</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>src/</span></span>
<span class="line"><span>â”œâ”€â”€ User/</span></span>
<span class="line"><span>â”‚   â”œâ”€â”€ Application/UserService.php</span></span>
<span class="line"><span>â”‚   â”œâ”€â”€ Domain/User.php</span></span>
<span class="line"><span>â”‚   â”œâ”€â”€ Infrastructure/EloquentUserRepository.php</span></span>
<span class="line"><span>â”‚   â””â”€â”€ Presentation/UserController.php</span></span>
<span class="line"><span>â””â”€â”€ Product/</span></span>
<span class="line"><span>    â”œâ”€â”€ Application/ProductService.php</span></span>
<span class="line"><span>    â”œâ”€â”€ Domain/Product.php</span></span>
<span class="line"><span>    â”œâ”€â”€ Infrastructure/EloquentProductRepository.php</span></span>
<span class="line"><span>    â””â”€â”€ Presentation/ProductController.php</span></span></code></pre></div><p>ï¼ˆè¿™é‡Œçš„<code>Application</code>, <code>Domain</code>, <code>Infrastructure</code>, <code>Presentation</code>æ˜¯DDDåˆ†å±‚å‘½åæ³•ï¼Œå¯ä»¥ç®€åŒ–ä¸º<code>Services</code>, <code>Models</code>, <code>Repositories</code>, <code>Controllers</code>ï¼‰</p></li></ul><p>è¿™ç§ç»“æ„ä½¿å¾—ä¸ç‰¹å®šä¸šåŠ¡ï¼ˆå¦‚<code>User</code>ï¼‰ç›¸å…³çš„æ‰€æœ‰ä»£ç éƒ½é›†ä¸­åœ¨ä¸€èµ·ï¼Œæå¤§åœ°æé«˜äº†ä»£ç å†…èšæ€§å’Œå¯å‘ç°æ€§ã€‚</p><p><strong>2. æå–ä¸ºComposeråŒ…</strong></p><p>å½“ä¸€ä¸ªæ¨¡å—è¶³å¤Ÿç¨³å®šå’Œç‹¬ç«‹æ—¶ï¼Œå¯ä»¥å°†å…¶æå–ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ComposeråŒ…ã€‚è¿™å¯¹äºè¢«å¤šä¸ªé¡¹ç›®å¤ç”¨çš„æ ¸å¿ƒä¸šåŠ¡ï¼ˆå¦‚è®¤è¯ã€æ”¯ä»˜ï¼‰æˆ–å¤§å‹å›¢é˜Ÿåˆ†å·¥åä½œå°¤å…¶æœ‰ä»·å€¼ã€‚</p><p><strong>åŒ…å¼€å‘çš„å¥½å¤„</strong>:</p><ul><li><strong>å¼ºåˆ¶è§£è€¦</strong>: åŒ…åªèƒ½é€šè¿‡å…¶<code>ServiceProvider</code>å’Œæ˜ç¡®å®šä¹‰çš„å…¬å…±æ¥å£ä¸ä¸»åº”ç”¨äº¤äº’ï¼Œå®ç°äº†å¼ºå°è£…ã€‚</li><li><strong>ç‹¬ç«‹ç‰ˆæœ¬æ§åˆ¶</strong>: ä½ å¯ä»¥ç‹¬ç«‹åœ°å¯¹æ”¯ä»˜æ¨¡å—è¿›è¡Œç‰ˆæœ¬è¿­ä»£ï¼Œè€Œæ— éœ€é‡æ–°éƒ¨ç½²æ•´ä¸ªä¸»åº”ç”¨ã€‚</li><li><strong>ç‹¬ç«‹æµ‹è¯•</strong>: æ¯ä¸ªåŒ…éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æµ‹è¯•å¥—ä»¶ï¼Œå¯ä»¥æ›´å¿«åœ°è¿è¡Œã€‚</li><li><strong>ä»£ç å¤ç”¨</strong>: åŒä¸€ä¸ªæ”¯ä»˜åŒ…å¯ä»¥è¢«å…¬å¸çš„å¤šä¸ªé¡¹ç›®ä½¿ç”¨ã€‚</li></ul><p><strong>Laravel/SymfonyåŒ…å¼€å‘æµç¨‹æ¦‚è§ˆ</strong>:</p><ol><li><strong>åˆ›å»ºç›®å½•</strong>: åœ¨é¡¹ç›®æ ¹ç›®å½•å¤–åˆ›å»ºä¸€ä¸ªæ–°çš„åŒ…ç›®å½•ï¼Œå¦‚<code>packages/payment-gateway</code>ã€‚</li><li><strong><code>composer.json</code></strong>: åœ¨åŒ…ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª<code>composer.json</code>æ–‡ä»¶ï¼Œå®šä¹‰åŒ…åã€ä¾èµ–ã€PSR-4è‡ªåŠ¨åŠ è½½ç­‰ã€‚</li><li><strong>æœåŠ¡æä¾›è€… (Service Provider)</strong>: è¿™æ˜¯åŒ…çš„å…¥å£ã€‚åœ¨Laravelä¸­ï¼Œä½ ä¼šåˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª<code>Illuminate\\Support\\ServiceProvider</code>çš„ç±»ã€‚ <ul><li>åœ¨<code>register()</code>æ–¹æ³•ä¸­ï¼Œä½¿ç”¨<code>$this-&gt;app-&gt;bind()</code>æ¥ç»‘å®šåŒ…æä¾›çš„æœåŠ¡ã€‚</li><li>åœ¨<code>boot()</code>æ–¹æ³•ä¸­ï¼Œæ³¨å†Œè·¯ç”±ã€è§†å›¾ã€é…ç½®æ–‡ä»¶ã€æ•°æ®åº“è¿ç§»ç­‰ã€‚</li></ul></li><li><strong>æœ¬åœ°å¼€å‘</strong>: åœ¨ä¸»åº”ç”¨çš„<code>composer.json</code>ä¸­ï¼Œä½¿ç”¨<code>&quot;type&quot;: &quot;path&quot;</code>çš„<code>repositories</code>é…ç½®æ¥é“¾æ¥åˆ°æœ¬åœ°çš„åŒ…ç›®å½•ï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨æœ¬åœ°å®æ—¶å¼€å‘å’Œæµ‹è¯•åŒ…ï¼Œè€Œæ— éœ€å‘å¸ƒã€‚</li><li><strong>å‘å¸ƒ</strong>: å¼€å‘å®Œæˆåï¼Œä½ å¯ä»¥å°†å…¶å‘å¸ƒåˆ°Packagistï¼ˆå…¬å…±ï¼‰æˆ–Satis/Private Packagistï¼ˆç§æœ‰ï¼‰ä¾›é¡¹ç›®<code>require</code>ã€‚</li></ol><p>é€šè¿‡æ¨¡å—åŒ–å’ŒåŒ…å¼€å‘ï¼Œä½ å¯ä»¥å°†ä¸€ä¸ªåºå¤§ã€éš¾ä»¥ç»´æŠ¤çš„å•ä½“åº”ç”¨ï¼Œæ¼”è¿›ä¸ºä¸€ä¸ªç”±å¤šä¸ªå†…èšã€è§£è€¦ã€å¯ç‹¬ç«‹ç»´æŠ¤çš„æ¨¡å—ç»„æˆçš„â€œæ¨¡å—åŒ–å•ä½“â€æˆ–å¾®æœåŠ¡æ¶æ„ï¼Œä»è€Œä»å®¹åº”å¯¹ä¸šåŠ¡çš„å¢é•¿å’Œå˜åŒ–ã€‚</p><hr><hr><h3 id="ç¬¬ä¸‰éƒ¨åˆ†-ä¸“é¢˜æ·±æ½œ-topical-deep-dives-1" tabindex="-1">ç¬¬ä¸‰éƒ¨åˆ†ï¼šä¸“é¢˜æ·±æ½œ (Topical Deep Dives) <a class="header-anchor" href="#ç¬¬ä¸‰éƒ¨åˆ†-ä¸“é¢˜æ·±æ½œ-topical-deep-dives-1" aria-label="Permalink to &quot;ç¬¬ä¸‰éƒ¨åˆ†ï¼šä¸“é¢˜æ·±æ½œ (Topical Deep Dives)&quot;">â€‹</a></h3><h4 id="ç¬¬3ç« -æ¡†æ¶é«˜çº§åº”ç”¨ä¸åŸç†-ä»¥laravelä¸ºä¾‹" tabindex="-1">ç¬¬3ç« ï¼šæ¡†æ¶é«˜çº§åº”ç”¨ä¸åŸç† (ä»¥Laravelä¸ºä¾‹) <a class="header-anchor" href="#ç¬¬3ç« -æ¡†æ¶é«˜çº§åº”ç”¨ä¸åŸç†-ä»¥laravelä¸ºä¾‹" aria-label="Permalink to &quot;ç¬¬3ç« ï¼šæ¡†æ¶é«˜çº§åº”ç”¨ä¸åŸç† (ä»¥Laravelä¸ºä¾‹)&quot;">â€‹</a></h4><p>ä»…ä»…ä¼šä½¿ç”¨æ¡†æ¶æä¾›çš„åŠŸèƒ½æ˜¯ä¸å¤Ÿçš„ï¼Œæ·±å…¥ç†è§£å…¶æ ¸å¿ƒå·¥ä½œåŸç†ï¼Œå¹¶å­¦ä¼šå¦‚ä½•æ‰©å±•å®ƒï¼Œæ˜¯åŒºåˆ†ä¸­é«˜çº§å·¥ç¨‹å¸ˆçš„å…³é”®ã€‚æœ¬ç« ä»¥Laravelä¸ºä¾‹ï¼Œæ¢è®¨å…¶æœ€æ ¸å¿ƒçš„ç»„ä»¶â€”â€”æœåŠ¡å®¹å™¨ã€‚</p><h5 id="_3-1-æ·±å…¥æœåŠ¡å®¹å™¨-service-container" tabindex="-1">3.1 æ·±å…¥æœåŠ¡å®¹å™¨ (Service Container) <a class="header-anchor" href="#_3-1-æ·±å…¥æœåŠ¡å®¹å™¨-service-container" aria-label="Permalink to &quot;3.1 æ·±å…¥æœåŠ¡å®¹å™¨ (Service Container)&quot;">â€‹</a></h5><p>æœåŠ¡å®¹å™¨ï¼ˆä¹Ÿç§°IoCå®¹å™¨ï¼‰æ˜¯Laravelæ¡†æ¶çš„å¿ƒè„ã€‚å®ƒæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œç”¨äºç®¡ç†ç±»çš„ä¾èµ–å…³ç³»å’Œæ‰§è¡Œä¾èµ–æ³¨å…¥ã€‚ä½ ä¹‹å‰åœ¨åˆ†å±‚æ¶æ„ä¸­é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥<code>PostRepository</code>ï¼Œå…¶èƒŒåå°±æ˜¯æœåŠ¡å®¹å™¨åœ¨å·¥ä½œã€‚</p><p><strong>1. æ ¸å¿ƒæ¦‚å¿µï¼šç»‘å®š (Binding) ä¸è§£æ (Resolution)</strong></p><ul><li><p><strong>ç»‘å®š</strong>: å°±æ˜¯â€œå‘Šè¯‰â€å®¹å™¨å¦‚ä½•åˆ›å»ºæŸä¸ªç±»çš„å®ä¾‹ã€‚è¿™é€šå¸¸åœ¨<code>ServiceProvider</code>çš„<code>register</code>æ–¹æ³•ä¸­å®Œæˆã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// App/Providers/RepositoryServiceProvider.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> App\\Repository\\PostRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> App\\Repository\\Eloquent\\PostRepositoryImpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> register</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç»‘å®šæ¥å£åˆ°å…·ä½“å®ç°</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PostRepository</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PostRepositoryImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ç°åœ¨ï¼Œå®¹å™¨çŸ¥é“äº†å½“ä»»ä½•åœ°æ–¹éœ€è¦ä¸€ä¸ª<code>PostRepository</code>æ—¶ï¼Œå®ƒåº”è¯¥å»å®ä¾‹åŒ–ä¸€ä¸ª<code>PostRepositoryImpl</code>ã€‚</p></li><li><p><strong>è§£æ</strong>: å°±æ˜¯ä»å®¹å™¨ä¸­â€œè·å–â€ä¸€ä¸ªå®ä¾‹ã€‚è¿™å¯ä»¥æ‰‹åŠ¨å®Œæˆï¼Œä½†æ›´å¸¸è§çš„æ˜¯è‡ªåŠ¨å‘ç”Ÿã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ‰‹åŠ¨è§£æ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$repository </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PostRepository</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è‡ªåŠ¨è§£æï¼ˆä¾èµ–æ³¨å…¥ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PostRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $repository) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®¹å™¨è‡ªåŠ¨è§£æå¹¶æ³¨å…¥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">repository </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $repository;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å½“å®¹å™¨å®ä¾‹åŒ–ä¸€ä¸ªç±»æ—¶ï¼Œå®ƒä¼šé€šè¿‡åå°„æ£€æŸ¥å…¶æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œå¹¶è‡ªåŠ¨è§£æè¿™äº›ç±»å‹æç¤ºçš„ä¾èµ–é¡¹ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯é€’å½’çš„ï¼Œå¦‚æœ<code>PostRepositoryImpl</code>æœ¬èº«ä¹Ÿæœ‰ä¾èµ–ï¼Œå®¹å™¨ä¼šä¸€å¹¶è§£æã€‚</p></li></ul><p><strong>2. ç»‘å®šçš„ç”Ÿå‘½å‘¨æœŸ</strong></p><ul><li><p><strong><code>bind()</code> (ç¬æ—¶ç»‘å®š)</strong>: è¿™æ˜¯é»˜è®¤çš„ç»‘å®šæ–¹å¼ã€‚<strong>æ¯æ¬¡</strong>ä»å®¹å™¨ä¸­è§£ææ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ª<strong>æ–°çš„</strong>å®ä¾‹ã€‚é€‚ç”¨äºæ— çŠ¶æ€ã€è½»é‡çº§çš„å¯¹è±¡ã€‚</p></li><li><p><strong><code>singleton()</code> (å•ä¾‹ç»‘å®š)</strong>: <strong>ç¬¬ä¸€æ¬¡</strong>ä»å®¹å™¨ä¸­è§£ææ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹ä¼šè¢«ç¼“å­˜èµ·æ¥ã€‚ä¹‹å<strong>æ‰€æœ‰</strong>å¯¹è¯¥ç»‘å®šçš„è§£æè¯·æ±‚ï¼Œéƒ½ä¼šè¿”å›<strong>åŒä¸€ä¸ª</strong>ç¼“å­˜çš„å®ä¾‹ã€‚</p><p><strong>å®æˆ˜åº”ç”¨</strong>:</p><ul><li>æ•°æ®åº“è¿æ¥ã€Rediså®¢æˆ·ç«¯ç­‰æ˜‚è´µçš„è¿æ¥å¯¹è±¡ã€‚</li><li>åŠ è½½äº†å¤§é‡é…ç½®çš„å…¨å±€æœåŠ¡ã€‚</li><li>éœ€è¦è·¨è¯·æ±‚/ä½œä¸šå…±äº«çŠ¶æ€çš„å¯¹è±¡ï¼ˆéœ€è°¨æ…ï¼‰ã€‚</li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç»‘å®šä¸€ä¸ªå¤æ‚çš„æ”¯ä»˜ç½‘å…³å®¢æˆ·ç«¯ä¸ºå•ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PaymentGatewayClient</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($app) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PaymentGatewayClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;services.payment.secret&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div></li><li><p><strong><code>scoped()</code> (ä½œç”¨åŸŸå•ä¾‹ - Laravel 11+)</strong>: å®ä¾‹åœ¨å½“å‰â€œä½œç”¨åŸŸâ€ï¼ˆå¦‚ä¸€ä¸ªWebè¯·æ±‚ã€ä¸€ä¸ªé˜Ÿåˆ—Jobï¼‰å†…æ˜¯å•ä¾‹ï¼Œä½†æ–°çš„ä½œç”¨åŸŸä¼šåˆ›å»ºæ–°çš„å®ä¾‹ã€‚è¿™æ˜¯å¯¹<code>singleton</code>åœ¨é•¿ç”Ÿå‘½å‘¨æœŸåº”ç”¨ï¼ˆå¦‚Octaneï¼‰ä¸­çš„æ”¹è¿›ã€‚</p></li></ul><p><strong>3. é«˜çº§ç»‘å®šæŠ€å·§</strong></p><ul><li><p><strong>ä¸Šä¸‹æ–‡ç»‘å®š (Contextual Binding)</strong>: æœ‰æ—¶ï¼Œä¸¤ä¸ªä¸åŒçš„ç±»å¯èƒ½éœ€è¦åŒä¸€ä¸ªæ¥å£çš„ä¸åŒå®ç°ã€‚ä¸Šä¸‹æ–‡ç»‘å®šå…è®¸ä½ ä¸ºæ­¤è¿›è¡Œé…ç½®ã€‚</p><p><strong>å®æˆ˜åº”ç”¨</strong>: å‡è®¾<code>VideoController</code>ä¸Šä¼ è§†é¢‘åˆ°S3ï¼Œè€Œ<code>ReportController</code>ç”ŸæˆæŠ¥å‘Šåˆ°æœ¬åœ°ç£ç›˜ã€‚å®ƒä»¬éƒ½ä¾èµ–<code>Illuminate\\Contracts\\Filesystem\\Factory</code>ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// App/Providers/AppServiceProvider.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Illuminate\\Contracts\\Filesystem\\Factory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FilesystemFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ...</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">when</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">VideoController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">needs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FilesystemFactory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">give</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () =&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Storage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">disk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;s3&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">when</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ReportController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">needs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FilesystemFactory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">give</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () =&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Storage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">disk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;local&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div></li><li><p><strong>æ ‡ç­¾ (Tagging)</strong>: ä½ å¯ä»¥ç»™ä¸€ç»„ç›¸å…³çš„ç»‘å®šæ‰“ä¸ŠåŒä¸€ä¸ªâ€œæ ‡ç­¾â€ï¼Œç„¶åä¸€æ¬¡æ€§è§£æå‡ºæ‰€æœ‰è¢«æ ‡è®°çš„å®ä¾‹ã€‚</p><p><strong>å®æˆ˜åº”ç”¨</strong>: å‡è®¾ä½ æœ‰ä¸€ä¸ªæŠ¥è¡¨ç”Ÿæˆç³»ç»Ÿï¼Œæ”¯æŒå¤šç§å¯¼å‡ºæ ¼å¼ï¼ˆPDF, CSV, Excelï¼‰ï¼Œæ¯ç§æ ¼å¼éƒ½æ˜¯ä¸€ä¸ªå®ç°äº†<code>Exporter</code>æ¥å£çš„ç±»ã€‚</p><ul><li><p><strong>ç»‘å®šä¸æ‰“æ ‡ç­¾</strong>:</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PdfExporter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CsvExporter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PdfExporter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CsvExporter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;exporters&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li><li><p><strong>è§£ææ‰€æœ‰å¸¦æ ‡ç­¾çš„å®ä¾‹</strong>:</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åœ¨ä½ çš„æŠ¥è¡¨æœåŠ¡ä¸­</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> iterable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $exporters)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Laravel 11+ å¯ä»¥ç›´æ¥æ³¨å…¥</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // $this-&gt;exporters = app()-&gt;tagged(&#39;exporters&#39;); åœ¨æ—§ç‰ˆæœ¬ä¸­</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $format, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Report</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $report)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    foreach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">exporters </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $exporter) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($exporter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">supports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($format)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $exporter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($report);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Exception</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Unsupported format&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li></ul><p>è¿™ç§æ–¹å¼è®©ä½ å¯ä»¥åœ¨ä¸ä¿®æ”¹æ ¸å¿ƒæœåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ç®€å•åœ°æ·»åŠ æ–°çš„ç»‘å®šå’Œæ ‡ç­¾æ¥è½»æ¾æ‰©å±•ç³»ç»ŸåŠŸèƒ½ï¼ˆä¾‹å¦‚å¢åŠ <code>ExcelExporter</code>ï¼‰ï¼Œå®Œç¾ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</p></li></ul><p>æ·±å…¥ç†è§£å¹¶å–„ç”¨æœåŠ¡å®¹å™¨ï¼Œæ˜¯ç¼–å†™å‡ºçœŸæ­£çµæ´»ã€å¯æ‰©å±•ã€å¯æµ‹è¯•çš„Laravelåº”ç”¨çš„åŸºç¡€ã€‚</p><h5 id="_3-2-æ¡†æ¶çš„-é­”æ³•-æ¢ç§˜" tabindex="-1">3.2 æ¡†æ¶çš„â€œé­”æ³•â€æ¢ç§˜ <a class="header-anchor" href="#_3-2-æ¡†æ¶çš„-é­”æ³•-æ¢ç§˜" aria-label="Permalink to &quot;3.2 æ¡†æ¶çš„â€œé­”æ³•â€æ¢ç§˜&quot;">â€‹</a></h5><p>Laravelä»¥å…¶ä¼˜é›…ã€å¯Œæœ‰è¡¨ç°åŠ›çš„è¯­æ³•è€Œé—»åï¼Œä½†è¿™èƒŒåçš„ä¸€äº›â€œé­”æ³•â€ä¹Ÿå¸¸è¢«è¯¯è§£æˆ–æ‰¹è¯„ã€‚ç†è§£è¿™äº›â€œé­”æ³•â€çš„åŸç†ï¼Œèƒ½è®©ä½ æ›´è‡ªä¿¡åœ°ä½¿ç”¨å®ƒä»¬ï¼Œå¹¶æ¶ˆé™¤å¯¹å…¶â€œä¸ç¡®å®šæ€§â€çš„ææƒ§ã€‚</p><p><strong>1. Facades çš„å·¥ä½œåŸç†</strong></p><p>å½“ä½ è°ƒç”¨<code>Cache::get(&#39;key&#39;)</code>æ—¶ï¼Œçœ‹èµ·æ¥åƒä¸€ä¸ªé™æ€æ–¹æ³•è°ƒç”¨ï¼Œä½†PHPä¸­å¹¶æ²¡æœ‰<code>Cache</code>ç±»çš„é™æ€<code>get</code>æ–¹æ³•ã€‚è¿™å…¶å®æ˜¯ä¸€ä¸ªâ€œå‡è±¡â€ï¼Œå³<strong>Facadeï¼ˆé—¨é¢ï¼‰</strong>ã€‚</p><p>Facadeä¸ºä¸€ä¸ªåœ¨æœåŠ¡å®¹å™¨ä¸­æ³¨å†Œçš„<strong>éé™æ€</strong>å¯¹è±¡æä¾›äº†ä¸€ä¸ª<strong>é™æ€</strong>çš„è°ƒç”¨æ¥å£ã€‚</p><ul><li><p><strong><code>getFacadeAccessor()</code></strong>: æ¯ä¸ªFacadeç±»ï¼ˆå¦‚<code>Illuminate\\Support\\Facades\\Cache</code>ï¼‰éƒ½å¿…é¡»å®ç°<code>getFacadeAccessor()</code>æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯<strong>è¿”å›è¯¥Facadeåœ¨æœåŠ¡å®¹å™¨ä¸­çš„ç»‘å®šåç§°</strong>ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Illuminate\\Support\\Facades\\Cache.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getFacadeAccessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;cache&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¿™æ˜¯&#39;cache&#39;æœåŠ¡åœ¨å®¹å™¨ä¸­çš„key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p><strong><code>__callStatic()</code> é­”æœ¯æ–¹æ³•</strong>: å½“ä½ è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„é™æ€æ–¹æ³•ï¼ˆå¦‚<code>Cache::get()</code>ï¼‰æ—¶ï¼ŒPHPä¼šè°ƒç”¨<code>__callStatic()</code>é­”æœ¯æ–¹æ³•ã€‚Laravelçš„<code>Facade</code>åŸºç±»å®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼Œå…¶å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è°ƒç”¨<code>getFacadeAccessor()</code>è·å–æœåŠ¡åï¼ˆ<code>&#39;cache&#39;</code>ï¼‰ã€‚</li><li>ä½¿ç”¨<code>app(&#39;cache&#39;)</code>ä»æœåŠ¡å®¹å™¨ä¸­<strong>è§£æ</strong>å‡ºå®é™…çš„<code>CacheManager</code>å®ä¾‹ã€‚</li><li>å°†æ–¹æ³•è°ƒç”¨è½¬å‘ç»™è¿™ä¸ªè§£æå‡ºæ¥çš„å®ä¾‹ï¼Œå³<code>$cacheManager-&gt;get(&#39;key&#39;)</code>ã€‚</li></ol></li></ul><p>æ‰€ä»¥ï¼Œ<code>Cache::get(&#39;key&#39;)</code>æœ¬è´¨ä¸Šæ˜¯<code>app(&#39;cache&#39;)-&gt;get(&#39;key&#39;)</code>çš„è¯­æ³•ç³–ã€‚</p><ul><li><p><strong>æµ‹è¯•Facades</strong>: Facadesæœ€å¤§çš„äº‰è®®åœ¨äºæµ‹è¯•ã€‚æ‰¹è¯„è€…è®¤ä¸ºå®ƒéšè—äº†ä¾èµ–ã€‚ä½†Laravelæä¾›äº†éå¸¸ç®€å•çš„æµ‹è¯•æ–¹æ³•ï¼Œå®ƒå…è®¸ä½ ç”¨ä¸€ä¸ªMockå¯¹è±¡æ›¿æ¢æ‰å®¹å™¨ä¸­çš„å®é™…å¯¹è±¡ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Illuminate\\Support\\Facades\\Cache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test_it_can_get_data_from_cache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å‘Šè¯‰æ¡†æ¶ï¼Œæˆ‘ä»¬æœŸæœ›&#39;Cache&#39; Facadeçš„&#39;get&#39;æ–¹æ³•è¢«è°ƒç”¨ä¸€æ¬¡</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å¹¶ä¸”å½“ä»¥&#39;user:1&#39;ä¸ºå‚æ•°è°ƒç”¨æ—¶ï¼Œåº”è¿”å›ä¸€ä¸ªUserå®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Cache</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shouldReceive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;get&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">once</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user:1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">andReturn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;name&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Taylor&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ‰§è¡Œä½ çš„ä¸šåŠ¡ä»£ç ï¼Œå®ƒå†…éƒ¨ä¼šè°ƒç”¨ Cache::get(&#39;user:1&#39;)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">userService</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCachedUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">assertEquals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Taylor&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, $user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>shouldReceive</code>æ–¹æ³•ä¼šç”¨ä¸€ä¸ªMockery mockå¯¹è±¡æ›¿æ¢å®¹å™¨ä¸­çš„<code>cache</code>å®ä¾‹ï¼Œä½¿å¾—æµ‹è¯•å®Œå…¨éš”ç¦»ï¼Œé€Ÿåº¦é£å¿«ã€‚</p></li></ul><p><strong>2. Macros å’Œ Mixinsï¼šåŠ¨æ€æ‰©å±•æ¡†æ¶æ ¸å¿ƒåŠŸèƒ½</strong></p><p>Laravelä¸­è®¸å¤šæ ¸å¿ƒç±»ï¼ˆå¦‚<code>Str</code>, <code>Arr</code>, <code>Response</code>, <code>Request</code>ï¼‰éƒ½ä½¿ç”¨äº†<code>Macroable</code> Traitã€‚è¿™ä¸ªTraitå…è®¸ä½ åœ¨è¿è¡Œæ—¶å‘è¿™äº›ç±»åŠ¨æ€åœ°æ·»åŠ æ–°çš„æ–¹æ³•ã€‚</p><ul><li><p><strong>Macro</strong>: æ·»åŠ å•ä¸ªæ–¹æ³•ã€‚</p><p><strong>å®æˆ˜åº”ç”¨</strong>: å‡è®¾ä½ å¸Œæœ›åœ¨æ•´ä¸ªåº”ç”¨ä¸­ç»Ÿä¸€APIæˆåŠŸå“åº”çš„æ ¼å¼ã€‚ä½ å¯ä»¥åœ¨<code>AppServiceProvider</code>çš„<code>boot</code>æ–¹æ³•ä¸­ä¸º<code>Response</code>ç±»æ³¨å†Œä¸€ä¸ª<code>apiSuccess</code>å®ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// App/Providers/AppServiceProvider.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Illuminate\\Support\\Facades\\Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> boot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">macro</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;apiSuccess&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, $message </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;success&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, $statusCode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            &#39;message&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $message,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            &#39;data&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $data,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($response, $statusCode);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ç°åœ¨ï¼Œåœ¨ä½ çš„ä»»ä½•æ§åˆ¶å™¨ä¸­ï¼Œéƒ½å¯ä»¥è¿™æ ·è°ƒç”¨ï¼š <code>return response()-&gt;apiSuccess([&#39;user&#39; =&gt; $user]);</code></p></li><li><p><strong>Mixin</strong>: ä¸€æ¬¡æ€§æ·»åŠ ä¸€ä¸ªç±»ä¸­çš„æ‰€æœ‰å…¬å…±æ–¹æ³•ä½œä¸ºå®ã€‚</p><p><strong>å®æˆ˜åº”ç”¨</strong>: ä¸º<code>Str</code>ç±»æ·»åŠ ä¸€ç»„è‡ªå®šä¹‰çš„å­—ç¬¦ä¸²å¤„ç†æ–¹æ³•ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// App/Support/StrMixins.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StrMixins</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initials</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Closure</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $name)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // å®ç°è·å–å§“åé¦–å­—æ¯ç¼©å†™çš„é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isUuid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Closure</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $string)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> =&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isUuid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($string);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// App/Providers/AppServiceProvider.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Illuminate\\Support\\Str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> boot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mixin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\App\\Support\\StrMixins</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ç°åœ¨ä½ å¯ä»¥ç›´æ¥è°ƒç”¨<code>Str::initials(&#39;Taylor Otwell&#39;)</code>ã€‚</p></li></ul><p><strong>3. Pipeline æ¨¡å¼åœ¨ä¸­é—´ä»¶ä¸­çš„åº”ç”¨</strong></p><p>Laravelçš„ä¸­é—´ä»¶æ˜¯<strong>ç®¡é“æ¨¡å¼ï¼ˆPipeline Patternï¼‰</strong> çš„ä¸€ä¸ªå®Œç¾å®ç°ã€‚ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸ªæ´‹è‘±ï¼ŒHTTPè¯·æ±‚æ˜¯æ ¸å¿ƒï¼Œå®ƒå¿…é¡»ç©¿è¿‡ä¸€å±‚å±‚çš„æ´‹è‘±çš®ï¼ˆä¸­é—´ä»¶ï¼‰æ‰èƒ½åˆ°è¾¾æ ¸å¿ƒï¼ˆæ§åˆ¶å™¨ï¼‰ï¼Œç„¶åå“åº”åˆä»æ ¸å¿ƒç©¿å‡ºæ‰€æœ‰æ´‹è‘±çš®è¿”å›ç»™ç”¨æˆ·ã€‚</p><ul><li><p><strong><code>handle(Request $request, Closure $next)</code></strong>: æ¯ä¸ªä¸­é—´ä»¶çš„æ ¸å¿ƒæ˜¯<code>handle</code>æ–¹æ³•ã€‚<code>$request</code>æ˜¯è¯·æ±‚å¯¹è±¡ï¼Œè€Œ<code>$next</code>æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä»£è¡¨<strong>ç®¡é“ä¸­çš„ä¸‹ä¸€ä¸ªç¯èŠ‚</strong>ã€‚</p></li><li><p><strong>æ´‹è‘±æ¨¡å‹</strong>: è°ƒç”¨<code>$response = $next($request);</code>å°±æ˜¯å°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€å±‚ä¸­é—´ä»¶ã€‚è¿™è¡Œä»£ç æ˜¯è¯·æ±‚æµå‘å’Œå“åº”æµå‘çš„åˆ†ç•Œç‚¹ã€‚</p><ul><li><strong>åœ¨è¿™è¡Œä»£ç ä¹‹å‰</strong>æ‰§è¡Œçš„é€»è¾‘ï¼Œæ˜¯åœ¨â€œè¯·æ±‚è¿›å…¥æ—¶â€æ‰§è¡Œã€‚</li><li><strong>åœ¨è¿™è¡Œä»£ç ä¹‹å</strong>æ‰§è¡Œçš„é€»è¾‘ï¼Œæ˜¯åœ¨â€œå“åº”è¿”å›æ—¶â€æ‰§è¡Œã€‚</li></ul></li></ul><p><strong>å®æˆ˜åº”ç”¨ï¼šä¸€ä¸ªè®°å½•è¯·æ±‚è€—æ—¶çš„ä¸­é—´ä»¶</strong></p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// App/Http/Middleware/RequestDurationLogMiddleware.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RequestDurationLogMiddleware</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> LoggerInterface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $logger) {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $request, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Closure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $next)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Response</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> microtime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1. è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–æ§åˆ¶å™¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $next($request);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2. è·å¾—å“åº”åï¼Œæ‰§è¡Œè¿™é‡Œçš„é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $duration </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">microtime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $start) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sprintf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            &#39;[%s] %s | %dms&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            $request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">method</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            $request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            $duration</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $response;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>è¿™ä¸ªä¸­é—´ä»¶æ¸…æ™°åœ°å±•ç¤ºäº†â€œæ´‹è‘±â€æ¨¡å‹ï¼šåœ¨è¯·æ±‚è¿›å…¥æ—¶è®°å½•èµ·å§‹æ—¶é—´ï¼Œåœ¨æ‰€æœ‰å†…éƒ¨é€»è¾‘ï¼ˆåŒ…æ‹¬æ§åˆ¶å™¨ï¼‰æ‰§è¡Œå®Œæ¯•ã€å“åº”ç”Ÿæˆä¹‹åï¼Œè®¡ç®—æ€»è€—æ—¶å¹¶è®°å½•æ—¥å¿—ã€‚</p><hr><hr><h4 id="ç¬¬4ç« -é«˜æ€§èƒ½apiè®¾è®¡ä¸å®ç°" tabindex="-1">ç¬¬4ç« ï¼šé«˜æ€§èƒ½APIè®¾è®¡ä¸å®ç° <a class="header-anchor" href="#ç¬¬4ç« -é«˜æ€§èƒ½apiè®¾è®¡ä¸å®ç°" aria-label="Permalink to &quot;ç¬¬4ç« ï¼šé«˜æ€§èƒ½APIè®¾è®¡ä¸å®ç°&quot;">â€‹</a></h4><h5 id="_4-1-api-è®¾è®¡å“²å­¦" tabindex="-1">4.1 API è®¾è®¡å“²å­¦ <a class="header-anchor" href="#_4-1-api-è®¾è®¡å“²å­¦" aria-label="Permalink to &quot;4.1 API è®¾è®¡å“²å­¦&quot;">â€‹</a></h5><p>æ„å»ºAPIä¸ä»…ä»…æ˜¯è®©æ•°æ®èƒ½é€šè¿‡HTTPè®¿é—®ã€‚ä¸€ä¸ªä¼˜ç§€çš„APIåº”è¯¥å…·å¤‡è‰¯å¥½çš„å¼€å‘è€…ä½“éªŒï¼šå¯é¢„æµ‹ã€æ˜“äºç†è§£ã€æ–‡æ¡£æ¸…æ™°ã€‚</p><p><strong>1. è¶…è¶ŠRESTï¼šGraphQL ä¸ gRPC</strong></p><p>è™½ç„¶RESTæ˜¯Web APIçš„äº‹å®æ ‡å‡†ï¼Œä½†åœ¨ç‰¹å®šåœºæ™¯ä¸‹ï¼Œå…¶ä»–æ¨¡å¼å¯èƒ½æ›´ä¼˜è¶Šã€‚</p><ul><li><p><strong>GraphQL</strong>: ä¸€ç§ä¸ºAPIè€Œç”Ÿçš„æŸ¥è¯¢è¯­è¨€ã€‚</p><ul><li><strong>æ ¸å¿ƒæ€æƒ³</strong>: å®¢æˆ·ç«¯ç²¾ç¡®åœ°è¯·æ±‚å®ƒæ‰€éœ€è¦çš„æ•°æ®ï¼Œä¸å¤šä¹Ÿä¸å°‘ã€‚è§£å†³äº†RESTä¸­å¸¸è§çš„â€œè¿‡åº¦è·å–â€ï¼ˆOver-fetchingï¼‰å’Œâ€œè·å–ä¸è¶³â€ï¼ˆUnder-fetchingï¼‰é—®é¢˜ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: <ul><li><strong>å¤æ‚å‰ç«¯/ç§»åŠ¨ç«¯</strong>: å½“ä¸€ä¸ªé¡µé¢éœ€è¦æ¥è‡ªå¤šä¸ªã€ç›¸äº’å…³è”çš„èµ„æºçš„æ•°æ®æ—¶ï¼ŒGraphQLå¯ä»¥é€šè¿‡ä¸€æ¬¡è¯·æ±‚è·å–æ‰€æœ‰æ•°æ®ï¼Œè€ŒRESTå¯èƒ½éœ€è¦å¤šæ¬¡å¾€è¿”ã€‚</li><li><strong>å¤šå˜çš„éœ€æ±‚</strong>: å‰ç«¯éœ€æ±‚é¢‘ç¹å˜åŒ–æ—¶ï¼Œåç«¯æ— éœ€åˆ›å»ºæ–°çš„RESTç«¯ç‚¹ï¼Œå‰ç«¯åªéœ€ä¿®æ”¹æŸ¥è¯¢è¯­å¥å³å¯ã€‚</li></ul></li><li><strong>PHPç”Ÿæ€</strong>: <code>webonyx/graphql-php</code> (æ ¸å¿ƒåº“), <code>lighthouse-php</code> (Laravelé›†æˆ)ã€‚</li></ul></li><li><p><strong>gRPC</strong>: Googleå¼€å‘çš„é«˜æ€§èƒ½è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æ¶ã€‚</p><ul><li><strong>æ ¸å¿ƒæ€æƒ³</strong>: ä½¿ç”¨<strong>Protocol Buffers</strong>ä½œä¸ºæ¥å£å®šä¹‰è¯­è¨€ï¼ˆIDLï¼‰å’Œåºåˆ—åŒ–æ ¼å¼ï¼Œå¹¶åŸºäº<strong>HTTP/2</strong>è¿›è¡Œä¼ è¾“ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: <ul><li><strong>å¾®æœåŠ¡é—´é€šä¿¡</strong>: åœ¨å†…éƒ¨ç½‘ç»œä¸­ï¼Œå¯¹æ€§èƒ½å’Œä½å»¶è¿Ÿè¦æ±‚æé«˜çš„æœåŠ¡é—´è°ƒç”¨ã€‚</li><li><strong>éœ€è¦ä¸¥æ ¼å¥‘çº¦çš„åœºæ™¯</strong>: Protocol Bufferså¼ºåˆ¶å®šä¹‰äº†æœåŠ¡å’Œæ¶ˆæ¯çš„ç±»å‹ï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆå¤šè¯­è¨€çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç å­˜æ ¹ï¼ˆstubï¼‰ã€‚</li></ul></li><li><strong>PHPç”Ÿæ€</strong>: éœ€è¦<code>grpc</code> PECLæ‰©å±•å’Œ<code>google/protobuf</code>åº“ã€‚RoadRunnerå¯¹gRPCæœ‰å¾ˆå¥½çš„åŸç”Ÿæ”¯æŒã€‚</li></ul></li></ul><p><strong>2. APIç‰ˆæœ¬æ§åˆ¶ç­–ç•¥</strong></p><p>å½“ä½ çš„APIéœ€è¦è¿›è¡Œä¸å…¼å®¹çš„å˜æ›´æ—¶ï¼Œç‰ˆæœ¬æ§åˆ¶æ˜¯å¿…é¡»çš„ã€‚</p><ul><li><p><strong>URLç‰ˆæœ¬æ§åˆ¶ (æœ€å¸¸ç”¨)</strong>: <code>https://api.example.com/v1/users</code></p><ul><li><strong>ä¼˜ç‚¹</strong>: éå¸¸ç›´è§‚ï¼Œæ˜“äºç†è§£å’Œå®ç°ã€‚å¼€å‘è€…å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è½»æ¾æµ‹è¯•ä¸åŒç‰ˆæœ¬ã€‚è·¯ç”±å’Œç¼“å­˜ç­–ç•¥ç®€å•ã€‚</li><li><strong>ç¼ºç‚¹</strong>: â€œæ±¡æŸ“â€äº†URLï¼ŒURLä¸å†å•å•æŒ‡å‘ä¸€ä¸ªèµ„æºã€‚</li></ul></li><li><p><strong>Headerç‰ˆæœ¬æ§åˆ¶</strong>: é€šè¿‡HTTP Headeræ¥æŒ‡å®šç‰ˆæœ¬ï¼Œé€šå¸¸æ˜¯<code>Accept</code>å¤´ã€‚ <code>Accept: application/vnd.yourapi.v1+json</code></p><ul><li><strong>ä¼˜ç‚¹</strong>: ä¿æŒURLçš„çº¯å‡€ã€‚è¢«ä¸€äº›RESTç†è®ºå®¶è®¤ä¸ºæ˜¯â€œæ›´æ­£ç¡®â€çš„æ–¹å¼ã€‚</li><li><strong>ç¼ºç‚¹</strong>: å¯¹å¼€å‘è€…ä¸ç›´è§‚ï¼Œæ— æ³•é€šè¿‡æµè§ˆå™¨ç›´æ¥æµ‹è¯•ã€‚å®¢æˆ·ç«¯å®ç°æ›´å¤æ‚ã€‚</li></ul></li></ul><p><strong>å»ºè®®</strong>: å¯¹äºç»å¤§å¤šæ•°é¡¹ç›®ï¼Œ<strong>URLç‰ˆæœ¬æ§åˆ¶</strong>å› å…¶ç®€å•å’Œæ˜ç¡®æ€§è€Œæˆä¸ºæœ€ä½³é€‰æ‹©ã€‚</p><hr><h5 id="_4-2-è®¤è¯ä¸æˆæƒæ–¹æ¡ˆ" tabindex="-1">4.2 è®¤è¯ä¸æˆæƒæ–¹æ¡ˆ <a class="header-anchor" href="#_4-2-è®¤è¯ä¸æˆæƒæ–¹æ¡ˆ" aria-label="Permalink to &quot;4.2 è®¤è¯ä¸æˆæƒæ–¹æ¡ˆ&quot;">â€‹</a></h5><ul><li><strong>è®¤è¯ (Authentication)</strong>: ç¡®è®¤â€œä½ æ˜¯è°â€ã€‚</li><li><strong>æˆæƒ (Authorization)</strong>: ç¡®è®¤â€œä½ èƒ½åšä»€ä¹ˆâ€ã€‚</li></ul><p><strong>1. é¢å‘å•é¡µåº”ç”¨(SPA)å’Œç§»åŠ¨ç«¯ï¼šTokenè®¤è¯</strong></p><p>å¯¹äºå‰åç«¯åˆ†ç¦»çš„åº”ç”¨ï¼Œä¼ ç»Ÿçš„Sessionè®¤è¯ä¸å†é€‚ç”¨ã€‚åŸºäºTokençš„è®¤è¯æ˜¯ä¸»æµã€‚</p><ul><li><strong>Laravel Sanctum</strong>: ä¸ºSPAå’Œç§»åŠ¨åº”ç”¨æä¾›äº†è½»é‡çº§çš„è®¤è¯è§£å†³æ–¹æ¡ˆã€‚ <ul><li><strong>SPAè®¤è¯ (åŸºäºCookie)</strong>: å¦‚æœä½ çš„SPAå’ŒAPIéƒ¨ç½²åœ¨åŒä¸€ä¸ªä¸»åŸŸåä¸‹ï¼ŒSanctumå¯ä»¥ä½¿ç”¨Laravelçš„å†…ç½®Cookie sessionè®¤è¯ï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç†CSRFä¿æŠ¤ï¼Œæ¯”æ‰‹åŠ¨ç®¡ç†Tokenæ›´ç®€å•ã€æ›´å®‰å…¨ã€‚</li><li><strong>API Tokenè®¤è¯</strong>: å¯¹äºç§»åŠ¨Appæˆ–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ŒSanctumå…è®¸ä½ ä¸ºç”¨æˆ·é¢å‘API Tokenã€‚ <ol><li>ç”¨æˆ·é€šè¿‡ç”¨æˆ·åå¯†ç ç™»å½•ï¼ŒæœåŠ¡å™¨éªŒè¯é€šè¿‡åï¼Œä¸ºè¯¥ç”¨æˆ·ç”Ÿæˆä¸€ä¸ªTokenã€‚ <code>$token = $user-&gt;createToken(&#39;my-app-token&#39;)-&gt;plainTextToken;</code></li><li>æœåŠ¡å™¨å°†Tokenè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯éœ€è¦å®‰å…¨åœ°å­˜å‚¨å®ƒã€‚</li><li>åœ¨åç»­çš„æ¯æ¬¡è¯·æ±‚ä¸­ï¼Œå®¢æˆ·ç«¯éƒ½å¿…é¡»åœ¨<code>Authorization</code>å¤´ä¸­æºå¸¦è¿™ä¸ªTokenã€‚ <code>Authorization: Bearer &lt;token&gt;</code></li><li>Laravelé€šè¿‡ä¸­é—´ä»¶è‡ªåŠ¨éªŒè¯è¿™ä¸ªTokenå¹¶è®¤è¯ç”¨æˆ·ã€‚</li></ol></li></ul></li></ul><p><strong>2. é¢å‘æœåŠ¡é—´/ç¬¬ä¸‰æ–¹åº”ç”¨ï¼šOAuth 2.0</strong></p><p>OAuth 2.0ä¸æ˜¯ä¸€ä¸ªè®¤è¯åè®®ï¼Œè€Œæ˜¯ä¸€ä¸ª<strong>æˆæƒæ¡†æ¶</strong>ã€‚å®ƒå…è®¸ä¸€ä¸ªåº”ç”¨ï¼ˆClientï¼‰åœ¨ä¸è·å–ç”¨æˆ·å¯†ç çš„æƒ…å†µä¸‹ï¼Œè·å–è®¿é—®ç”¨æˆ·åœ¨å¦ä¸€ä¸ªæœåŠ¡å™¨ä¸Šèµ„æºçš„æƒé™ã€‚</p><ul><li><p><strong>æ ¸å¿ƒæµç¨‹ (Grant Types)</strong>:</p><ul><li><strong>Authorization Code (æˆæƒç æ¨¡å¼)</strong>: æœ€å¸¸ç”¨ã€æœ€å®‰å…¨çš„æ¨¡å¼ï¼Œé€‚ç”¨äºä¼ ç»Ÿçš„Webåº”ç”¨ã€‚ <ol><li>ä½ çš„åº”ç”¨å°†ç”¨æˆ·é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨ï¼ˆå¦‚Google, GitHubï¼‰ã€‚</li><li>ç”¨æˆ·åœ¨æˆæƒæœåŠ¡å™¨ä¸Šç™»å½•å¹¶åŒæ„æˆæƒã€‚</li><li>æˆæƒæœåŠ¡å™¨å°†ç”¨æˆ·é‡å®šå‘å›ä½ çš„åº”ç”¨ï¼Œå¹¶é™„å¸¦ä¸€ä¸ªä¸€æ¬¡æ€§çš„<code>code</code>ã€‚</li><li>ä½ çš„åº”ç”¨åœ¨åç«¯ç”¨è¿™ä¸ª<code>code</code>å‘æˆæƒæœåŠ¡å™¨æ¢å–ä¸€ä¸ª<code>access_token</code>ã€‚</li><li>ä½¿ç”¨<code>access_token</code>å»è®¿é—®å—ä¿æŠ¤çš„èµ„æºã€‚</li></ol></li><li><strong>Client Credentials (å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼)</strong>: é€‚ç”¨äºæ²¡æœ‰ç”¨æˆ·å‚ä¸çš„æœºå™¨åˆ°æœºå™¨ï¼ˆM2Mï¼‰é€šä¿¡ã€‚å®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨è‡ªå·±çš„<code>client_id</code>å’Œ<code>client_secret</code>å‘æˆæƒæœåŠ¡å™¨è·å–<code>access_token</code>ã€‚</li></ul></li><li><p><strong>PHPå®ç°</strong>:</p><ul><li><strong><code>league/oauth2-server</code></strong>: è¿™æ˜¯PHPç¤¾åŒºå®ç°OAuth 2.0æœåŠ¡å™¨çš„äº‹å®æ ‡å‡†åº“ï¼Œä½†é…ç½®ç›¸å¯¹å¤æ‚ã€‚</li><li><strong>Laravel Passport</strong>: å®ƒæ˜¯<code>league/oauth2-server</code>çš„ä¸€ä¸ªå®Œæ•´ã€æ˜“äºå®‰è£…å’Œé…ç½®çš„Laravelå°è£…ã€‚å¦‚æœä½ éœ€è¦åœ¨ä½ çš„Laravelåº”ç”¨ä¸­æ„å»ºä¸€ä¸ªåŠŸèƒ½é½å…¨çš„OAuth 2.0æœåŠ¡å™¨ï¼ŒPassportæ˜¯é¦–é€‰ã€‚å®ƒä¸ºä½ å¤„ç†äº†æ‰€æœ‰å¤æ‚çš„æµç¨‹ï¼Œè®©ä½ èƒ½å¿«é€Ÿæ­å»ºèµ·Tokené¢å‘ã€åˆ·æ–°ã€åŠé”€ç­‰åŠŸèƒ½ã€‚</li></ul></li></ul><h5 id="_4-3-æ€§èƒ½ä¼˜åŒ–" tabindex="-1">4.3 æ€§èƒ½ä¼˜åŒ– <a class="header-anchor" href="#_4-3-æ€§èƒ½ä¼˜åŒ–" aria-label="Permalink to &quot;4.3 æ€§èƒ½ä¼˜åŒ–&quot;">â€‹</a></h5><p>ä¸€ä¸ªé«˜æ€§èƒ½çš„APIä¸ä»…ä»£ç æ‰§è¡Œè¦å¿«ï¼Œç½‘ç»œä¼ è¾“å’Œå®¢æˆ·ç«¯çš„ç­‰å¾…ä¹Ÿéœ€è¦è¢«ä¼˜åŒ–ã€‚</p><p><strong>1. HTTPç¼“å­˜: ETag ä¸ <code>Last-Modified</code></strong></p><p>HTTPç¼“å­˜æ˜¯å‡å°‘ä¸å¿…è¦æ•°æ®ä¼ è¾“ã€é™ä½æœåŠ¡å™¨è´Ÿè½½çš„åˆ©å™¨ã€‚å…¶æ ¸å¿ƒæ˜¯è®©å®¢æˆ·ç«¯ï¼ˆå¦‚æµè§ˆå™¨æˆ–Appï¼‰å¯ä»¥éªŒè¯æœ¬åœ°ç¼“å­˜çš„èµ„æºæ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼Œå¦‚æœæœ‰æ•ˆï¼ŒæœåŠ¡å™¨åˆ™æ— éœ€å‘é€å®Œæ•´çš„å“åº”ä½“ã€‚</p><ul><li><p><strong><code>Last-Modified</code></strong>: æœåŠ¡å™¨åœ¨å“åº”å¤´ä¸­å‘Šè¯‰å®¢æˆ·ç«¯èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´ã€‚ <code>Last-Modified: Tue, 15 Sep 2025 12:00:00 GMT</code> å®¢æˆ·ç«¯åœ¨ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œä¼šå¸¦ä¸Š<code>If-Modified-Since</code>å¤´ã€‚å¦‚æœæœåŠ¡å™¨å‘ç°èµ„æºåœ¨æ­¤æ—¶é—´åæœªè¢«ä¿®æ”¹ï¼Œåˆ™è¿”å›ä¸€ä¸ª<code>304 Not Modified</code>çŠ¶æ€ç å’Œç©ºå“åº”ä½“ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯ä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚</p></li><li><p><strong>ETag (Entity Tag)</strong>: <code>Last-Modified</code>çš„ç²¾åº¦åªèƒ½åˆ°ç§’ï¼Œä¸”æ— æ³•åæ˜ å†…å®¹æœªå˜ä½†æ–‡ä»¶æ—¶é—´æˆ³å˜åŒ–çš„åœºæ™¯ã€‚ETagæ˜¯æ›´å¼ºå¤§ã€æ›´ç²¾ç¡®çš„æ›¿ä»£æ–¹æ¡ˆã€‚å®ƒæ˜¯ä¸€ä¸ªä»£è¡¨èµ„æºå½“å‰çŠ¶æ€çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆé€šå¸¸æ˜¯å†…å®¹çš„å“ˆå¸Œå€¼ï¼‰ã€‚ <code>ETag: &quot;abcde12345&quot; å®¢æˆ·ç«¯åœ¨ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œä¼šå¸¦ä¸Š</code>If-None-Match<code>å¤´ã€‚æœåŠ¡å™¨æ¯”è¾ƒå®¢æˆ·ç«¯çš„ETagå’Œå½“å‰èµ„æºçš„ETagï¼Œå¦‚æœä¸€è‡´ï¼ŒåŒæ ·è¿”å›</code>304 Not Modified\`ã€‚</p></li></ul><p><strong>å®æˆ˜åº”ç”¨ï¼šåœ¨Laravelä¸­é—´ä»¶ä¸­å®ç°ETag</strong></p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// App/Http/Middleware/EtagMiddleware.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> EtagMiddleware</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $request, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Closure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $next)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åªå¯¹GETå’ŒHEADè¯·æ±‚åº”ç”¨ETag</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;get&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;head&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $next($request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $next($request);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ç”ŸæˆETag (ç®€å•çš„md5)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $etag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> md5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setEtag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($etag);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ£€æŸ¥å®¢æˆ·ç«¯çš„If-None-Matchå¤´æ˜¯å¦ä¸æˆ‘ä»¬çš„ETagåŒ¹é…</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // setEtagæ–¹æ³•å†…éƒ¨å·²ç»åŒ…å«äº†è¿™ä¸ªæ£€æŸ¥é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å¦‚æœåŒ¹é…ï¼ŒLaravelä¼šè‡ªåŠ¨å°†å“åº”è®¾ç½®ä¸º304 Not Modified</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æˆ‘ä»¬åªéœ€è¿”å›å“åº”å³å¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $response;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å°†è¿™ä¸ªä¸­é—´ä»¶åº”ç”¨åˆ°ä½ çš„APIè·¯ç”±ç»„ï¼Œå³å¯è½»æ¾å¯ç”¨ETagç¼“å­˜ã€‚</p><p><strong>2. APIèµ„æºå±‚çš„é«˜çº§ç”¨æ³•</strong></p><p>Laravelçš„API Resources (å¦‚<code>UserResource</code>) æ˜¯è½¬æ¢æ¨¡å‹ä¸ºJSONçš„å¼ºå¤§å·¥å…·ã€‚å–„ç”¨å…¶é«˜çº§ç‰¹æ€§å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½å’Œçµæ´»æ€§ã€‚</p><ul><li><p><strong>æ¡ä»¶å±æ€§ (<code>when</code>, <code>mergeWhen</code>)</strong>: æ ¹æ®æ¡ä»¶åŠ¨æ€æ·»åŠ å­—æ®µåˆ°å“åº”ä¸­ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// UserResource.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> toArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($request)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> array</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;id&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;name&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åªæœ‰å½“ç”¨æˆ·æ˜¯ç®¡ç†å‘˜æ—¶ï¼Œæ‰æ˜¾ç¤ºemailå­—æ®µ</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;email&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">when</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isAdmin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">email),</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åˆå¹¶ç®¡ç†å‘˜ä¸“å±çš„å…ƒæ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mergeWhen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isAdmin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            &#39;created_at&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">created_at,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            &#39;updated_at&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">updated_at,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ]),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p><strong>é˜²æ­¢N+1é—®é¢˜ (<code>whenLoaded</code>)</strong>: è¿™æ˜¯æœ€é‡è¦çš„æ€§èƒ½æŠ€å·§ä¹‹ä¸€ã€‚<code>whenLoaded</code>ç¡®ä¿åªæœ‰åœ¨å…³ç³»è¢«<strong>é¢„åŠ è½½ (eager-loaded)</strong> çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šå°†å…¶åŒ…å«åœ¨å“åº”ä¸­ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åœ¨Resourceä¸­</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;posts&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PostResource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">collection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">whenLoaded</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;posts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åœ¨æ§åˆ¶å™¨ä¸­</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é”™è¯¯çš„æ–¹å¼ï¼Œä¼šå¯¼è‡´N+1æŸ¥è¯¢</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserResource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">collection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($users);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ­£ç¡®çš„æ–¹å¼ï¼Œä½¿ç”¨é¢„åŠ è½½</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;posts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserResource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">collection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($users);</span></span></code></pre></div><p><code>whenLoaded</code>ä¼šâ€œæƒ©ç½šâ€æ²¡æœ‰è¿›è¡Œé¢„åŠ è½½çš„æŸ¥è¯¢ï¼Œå› ä¸ºå®ƒä¸ä¼šåœ¨å“åº”ä¸­æ˜¾ç¤º<code>posts</code>ï¼Œä»è€Œè¿«ä½¿å¼€å‘è€…å…»æˆé¢„åŠ è½½çš„å¥½ä¹ æƒ¯ã€‚</p></li><li><p><strong>ç¨€ç–å­—æ®µé›† (Sparse Fieldsets)</strong>: å…è®¸APIæ¶ˆè´¹è€…é€šè¿‡æŸ¥è¯¢å‚æ•°åªè¯·æ±‚ä»–ä»¬éœ€è¦çš„å­—æ®µï¼Œè¿›ä¸€æ­¥å‡å°‘å“åº”ä½“ç§¯ã€‚ <code>GET /api/users/1?fields[users]=id,name</code></p></li></ul><p><strong>3. ä½¿ç”¨OpenAPI (Swagger) è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£</strong></p><p>è¿‡æ—¶çš„æ–‡æ¡£æ˜¯APIå¼€å‘è€…çš„å™©æ¢¦ã€‚é€šè¿‡ä»£ç ä¼˜å…ˆçš„æ–¹å¼ç”Ÿæˆæ–‡æ¡£å¯ä»¥ä¸€åŠ³æ°¸é€¸ã€‚</p><ul><li><strong>OpenAPI (Swagger)</strong>: æ˜¯ä¸€ä¸ªæè¿°RESTful APIçš„è¯­è¨€æ— å…³è§„èŒƒã€‚</li><li><strong>PHPå®ç°</strong>: <ul><li><code>darkaonline/l5-swagger</code> (Laravel): ä¸€ä¸ªæµè¡Œçš„åŒ…ï¼Œå¯ä»¥é€šè¿‡PHPDocæ³¨è§£æˆ–PHP 8 Attributesæ¥æè¿°ä½ çš„APIã€‚</li><li><code>zircote/swagger-php</code>: æ›´é€šç”¨çš„åº“ï¼Œå¯ä»¥é›†æˆåˆ°ä»»ä½•PHPé¡¹ç›®ä¸­ã€‚</li></ul></li></ul><p><strong>å®æˆ˜åº”ç”¨ï¼šä½¿ç”¨Attributeå®šä¹‰APIç«¯ç‚¹</strong></p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// UserController.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OpenApi\\Attributes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OA\\Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">title</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;My API&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Controller</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OA\\Get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/api/users/{id}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        summary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Find user by ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        parameters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OA\\Parameter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;path&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">required</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OA\\Schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;integer&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ],</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        responses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OA\\Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Successful operation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OA\\Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">404</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;User not found&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> show</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>é€šè¿‡ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œè¿™äº›Attributeä¼šè¢«è§£æå¹¶ç”Ÿæˆä¸€ä¸ª<code>openapi.json</code>æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶å¯ä»¥ï¼š</p><ol><li>è¢«<strong>Swagger UI</strong>æˆ–<strong>Redoc</strong>ç­‰å·¥å…·æ¸²æŸ“æˆæ¼‚äº®çš„ã€å¯äº¤äº’çš„APIæ–‡æ¡£ã€‚</li><li>è¢«<strong>OpenAPI Generator</strong>ç­‰ä»£ç ç”Ÿæˆå™¨ç”¨æ¥è‡ªåŠ¨åˆ›å»ºå¤šè¯­è¨€ï¼ˆTypeScript, Java, Go...ï¼‰çš„å®¢æˆ·ç«¯SDKï¼Œæå¤§åœ°æå‡äº†APIæ¶ˆè´¹è€…çš„å¼€å‘æ•ˆç‡ã€‚</li></ol><h5 id="_4-4-api-å®‰å…¨åŠ å›º" tabindex="-1">4.4 API å®‰å…¨åŠ å›º <a class="header-anchor" href="#_4-4-api-å®‰å…¨åŠ å›º" aria-label="Permalink to &quot;4.4 API å®‰å…¨åŠ å›º&quot;">â€‹</a></h5><p>åŠŸèƒ½å’Œæ€§èƒ½å¦‚æœå»ºç«‹åœ¨è„†å¼±çš„å®‰å…¨ä¹‹ä¸Šï¼Œå°†å˜å¾—æ¯«æ— æ„ä¹‰ã€‚é™¤äº†è®¤è¯å’Œæˆæƒï¼Œä»¥ä¸‹å‡ ç‚¹æ˜¯æ„å»ºå¥å£®APIæ—¶å¿…é¡»è€ƒè™‘çš„ã€‚</p><ul><li><p><strong>é˜²èŒƒæ‰¹é‡èµ‹å€¼ (Preventing Mass Assignment)</strong>: è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„æ¼æ´ï¼Œç”¨æˆ·é€šè¿‡è¯·æ±‚ä¼ é€’éé¢„æœŸçš„å­—æ®µï¼Œä»è€Œä¿®æ”¹äº†ä»–ä»¬æœ¬ä¸è¯¥æœ‰æƒé™ä¿®æ”¹çš„æ•°æ®ï¼ˆå¦‚<code>is_admin</code>å­—æ®µï¼‰ã€‚</p><ul><li><strong>è§£å†³æ–¹æ¡ˆ</strong>: åœ¨ä½ çš„Eloquentæ¨¡å‹ä¸­ï¼Œæ˜ç¡®ä½¿ç”¨<code>$fillable</code>å±æ€§æ¥ç™½åå•å¯è¢«æ‰¹é‡èµ‹å€¼çš„å­—æ®µã€‚æ°¸è¿œä¸è¦å›¾çœäº‹ä½¿ç”¨<code>$guarded = []</code>ã€‚<div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Model</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åªå…è®¸name, email, passwordè¢«æ‰¹é‡å¡«å……</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $fillable </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;email&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;password&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li></ul></li><li><p><strong>APIé€Ÿç‡é™åˆ¶ (Rate Limiting)</strong>: ä¸ºäº†é˜²æ­¢æ¶æ„ç”¨æˆ·é€šè¿‡é«˜é¢‘è¯·æ±‚æš´åŠ›ç ´è§£å¯†ç æˆ–å¯¹ä½ çš„æœåŠ¡è¿›è¡ŒDoSæ”»å‡»ï¼Œå¿…é¡»è¿›è¡Œé€Ÿç‡é™åˆ¶ã€‚</p><ul><li><strong>è§£å†³æ–¹æ¡ˆ</strong>: Laravelå†…ç½®äº†å¼ºå¤§çš„<code>throttle</code>ä¸­é—´ä»¶ã€‚ä½ å¯ä»¥è½»æ¾åœ°åœ¨è·¯ç”±ä¸­å®šä¹‰å®ƒã€‚<div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// routes/api.php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é™åˆ¶æ‰€æœ‰APIè¯·æ±‚ï¼Œæ¯åˆ†é’Ÿæœ€å¤š60æ¬¡</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Route</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">middleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;throttle:60,1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">group</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... your routes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¯¹ç™»å½•æ¥å£ä½¿ç”¨æ›´ä¸¥æ ¼çš„é™åˆ¶</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Route</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/login&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">middleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;throttle:5,1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ¯åˆ†é’Ÿ5æ¬¡</span></span></code></pre></div></li></ul></li><li><p><strong>ä¾èµ–é¡¹å®‰å…¨å®¡è®¡ (Dependency Security)</strong>: ä½ çš„åº”ç”¨å®‰å…¨å–å†³äºä½ æœ€ä¸å®‰å…¨çš„é‚£ä¸ªä¸‰æ–¹ä¾èµ–ã€‚</p><ul><li><strong>è§£å†³æ–¹æ¡ˆ</strong>: å®šæœŸè¿è¡Œ<code>composer audit</code>å‘½ä»¤ã€‚è¿™ä¸ªå‘½ä»¤ä¼šæ£€æŸ¥ä½ é¡¹ç›®<code>composer.lock</code>æ–‡ä»¶ä¸­çš„æ‰€æœ‰ä¾èµ–ï¼Œå¹¶å¯¹ç…§ä¸€ä¸ªå…¬å¼€çš„æ¼æ´æ•°æ®åº“è¿›è¡Œæ‰«æï¼ŒæŠ¥å‘Šå·²çŸ¥çš„å®‰å…¨æ¼æ´ã€‚</li><li><strong>è‡ªåŠ¨åŒ–</strong>: å°†<code>composer audit</code>ä½œä¸ºCI/CDæµæ°´çº¿ä¸­çš„ä¸€ä¸ªå¼ºåˆ¶æ­¥éª¤ã€‚åŒæ—¶ï¼Œå¯ç”¨GitHubçš„<strong>Dependabot</strong>ï¼Œå®ƒå¯ä»¥åœ¨ä½ çš„ä¾èµ–é¡¹å‘å¸ƒå®‰å…¨æ›´æ–°æ—¶è‡ªåŠ¨ä¸ºä½ åˆ›å»ºPRã€‚</li></ul></li><li><p><strong>CORSçš„æ­£ç¡®é…ç½® (Proper CORS Configuration)</strong>: åœ¨å‰åç«¯åˆ†ç¦»çš„åº”ç”¨ä¸­ï¼Œæµè§ˆå™¨ä¼šæ‰§è¡ŒCORSï¼ˆè·¨æºèµ„æºå…±äº«ï¼‰é¢„æ£€ã€‚é”™è¯¯çš„é…ç½®å¯èƒ½å¸¦æ¥å®‰å…¨é£é™©ã€‚</p><ul><li><strong>é£é™©</strong>: å°†<code>Access-Control-Allow-Origin</code>è®¾ç½®ä¸º<code>*</code>ï¼Œæ„å‘³ç€ä»»ä½•åŸŸåçš„ç½‘ç«™éƒ½å¯ä»¥å‘ä½ çš„APIå‘èµ·è¯·æ±‚ï¼Œè¿™å¯èƒ½å¯¼è‡´CSRFç­‰æ”»å‡»ã€‚</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>: ç²¾ç¡®é…ç½®å…è®¸çš„æ¥æºã€‚åœ¨Laravelçš„<code>config/cors.php</code>ä¸­ï¼Œæ˜ç¡®åˆ—å‡ºä½ çš„å‰ç«¯åº”ç”¨æ‰€åœ¨çš„åŸŸåã€‚<div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// config/cors.php</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;allowed_origins&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://localhost:3000&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://your-frontend-app.com&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span></code></pre></div></li></ul></li></ul><hr><hr><h3 id="ç¬¬äº”éƒ¨åˆ†-å¹¶å‘ä¸å¼‚æ­¥php-é‡Šæ”¾æè‡´æ€§èƒ½" tabindex="-1">ç¬¬äº”éƒ¨åˆ†ï¼šå¹¶å‘ä¸å¼‚æ­¥PHPï¼šé‡Šæ”¾æè‡´æ€§èƒ½ <a class="header-anchor" href="#ç¬¬äº”éƒ¨åˆ†-å¹¶å‘ä¸å¼‚æ­¥php-é‡Šæ”¾æè‡´æ€§èƒ½" aria-label="Permalink to &quot;ç¬¬äº”éƒ¨åˆ†ï¼šå¹¶å‘ä¸å¼‚æ­¥PHPï¼šé‡Šæ”¾æè‡´æ€§èƒ½&quot;">â€‹</a></h3><p>è¿™æ˜¯ç°ä»£PHPæœ€é«˜é˜¶ã€ä¹Ÿæ˜¯æœ€å…·é¢ è¦†æ€§çš„é¢†åŸŸã€‚é€šè¿‡å¼‚æ­¥åŒ–ï¼ŒPHPå¾—ä»¥æ‘†è„±ä¼ ç»ŸWebè¯·æ±‚çš„çŸ­æš‚ç”Ÿå‘½å‘¨æœŸï¼Œè¿›å…¥é«˜æ€§èƒ½ã€å¸¸é©»å†…å­˜çš„æœåŠ¡ç«¯åº”ç”¨é¢†åŸŸã€‚</p><h4 id="ç¬¬5ç« -å¹¶å‘ä¸å¼‚æ­¥php-é‡Šæ”¾æè‡´æ€§èƒ½" tabindex="-1">ç¬¬5ç« ï¼šå¹¶å‘ä¸å¼‚æ­¥PHPï¼šé‡Šæ”¾æè‡´æ€§èƒ½ <a class="header-anchor" href="#ç¬¬5ç« -å¹¶å‘ä¸å¼‚æ­¥php-é‡Šæ”¾æè‡´æ€§èƒ½" aria-label="Permalink to &quot;ç¬¬5ç« ï¼šå¹¶å‘ä¸å¼‚æ­¥PHPï¼šé‡Šæ”¾æè‡´æ€§èƒ½&quot;">â€‹</a></h4><h5 id="_5-1-ç°ä»£phpè¿è¡Œæ¨¡å¼" tabindex="-1">5.1 ç°ä»£PHPè¿è¡Œæ¨¡å¼ <a class="header-anchor" href="#_5-1-ç°ä»£phpè¿è¡Œæ¨¡å¼" aria-label="Permalink to &quot;5.1 ç°ä»£PHPè¿è¡Œæ¨¡å¼&quot;">â€‹</a></h5><ul><li><p><strong>PHP-FPM (FastCGI Process Manager)</strong>:</p><ul><li><strong>æ¨¡å‹</strong>: è¿™æ˜¯æœ€ä¼ ç»Ÿçš„æ¨¡å¼ã€‚ä¸€ä¸ªmasterè¿›ç¨‹ç®¡ç†ç€ä¸€ä¸ªworkerè¿›ç¨‹æ± ã€‚æ¯ä¸ªworkeråœ¨å¤„ç†å®Œä¸€ä¸ªè¯·æ±‚åï¼Œä¼šé”€æ¯æ‰€æœ‰å¯¹è±¡ï¼Œé‡Šæ”¾æ‰€æœ‰å†…å­˜ï¼ˆâ€œæ— å…±äº«â€æ¶æ„ï¼‰ã€‚</li><li><strong>ä¼˜ç‚¹</strong>: ç¨³å®šã€ç®€å•ã€‚å•ä¸ªè¯·æ±‚çš„å´©æºƒä¸ä¼šå½±å“å…¶ä»–è¯·æ±‚ã€‚ç”Ÿæ€æˆç†Ÿã€‚</li><li><strong>ç¼ºç‚¹</strong>: æ€§èƒ½ç“¶é¢ˆæ˜æ˜¾ã€‚æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦å®Œæ•´åœ°é‡æ–°åŠ è½½å’Œå¼•å¯¼æ•´ä¸ªæ¡†æ¶ï¼ˆå¦‚Laravelï¼‰ï¼ŒI/Oæ“ä½œï¼ˆå¦‚æ•°æ®åº“æŸ¥è¯¢ã€APIè°ƒç”¨ï¼‰æ˜¯å®Œå…¨é˜»å¡çš„ã€‚</li></ul></li><li><p><strong>Swoole / RoadRunner / Workerman (åº”ç”¨æœåŠ¡å™¨)</strong>:</p><ul><li><strong>æ¨¡å‹</strong>: è¿™äº›æ˜¯å¸¸é©»å†…å­˜çš„åº”ç”¨æœåŠ¡å™¨ã€‚Masterè¿›ç¨‹å¯åŠ¨çš„Workerè¿›ç¨‹åœ¨å¤„ç†å®Œä¸€ä¸ªè¯·æ±‚å<strong>ä¸ä¼šé€€å‡º</strong>ï¼Œè€Œæ˜¯ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚æ¡†æ¶åªåœ¨Workerå¯åŠ¨æ—¶è¢«å¼•å¯¼ä¸€æ¬¡ã€‚</li><li><strong>ä¼˜ç‚¹</strong>: <ul><li><strong>æé«˜æ€§èƒ½</strong>: å…å»äº†é‡å¤çš„æ¡†æ¶å¼•å¯¼å¼€é”€ï¼Œè¯·æ±‚å»¶è¿Ÿæä½ã€‚</li><li><strong>çŠ¶æ€ä¿æŒ</strong>: å¯ä»¥åœ¨å†…å­˜ä¸­ç»´æŠ¤æ•°æ®åº“è¿æ¥æ± ã€å…¨å±€é…ç½®ã€ç”šè‡³ä¸šåŠ¡çŠ¶æ€ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚</li><li><strong>å¼‚æ­¥å¹¶å‘</strong>: å®ƒä»¬å†…ç½®äº†äº‹ä»¶å¾ªç¯å’Œåç¨‹è°ƒåº¦å™¨ï¼Œå…è®¸ä½ åœ¨ä¸€ä¸ªworkerå†…é€šè¿‡åç¨‹å¹¶å‘å¤„ç†æˆåƒä¸Šä¸‡ä¸ªI/Oå¯†é›†å‹ä»»åŠ¡ã€‚</li></ul></li><li><strong>ç¼ºç‚¹</strong>: <ul><li><strong>å†…å­˜ç®¡ç†</strong>: éœ€è¦å¼€å‘è€…è­¦æƒ•å†…å­˜æ³„æ¼ï¼Œå› ä¸ºè¿›ç¨‹ä¸ä¼šè‡ªåŠ¨æ­»äº¡ã€‚</li><li><strong>çŠ¶æ€æ±¡æŸ“</strong>: å¿…é¡»å°å¿ƒå¤„ç†é™æ€å˜é‡å’Œå•ä¾‹ï¼Œé¿å…ä¸Šä¸€ä¸ªè¯·æ±‚çš„çŠ¶æ€æ±¡æŸ“ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚</li></ul></li></ul></li></ul><h5 id="_5-2-swoole-roadrunner-å®æˆ˜" tabindex="-1">5.2 Swoole/RoadRunner å®æˆ˜ <a class="header-anchor" href="#_5-2-swoole-roadrunner-å®æˆ˜" aria-label="Permalink to &quot;5.2 Swoole/RoadRunner å®æˆ˜&quot;">â€‹</a></h5><p>ç›´æ¥ä½¿ç”¨Swooleæˆ–RoadRunner APIæ˜¯å¤æ‚çš„ã€‚å¹¸è¿çš„æ˜¯ï¼Œç°ä»£æ¡†æ¶æä¾›äº†ä¼˜é›…çš„é›†æˆæ–¹æ¡ˆã€‚</p><ul><li><p><strong>Laravel Octane</strong>: è¿™æ˜¯Laravelå®˜æ–¹æä¾›çš„ã€ä¸Swooleå’ŒRoadRunneré›†æˆçš„ç¬¬ä¸€æ–¹æ‰©å±•åŒ…ã€‚å®ƒä¸ºä½ å¤„ç†äº†æ‰€æœ‰åº•å±‚çš„å¤æ‚æ€§ã€‚</p><ul><li>å®‰è£…åï¼Œåªéœ€ä¸€ä¸ªå‘½ä»¤å³å¯å¯åŠ¨é«˜æ€§èƒ½æœåŠ¡å™¨ï¼š <code>php artisan octane:start --server=swoole --workers=4</code></li></ul></li><li><p><strong>åç¨‹å¹¶å‘</strong>: Octaneæš´éœ²äº†ç®€å•æ˜“ç”¨çš„APIæ¥åˆ©ç”¨åº•å±‚çš„åç¨‹èƒ½åŠ›ã€‚</p><p><strong>åœºæ™¯</strong>: å‡è®¾ä¸€ä¸ªç”¨æˆ·ä»ªè¡¨ç›˜é¡µé¢éœ€è¦åŒæ—¶ä»3ä¸ªä¸åŒçš„å¾®æœåŠ¡è·å–æ•°æ®ã€‚</p><ul><li><p><strong>ä¼ ç»Ÿé˜»å¡æ–¹å¼ (æ€»è€—æ—¶ â‰ˆ 1s + 1.2s + 0.8s = 3s)</strong>:</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Http</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://user-service/me&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$orders </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Http</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://order-service/my-orders&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$stats </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Http</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://stats-service/dashboard&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div></li><li><p><strong>Octaneå¹¶å‘æ–¹å¼ (æ€»è€—æ—¶ â‰ˆ max(1, 1.2, 0.8) = 1.2s)</strong>:</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Laravel\\Octane\\Facades\\Octane</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[$user, $orders, $stats] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Octane</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">concurrent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;user&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () =&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Http</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://user-service/me&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;orders&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () =&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Http</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://order-service/my-orders&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;stats&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () =&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Http</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://stats-service/dashboard&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><code>Octane::concurrent</code>åˆ©ç”¨åç¨‹è°ƒåº¦å™¨ï¼Œè®©è¿™ä¸‰ä¸ªé˜»å¡çš„HTTPè¯·æ±‚â€œåŒæ—¶â€å¼€å§‹ï¼Œç¨‹åºä¼šç­‰å¾…æœ€é•¿çš„é‚£ä¸€ä¸ªå®Œæˆï¼Œè€Œä¸æ˜¯ä¾æ¬¡ç´¯åŠ ã€‚è¿™æå¤§åœ°æå‡äº†I/Oå¯†é›†å‹ä»»åŠ¡çš„å“åº”é€Ÿåº¦ã€‚</p></li></ul></li><li><p><strong>è¶…è¶ŠWeb</strong>: è¿™äº›åº”ç”¨æœåŠ¡å™¨è¿˜å…è®¸ä½ æ„å»ºä¼ ç»Ÿçš„PHP-FPMæ— æ³•å®ç°çš„æœåŠ¡ï¼Œå¦‚ï¼š</p><ul><li><strong>WebSocketæœåŠ¡å™¨</strong>: ç”¨äºèŠå¤©å®¤ã€å®æ—¶æ•°æ®æ¨é€ã€åœ¨çº¿æ¸¸æˆã€‚</li><li><strong>TCP/UDPæœåŠ¡å™¨</strong>: ç”¨äºç‰©è”ç½‘(IoT)è®¾å¤‡ã€è‡ªå®šä¹‰ç½‘ç»œåè®®ã€‚</li></ul></li></ul><h5 id="_5-3-æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥ä»»åŠ¡" tabindex="-1">5.3 æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥ä»»åŠ¡ <a class="header-anchor" href="#_5-3-æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥ä»»åŠ¡" aria-label="Permalink to &quot;5.3 æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥ä»»åŠ¡&quot;">â€‹</a></h5><p>å¹¶éæ‰€æœ‰ä»»åŠ¡éƒ½é€‚åˆåœ¨åŒæ­¥çš„Webè¯·æ±‚ä¸­å®Œæˆï¼Œç‰¹åˆ«æ˜¯é‚£äº›è€—æ—¶è¾ƒé•¿çš„æ“ä½œã€‚</p><p><strong>é—®é¢˜</strong>: ä¸€ä¸ªç”¨æˆ·æ³¨å†Œè¯·æ±‚ï¼Œéœ€è¦æ‰§è¡Œï¼š1. åˆ›å»ºç”¨æˆ·è®°å½• (å¿«) 2. å‘é€æ¬¢è¿é‚®ä»¶ (æ…¢) 3. åˆå§‹åŒ–åˆ†ææ•°æ® (æ…¢)ã€‚å¦‚æœåŒæ­¥æ‰§è¡Œï¼Œç”¨æˆ·éœ€è¦ç­‰å¾…å¾ˆä¹…æ‰èƒ½çœ‹åˆ°å“åº”ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>: å°†æ…¢é€Ÿä»»åŠ¡<strong>å¼‚æ­¥åŒ–</strong>ã€‚Webè¯·æ±‚åªè´Ÿè´£å®Œæˆæ ¸å¿ƒçš„ã€å¿«é€Ÿçš„æ“ä½œï¼ˆåˆ›å»ºç”¨æˆ·ï¼‰ï¼Œç„¶åå°†åç»­çš„æ…¢é€Ÿä»»åŠ¡ï¼ˆå‘é€é‚®ä»¶ã€åˆå§‹åŒ–æ•°æ®ï¼‰ä½œä¸ºä¸€æ¡â€œæ¶ˆæ¯â€æˆ–â€œä½œä¸š(Job)â€æ¨é€åˆ°<strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ä¸­ã€‚</p><ul><li><strong>æ¶ˆæ¯é˜Ÿåˆ— (Message Queue)</strong>: å¦‚Redis, RabbitMQ, SQSã€‚å®ƒæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ¶ˆæ¯ç¼“å†²åŒºã€‚</li><li><strong>ç”Ÿäº§è€… (Producer)</strong>: ä½ çš„Webåº”ç”¨ï¼Œè´Ÿè´£å°†Jobæ¨é€åˆ°é˜Ÿåˆ—ã€‚</li><li><strong>æ¶ˆè´¹è€… (Consumer)</strong>: ä¸€ä¸ªæˆ–å¤šä¸ªåœ¨åå°è¿è¡Œçš„ã€ç‹¬ç«‹çš„<strong>Workerè¿›ç¨‹</strong>ï¼Œå®ƒä»¬æŒç»­ç›‘å¬é˜Ÿåˆ—ï¼Œå–å‡ºJobå¹¶æ‰§è¡Œã€‚</li></ul><p><strong>Laravel Queueså®æˆ˜</strong>:</p><ol><li><p><strong>åˆ›å»ºJob</strong>: <code>php artisan make:job SendWelcomeEmail</code></p></li><li><p><strong>ç¼–å†™Job</strong>: Jobçš„æ ¸å¿ƒé€»è¾‘åœ¨<code>handle</code>æ–¹æ³•ä¸­ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// App/Jobs/SendWelcomeEmail.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SendWelcomeEmail</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ShouldQueue</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Dispatchable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">InteractsWithQueue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Queueable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SerializesModels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __construct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $user) {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Mailer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $mailer)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // è¿™é‡Œçš„ä»£ç å°†åœ¨åå°Workerè¿›ç¨‹ä¸­æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $mailer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">email)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> WelcomeEmail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p><strong>åˆ†å‘Job</strong>: åœ¨æ§åˆ¶å™¨ä¸­ï¼Œå°†Jobæ¨é€åˆ°é˜Ÿåˆ—ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// UserController.php</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> register</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $request)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... åˆ›å»ºç”¨æˆ· ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åˆ†å‘Jobåˆ°é˜Ÿåˆ—ï¼ŒWebè¯·æ±‚ç«‹å³è¿”å›å“åº”</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    SendWelcomeEmail</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($user);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    InitializeAnalytics</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;message&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;User registered!&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">201</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p><strong>è¿è¡ŒWorker</strong>: åœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨Workerè¿›ç¨‹æ¥å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚ <code>php artisan queue:work redis --tries=3</code></p></li></ol><p><strong>é«˜çº§é˜Ÿåˆ—æŠ€å·§</strong>:</p><ul><li><strong>Laravel Horizon</strong>: ä¸€ä¸ªä¸ºRedisé˜Ÿåˆ—è®¾è®¡çš„ã€åŠŸèƒ½å¼ºå¤§çš„å¯è§†åŒ–ä»ªè¡¨ç›˜å’Œé…ç½®ç³»ç»Ÿã€‚å®ƒèƒ½è®©ä½ å®æ—¶ç›‘æ§é˜Ÿåˆ—ååé‡ã€ä»»åŠ¡è€—æ—¶ã€å¤±è´¥ä»»åŠ¡ï¼Œå¹¶èƒ½è‡ªåŠ¨å¹³è¡¡Workerè¿›ç¨‹æ•°é‡ã€‚</li><li><strong>ä»»åŠ¡é“¾ (Chaining)</strong>: å®šä¹‰ä¸€ç»„å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œçš„Jobã€‚ <code>ProcessPodcast::withChain([new OptimizePodcast, new ReleasePodcast])-&gt;dispatch();</code></li><li><strong>æ‰¹å¤„ç† (Batches)</strong>: åŒæ—¶åˆ†å‘å¤§é‡Jobï¼Œå¹¶èƒ½åœ¨æ‰€æœ‰Jobéƒ½æˆåŠŸå®Œæˆåæ‰§è¡Œä¸€ä¸ªå›è°ƒã€‚éå¸¸é€‚åˆæµ·é‡æ•°æ®çš„å¹¶è¡Œå¤„ç†ã€‚<div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$batch </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Bus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">batch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ImportCsvChunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ImportCsvChunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1001</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Batch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $batch) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ‰€æœ‰Jobéƒ½æˆåŠŸ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Batch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $batch, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Throwable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $e) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç¬¬ä¸€ä¸ªå¤±è´¥çš„Jobä¼šè§¦å‘...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div></li></ul><p>é€šè¿‡ç»“åˆä½¿ç”¨é«˜æ€§èƒ½åº”ç”¨æœåŠ¡å™¨å’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç°ä»£PHPåº”ç”¨å¯ä»¥è½»æ¾åº”å¯¹ä»é«˜å¹¶å‘å®æ—¶é€šä¿¡åˆ°å¤§è§„æ¨¡æ•°æ®å¼‚æ­¥å¤„ç†çš„å„ç§å¤æ‚æŒ‘æˆ˜ã€‚</p><hr><hr><h3 id="ç¬¬å…­éƒ¨åˆ†-åšä¸å¯æ‘§çš„ä»£ç è´¨é‡" tabindex="-1">ç¬¬å…­éƒ¨åˆ†ï¼šåšä¸å¯æ‘§çš„ä»£ç è´¨é‡ <a class="header-anchor" href="#ç¬¬å…­éƒ¨åˆ†-åšä¸å¯æ‘§çš„ä»£ç è´¨é‡" aria-label="Permalink to &quot;ç¬¬å…­éƒ¨åˆ†ï¼šåšä¸å¯æ‘§çš„ä»£ç è´¨é‡&quot;">â€‹</a></h3><h4 id="ç¬¬6ç« -åšä¸å¯æ‘§çš„ä»£ç è´¨é‡" tabindex="-1">ç¬¬6ç« ï¼šåšä¸å¯æ‘§çš„ä»£ç è´¨é‡ <a class="header-anchor" href="#ç¬¬6ç« -åšä¸å¯æ‘§çš„ä»£ç è´¨é‡" aria-label="Permalink to &quot;ç¬¬6ç« ï¼šåšä¸å¯æ‘§çš„ä»£ç è´¨é‡&quot;">â€‹</a></h4><p>ç¼–å†™èƒ½å¤Ÿå·¥ä½œçš„ä»£ç åªæ˜¯ç¬¬ä¸€æ­¥ã€‚ç¼–å†™åœ¨æœªæ¥å‡ ä¸ªæœˆç”šè‡³å‡ å¹´å†…éƒ½æ˜“äºç»´æŠ¤ã€ä¸æ˜“å‡ºé”™ã€é«˜è´¨é‡çš„ä»£ç ï¼Œæ˜¯é«˜çº§å·¥ç¨‹å¸ˆçš„æ ¸å¿ƒä»·å€¼æ‰€åœ¨ã€‚æœ¬ç« å°†æ¢è®¨å¦‚ä½•é€šè¿‡è‡ªåŠ¨åŒ–å·¥å…·å’Œç°ä»£æµ‹è¯•èŒƒå¼æ¥æ„å»ºåšä¸å¯æ‘§çš„PHPåº”ç”¨ã€‚</p><h5 id="_6-1-é™æ€åˆ†æçš„æé™" tabindex="-1">6.1 é™æ€åˆ†æçš„æé™ <a class="header-anchor" href="#_6-1-é™æ€åˆ†æçš„æé™" aria-label="Permalink to &quot;6.1 é™æ€åˆ†æçš„æé™&quot;">â€‹</a></h5><p>PHPä½œä¸ºä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œè®¸å¤šé”™è¯¯åªæœ‰åœ¨è¿è¡Œæ—¶æ‰èƒ½è¢«å‘ç°ã€‚é™æ€åˆ†æå·¥å…·é€šè¿‡åœ¨ä¸å®é™…è¿è¡Œä»£ç çš„æƒ…å†µä¸‹åˆ†æä»£ç ï¼Œèƒ½å¤Ÿåœ¨ç¼–ç é˜¶æ®µå°±æ‰¾å‡ºæ½œåœ¨çš„bugã€é€»è¾‘é”™è¯¯å’Œä¸è§„èŒƒçš„å†™æ³•ã€‚</p><ul><li><p><strong>PHPStan &amp; Psalm</strong>: è¿™æ˜¯PHPç¤¾åŒºæœ€ä¸»æµçš„ä¸¤ä¸ªé™æ€åˆ†æå·¥å…·ã€‚å®ƒä»¬èƒ½æ£€æŸ¥å‡ºï¼š</p><ul><li>ç±»å‹é”™è¯¯ï¼ˆå¦‚å°†<code>string</code>ä¼ é€’ç»™éœ€è¦<code>int</code>çš„å‡½æ•°ï¼‰ã€‚</li><li>è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•æˆ–å±æ€§ã€‚</li><li>æœªè¢«å¤„ç†çš„<code>null</code>å€¼å¯èƒ½å¯¼è‡´çš„é”™è¯¯ã€‚</li><li>â€œæ­»ä»£ç â€ï¼ˆæ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œçš„ä»£ç ï¼‰ã€‚</li><li>ä»¥åŠæ›´å¤šå¤æ‚çš„é€»è¾‘é—®é¢˜ã€‚</li></ul></li><li><p><strong>åˆ†æçº§åˆ« (Levels)</strong>: è¿™ä¸¤ä¸ªå·¥å…·éƒ½æä¾›äº†ä»0åˆ°æœ€é«˜çº§ï¼ˆPHPStanä¸º9ï¼ŒPsalmä¸º1ï¼‰çš„â€œä¸¥æ ¼åº¦çº§åˆ«â€ã€‚çº§åˆ«0åªä¼šæŠ¥å‘Šæœ€æ˜æ˜¾çš„é”™è¯¯ï¼Œè€Œæœ€é«˜çº§åˆ«åˆ™ä¼šæ‰§è¡Œæå…¶ä¸¥æ ¼çš„æ£€æŸ¥ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ç¡®ä¿æ•°ç»„è®¿é—®å‰å·²æ£€æŸ¥keyæ˜¯å¦å­˜åœ¨ã€‚</li><li>ç¡®ä¿ä»æ•°ç»„æˆ–æ³›å‹é›†åˆä¸­å–å‡ºçš„å€¼ç±»å‹æ˜¯æ˜ç¡®çš„ã€‚</li><li>å¼ºåˆ¶æ‰€æœ‰ä»£ç è·¯å¾„éƒ½æœ‰è¿”å›å€¼ã€‚</li></ul></li><li><p><strong>å®æˆ˜ç­–ç•¥ï¼šæ¸è¿›å¼å¢å¼º</strong> å¯¹äºä¸€ä¸ªå·²å­˜åœ¨çš„é¡¹ç›®ï¼Œç›´æ¥å¼€å¯æœ€é«˜çº§åˆ«å¯èƒ½ä¼šäº§ç”Ÿæˆåƒä¸Šä¸‡ä¸ªé”™è¯¯ã€‚æ­£ç¡®çš„ç­–ç•¥æ˜¯ï¼š</p><ol><li><strong>ä»ä½çº§åˆ«å¼€å§‹</strong>: åœ¨<code>phpstan.neon</code>æˆ–<code>psalm.xml</code>ä¸­é…ç½®ä¸€ä¸ªè¾ƒä½çš„çº§åˆ«ï¼ˆå¦‚Level 2ï¼‰ï¼Œä¿®å¤æ‰€æœ‰æŠ¥å‘Šçš„é”™è¯¯ã€‚</li><li><strong>å»ºç«‹åŸºçº¿ (Baseline)</strong>: ä½¿ç”¨å‘½ä»¤ <code>phpstan analyse --generate-baseline</code> ç”Ÿæˆä¸€ä¸ªåŸºçº¿æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šåˆ—å‡ºå½“å‰æ‰€æœ‰å‰©ä½™çš„é”™è¯¯ï¼Œå¹¶å‘Šè¯‰PHPStanåœ¨æœªæ¥çš„åˆ†æä¸­â€œå¿½ç•¥â€è¿™äº›å·²å­˜åœ¨çš„é”™è¯¯ã€‚</li><li><strong>è°ƒè‡³æœ€é«˜çº§åˆ«</strong>: å°†é…ç½®æ–‡ä»¶ä¸­çš„<code>level</code>è°ƒè‡³æœ€é«˜ï¼ˆå¦‚8æˆ–9ï¼‰ã€‚ç°åœ¨ï¼Œé™æ€åˆ†æå°†å¯¹æ‰€æœ‰<strong>æ–°ç¼–å†™çš„æˆ–è¢«ä¿®æ”¹çš„</strong>ä»£ç æ‰§è¡Œæœ€ä¸¥æ ¼çš„æ£€æŸ¥ï¼Œè€Œè€ä»£ç ä¸­çš„é—®é¢˜åˆ™è¢«æš‚æ—¶æç½®ã€‚</li><li><strong>æŒç»­æ”¹è¿›</strong>: åœ¨æ—¥å¸¸å¼€å‘æˆ–é‡æ„ä¸­ï¼Œé€æ­¥ä¿®å¤åŸºçº¿æ–‡ä»¶ä¸­çš„é”™è¯¯ï¼Œå¹¶å°†å…¶ä»åŸºçº¿ä¸­ç§»é™¤ã€‚</li></ol></li><li><p><strong>è‡ªå®šä¹‰è§„åˆ™</strong>: å½“å›¢é˜Ÿéœ€è¦å¼ºåˆ¶æ‰§è¡Œç‰¹å®šçš„æ¶æ„è§„åˆ™æ—¶ï¼ˆä¾‹å¦‚ï¼Œâ€œServiceå±‚ä¸èƒ½ç›´æ¥è°ƒç”¨Eloquent Modelâ€ï¼‰ï¼Œä½ å¯ä»¥ç¼–å†™è‡ªå®šä¹‰çš„PHPStanæˆ–Psalmè§„åˆ™ï¼Œå°†å…¶é›†æˆåˆ°CIæµç¨‹ä¸­ï¼Œå®ç°æ¶æ„çš„è‡ªåŠ¨åŒ–å®ˆæŠ¤ã€‚</p></li></ul><h5 id="_6-2-æµ‹è¯•æ–°èŒƒå¼" tabindex="-1">6.2 æµ‹è¯•æ–°èŒƒå¼ <a class="header-anchor" href="#_6-2-æµ‹è¯•æ–°èŒƒå¼" aria-label="Permalink to &quot;6.2 æµ‹è¯•æ–°èŒƒå¼&quot;">â€‹</a></h5><p>è‡ªåŠ¨åŒ–æµ‹è¯•æ˜¯ä¿è¯ä»£ç è´¨é‡çš„åŸºçŸ³ã€‚é™¤äº†ä¼ ç»Ÿçš„PHPUnitï¼Œä¸€äº›æ–°çš„å·¥å…·å’Œæ€æƒ³æ­£åœ¨è®©æµ‹è¯•å˜å¾—æ›´é«˜æ•ˆã€æ›´å…·è¡¨ç°åŠ›ã€‚</p><ul><li><p><strong>Pest: æ›´ä¼˜é›…çš„æµ‹è¯•æ¡†æ¶</strong> Pestæ˜¯æ„å»ºäºPHPUnitä¹‹ä¸Šçš„ä¸€ä¸ªæµ‹è¯•æ¡†æ¶ï¼Œå®ƒæä¾›äº†æ›´ç®€æ´ã€æ›´æ³¨é‡å¯è¯»æ€§çš„DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰ã€‚</p><p><strong>PHPUnit é£æ ¼</strong>:</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PostTest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TestCase</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /** @test */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a_user_can_create_a_post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">factory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">actingAs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($user);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/posts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;title&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;New Post&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">assertDatabaseHas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;posts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;title&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;New Post&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Pest é£æ ¼</strong>:</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;a user can create a post&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">factory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    actingAs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($user);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/posts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;title&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;New Post&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    assertDatabaseHas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;posts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;title&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;New Post&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p>Pesté€šè¿‡ä½¿ç”¨ç®€å•çš„å‡½æ•°ï¼ˆ<code>test</code>, <code>expect</code>ï¼‰å’Œè¾…åŠ©å‡½æ•°ï¼Œè®©æµ‹è¯•ä»£ç è¯»èµ·æ¥æ›´åƒè‡ªç„¶è¯­è¨€ã€‚å®ƒè¿˜æä¾›äº†å¼ºå¤§çš„æ•°æ®é›†ï¼ˆDatasetsï¼‰å’Œé«˜é˜¶æµ‹è¯•ï¼ˆHigher-Order Testsï¼‰åŠŸèƒ½ï¼Œå¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–æµ‹è¯•çš„ç¼–å†™ã€‚</p></li><li><p><strong>æ¶æ„æµ‹è¯• (Architecture Testing)</strong> å¦‚ä½•è‡ªåŠ¨ç¡®ä¿ä½ çš„ä»£ç éµå¾ªæ—¢å®šçš„æ¶æ„è§„åˆ™ï¼Ÿä¾‹å¦‚â€œæ§åˆ¶å™¨ä¸èƒ½ç›´æ¥ä¸Eloquentæ¨¡å‹äº¤äº’ï¼Œå¿…é¡»é€šè¿‡æœåŠ¡å±‚â€ã€‚æ¶æ„æµ‹è¯•å°±æ˜¯ç­”æ¡ˆã€‚</p><p>Pestï¼ˆé€šè¿‡æ’ä»¶ï¼‰æˆ–ç‹¬ç«‹çš„<code>phparkitect/phparkitect</code>åº“å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// tests/Architecture/MyArchTest.php</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;controllers do not depend on eloquent models&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;App\\Http\\Controllers&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toNotUse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Illuminate\\Database\\Eloquent\\Model&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;services are final&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;App\\Services&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    -&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toBeFinal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p>è¿™äº›æµ‹è¯•ç”¨ä¾‹ä¼šåœ¨ä½ çš„CI/CDæµæ°´çº¿ä¸­è¿è¡Œã€‚ä¸€æ—¦æœ‰äººæäº¤äº†è¿åæ¶æ„è§„åˆ™çš„ä»£ç ï¼Œæ„å»ºå°±ä¼šå¤±è´¥ï¼Œä»è€Œåœ¨æ—©æœŸé˜¶æ®µå°±é˜²æ­¢äº†æ¶æ„çš„è…åŒ–ã€‚</p></li><li><p><strong>å˜å¼‚æµ‹è¯• (Mutation Testing)</strong> 100%çš„ä»£ç è¦†ç›–ç‡å¹¶ä¸èƒ½ä¿è¯ä½ çš„æµ‹è¯•æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåªè¯´æ˜ä½ çš„ä»£ç è¢«æ‰§è¡Œäº†ï¼Œä½†æ²¡è¯´æ–­è¨€æ˜¯å¦è¶³å¤Ÿå¼ºå£®ã€‚</p><p><strong>å˜å¼‚æµ‹è¯•</strong>æ˜¯è¡¡é‡æµ‹è¯•è´¨é‡çš„ç»ˆææ­¦å™¨ã€‚</p><ol><li><strong>å·¥å…·</strong>: <code>infection/infection</code></li><li><strong>åŸç†</strong>: Infectionä¼šè·å–ä½ çš„æºä»£ç ï¼Œå¹¶å¯¹å…¶è¿›è¡Œå¾®å°çš„ã€è‡ªåŠ¨åŒ–çš„ä¿®æ”¹ï¼ˆâ€œå˜å¼‚â€ï¼‰ï¼Œä¾‹å¦‚å°†<code>&gt;</code>å˜ä¸º<code>&gt;=</code>ï¼Œå°†<code>true</code>å˜ä¸º<code>false</code>ã€‚</li><li>ç„¶åï¼Œå®ƒè¿è¡Œä½ çš„æµ‹è¯•å¥—ä»¶ã€‚ <ul><li>å¦‚æœæµ‹è¯•<strong>å¤±è´¥</strong>äº†ï¼Œè¯´æ˜ä½ çš„æµ‹è¯•æˆåŠŸâ€œæ€æ­»â€äº†è¿™ä¸ªå˜å¼‚ä½“ã€‚è¿™æ˜¯<strong>å¥½äº‹</strong>ã€‚</li><li>å¦‚æœæµ‹è¯•<strong>ä»ç„¶é€šè¿‡</strong>ï¼Œè¯´æ˜è¿™ä¸ªå˜å¼‚ä½“â€œé€ƒé€¸â€äº†ã€‚è¿™æ˜¯<strong>åäº‹</strong>ï¼Œæ„å‘³ç€ä½ çš„æµ‹è¯•æ²¡æœ‰è¦†ç›–åˆ°è¿™ä¸ªé€»è¾‘è¾¹ç•Œï¼Œå­˜åœ¨æ¼æ´ã€‚</li></ul></li><li><strong>ç›®æ ‡</strong>: è¿½æ±‚ä¸€ä¸ªé«˜çš„<strong>MSI (Mutation Score Indicator)</strong>ï¼Œè¿™æ„å‘³ç€ä½ çš„æµ‹è¯•å¥—ä»¶å¯¹ä»£ç ä¸­çš„å¾®å°å˜åŒ–éå¸¸æ•æ„Ÿï¼Œè´¨é‡å¾ˆé«˜ã€‚</li></ol></li></ul><h5 id="_6-3-é‡æ„ä¸é—ç•™ä»£ç æ”¹é€ " tabindex="-1">6.3 é‡æ„ä¸é—ç•™ä»£ç æ”¹é€  <a class="header-anchor" href="#_6-3-é‡æ„ä¸é—ç•™ä»£ç æ”¹é€ " aria-label="Permalink to &quot;6.3 é‡æ„ä¸é—ç•™ä»£ç æ”¹é€ &quot;">â€‹</a></h5><ul><li><p><strong>Rector: è‡ªåŠ¨åŒ–é‡æ„</strong> Rectoræ˜¯ä¸€ä¸ªåŸºäºASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰çš„ä»£ç è½¬æ¢å·¥å…·ï¼Œå¯ä»¥å®‰å…¨ã€å¤§è§„æ¨¡åœ°å¯¹ä½ çš„ä»£ç åº“è¿›è¡Œè‡ªåŠ¨åŒ–é‡æ„ã€‚</p><p><strong>æ ¸å¿ƒåº”ç”¨åœºæ™¯</strong>:</p><ul><li><strong>PHP/æ¡†æ¶ç‰ˆæœ¬å‡çº§</strong>: Rectoræä¾›äº†é¢„è®¾çš„è§„åˆ™é›†ï¼Œå¯ä»¥è‡ªåŠ¨ä¿®å¤ä»PHP 7.4åˆ°8.2ï¼Œæˆ–ä»Laravel 8åˆ°10çš„å¤§éƒ¨åˆ†ç ´åæ€§å˜æ›´ã€‚</li><li><strong>åº”ç”¨ç°ä»£PHPç‰¹æ€§</strong>: è‡ªåŠ¨å°†æ—§çš„æ•°ç»„è¯­æ³•è½¬æ¢ä¸ºçŸ­æ•°ç»„è¯­æ³•ï¼Œå°†<code>switch</code>è½¬æ¢ä¸º<code>match</code>ï¼Œä¸ºDTOæ·»åŠ <code>readonly</code>ç­‰ã€‚</li><li><strong>å®æ–½è‡ªå®šä¹‰è§„åˆ™</strong>: ç¼–å†™ä½ è‡ªå·±çš„Rectorè§„åˆ™ï¼Œåœ¨æ•´ä¸ªä»£ç åº“ä¸­å®æ–½ç‰¹å®šçš„ä»£ç é£æ ¼æˆ–æ¶æ„æ¨¡å¼ã€‚</li></ul></li><li><p><strong>ç»æ€è€…æ— èŠ±æœæ¨¡å¼ (Strangler Fig Pattern)</strong> åœ¨é¢å¯¹ä¸€ä¸ªå·¨å¤§ã€é™ˆæ—§çš„å•ä½“åº”ç”¨æ—¶ï¼Œç›´æ¥é‡å†™é€šå¸¸é£é™©æé«˜ä¸”å‘¨æœŸæ¼«é•¿ã€‚ç»æ€è€…æ¨¡å¼æä¾›äº†ä¸€ç§æ›´å¹³æ»‘çš„è¿ç§»ç­–ç•¥ã€‚</p><ol><li><strong>è¯†åˆ«è¾¹ç•Œ</strong>: åœ¨é—ç•™ç³»ç»Ÿä¸­è¯†åˆ«å‡ºä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„ä¸šåŠ¡æ¨¡å—ï¼ˆå¦‚â€œç”¨æˆ·é€šçŸ¥â€ï¼‰ã€‚</li><li><strong>åˆ›å»ºæ–°æœåŠ¡</strong>: ä½¿ç”¨ç°ä»£æŠ€æœ¯æ ˆï¼ˆå¦‚Laravel 11, DDD Liteï¼‰æ„å»ºä¸€ä¸ªæ–°çš„ã€ç‹¬ç«‹çš„é€šçŸ¥æœåŠ¡ã€‚</li><li><strong>è®¾ç½®ä»£ç†/è·¯ç”±</strong>: åœ¨é—ç•™ç³»ç»Ÿçš„å…¥å£å¤„ï¼ˆå¦‚Nginx, API Gatewayæˆ–åº”ç”¨å†…çš„ä¸€ä¸ªè·¯ç”±å±‚ï¼‰è®¾ç½®ä¸€ä¸ªä»£ç†ã€‚å°†æ‰€æœ‰å‘å¾€â€œç”¨æˆ·é€šçŸ¥â€åŠŸèƒ½çš„è¯·æ±‚ï¼Œé€æ˜åœ°è·¯ç”±åˆ°æ–°çš„æœåŠ¡ä¸Šã€‚æ‰€æœ‰å…¶ä»–è¯·æ±‚ä»ç„¶ç”±é—ç•™ç³»ç»Ÿå¤„ç†ã€‚</li><li><strong>è¿­ä»£</strong>: é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œé€æ­¥ç”¨æ–°çš„ã€ç°ä»£çš„æœåŠ¡â€œåŒ…è£¹â€å¹¶â€œç»æ€â€é—ç•™ç³»ç»Ÿã€‚</li><li><strong>é€€å½¹</strong>: å½“æ‰€æœ‰åŠŸèƒ½éƒ½è¢«æ–°æœåŠ¡æ›¿ä»£åï¼Œé—ç•™ç³»ç»Ÿå°±å¯ä»¥å®‰å…¨ä¸‹çº¿äº†ã€‚</li></ol></li></ul><hr><hr><h3 id="ç¬¬ä¸ƒéƒ¨åˆ†-å·¥ç¨‹åŒ–ä¸å¯è§‚æµ‹æ€§-engineering-observability" tabindex="-1">ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå·¥ç¨‹åŒ–ä¸å¯è§‚æµ‹æ€§ (Engineering &amp; Observability) <a class="header-anchor" href="#ç¬¬ä¸ƒéƒ¨åˆ†-å·¥ç¨‹åŒ–ä¸å¯è§‚æµ‹æ€§-engineering-observability" aria-label="Permalink to &quot;ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå·¥ç¨‹åŒ–ä¸å¯è§‚æµ‹æ€§ (Engineering &amp; Observability)&quot;">â€‹</a></h3><h4 id="ç¬¬7ç« -ç°ä»£devopsæµç¨‹" tabindex="-1">ç¬¬7ç« ï¼šç°ä»£DevOpsæµç¨‹ <a class="header-anchor" href="#ç¬¬7ç« -ç°ä»£devopsæµç¨‹" aria-label="Permalink to &quot;ç¬¬7ç« ï¼šç°ä»£DevOpsæµç¨‹&quot;">â€‹</a></h4><h5 id="_7-1-å¼€å‘æµç¨‹çš„èµ·ç‚¹-ä½¿ç”¨composerä½œä¸ºä»»åŠ¡è¿è¡Œå™¨" tabindex="-1">7.1 å¼€å‘æµç¨‹çš„èµ·ç‚¹ï¼šä½¿ç”¨Composerä½œä¸ºä»»åŠ¡è¿è¡Œå™¨ <a class="header-anchor" href="#_7-1-å¼€å‘æµç¨‹çš„èµ·ç‚¹-ä½¿ç”¨composerä½œä¸ºä»»åŠ¡è¿è¡Œå™¨" aria-label="Permalink to &quot;7.1 å¼€å‘æµç¨‹çš„èµ·ç‚¹ï¼šä½¿ç”¨Composerä½œä¸ºä»»åŠ¡è¿è¡Œå™¨&quot;">â€‹</a></h5><p>åœ¨æ·±å…¥CI/CDä¹‹å‰ï¼Œä¸€ä¸ªé«˜æ•ˆã€ç»Ÿä¸€çš„æœ¬åœ°å¼€å‘ç¯å¢ƒæ˜¯åŸºç¡€ã€‚<code>composer.json</code>ä¸­çš„<code>&quot;scripts&quot;</code>éƒ¨åˆ†æ˜¯ä¸€ä¸ªç»å¸¸è¢«ä½ä¼°çš„å¼ºå¤§åŠŸèƒ½ï¼Œå®ƒèƒ½å°†é¡¹ç›®ä¸­å„ç§é›¶æ•£çš„å‘½ä»¤è¡Œå·¥å…·è°ƒç”¨ç»Ÿä¸€èµ·æ¥ã€‚</p><ul><li><p><strong>æ ¸å¿ƒæ€æƒ³</strong>: ä¸ºå¸¸ç”¨çš„ã€å¤æ‚çš„å‘½ä»¤åˆ›å»ºç®€çŸ­ã€æ˜“è®°çš„åˆ«åã€‚</p></li><li><p><strong>å®æˆ˜åº”ç”¨</strong>:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;scripts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;test&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vendor/bin/pest --coverage&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;test-feature&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vendor/bin/pest --group=feature&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;lint&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vendor/bin/pint&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;analyse&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vendor/bin/phpstan analyse --memory-limit=2G&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;ci-check&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;@lint&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;@analyse&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;@test&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>å¥½å¤„</strong>:</p><ol><li><strong>ç»Ÿä¸€å‘½ä»¤</strong>: å›¢é˜Ÿæ‰€æœ‰æˆå‘˜ï¼ˆåŒ…æ‹¬æ–°åŠ å…¥çš„æˆå‘˜ï¼‰éƒ½æ— éœ€è®°å¿†å…·ä½“çš„å·¥å…·å’Œå‚æ•°ï¼Œåªéœ€è¿è¡Œ<code>composer test</code>, <code>composer lint</code>ç­‰ã€‚</li><li><strong>ç®€åŒ–CIé…ç½®</strong>: CI/CDæµæ°´çº¿ä¸­çš„è„šæœ¬å¯ä»¥å˜å¾—éå¸¸ç®€æ´ï¼Œåªéœ€æ‰§è¡Œ<code>composer ci-check</code>å³å¯è¿è¡Œæ‰€æœ‰ä»£ç è´¨é‡æ£€æŸ¥ã€‚</li><li><strong>éš”ç¦»å·¥å…·æ›´æ–°</strong>: å¦‚æœæœªæ¥å°†<code>pint</code>æ¢æˆ<code>php-cs-fixer</code>ï¼Œä½ åªéœ€è¦ä¿®æ”¹<code>composer.json</code>ä¸­çš„<code>lint</code>è„šæœ¬ï¼Œè€Œå›¢é˜Ÿæˆå‘˜å’ŒCIè„šæœ¬çš„è°ƒç”¨æ–¹å¼å®Œå…¨ä¸å˜ã€‚</li></ol></li></ul><h5 id="_7-2-å®¹å™¨åŒ–éƒ¨ç½²" tabindex="-1">7.2 å®¹å™¨åŒ–éƒ¨ç½² <a class="header-anchor" href="#_7-2-å®¹å™¨åŒ–éƒ¨ç½²" aria-label="Permalink to &quot;7.2 å®¹å™¨åŒ–éƒ¨ç½²&quot;">â€‹</a></h5><p>Dockerå·²ç»æˆä¸ºç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†ã€‚å®ƒå°†åº”ç”¨åŠå…¶æ‰€æœ‰ä¾èµ–ï¼ˆPHPç‰ˆæœ¬ã€æ‰©å±•ã€ç³»ç»Ÿåº“ï¼‰æ‰“åŒ…åˆ°ä¸€ä¸ªå¯ç§»æ¤çš„é•œåƒä¸­ï¼Œç¡®ä¿äº†å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒçš„å®Œå…¨ä¸€è‡´ã€‚</p><p><strong>ç¼–å†™ç”Ÿäº§çº§çš„<code>Dockerfile</code></strong>:</p><p>ä¸€ä¸ªç”Ÿäº§çº§çš„<code>Dockerfile</code>åº”è¯¥å…³æ³¨é•œåƒå¤§å°ã€æ„å»ºé€Ÿåº¦å’Œå®‰å…¨æ€§ã€‚<strong>å¤šé˜¶æ®µæ„å»º (Multi-stage builds)</strong> æ˜¯å®ç°è¿™ä¸€ç›®æ ‡çš„å…³é”®ã€‚</p><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># --- Stage 1: Builder ---</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä½¿ç”¨åŒ…å«æ‰€æœ‰æ„å»ºå·¥å…·çš„å®˜æ–¹é•œåƒ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> php:8.2-fpm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å®‰è£…ç³»ç»Ÿä¾èµ–å’ŒPHPæ‰©å±•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> apt-get update &amp;&amp; apt-get install -y ... \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &amp;&amp; docker-php-ext-install pdo_mysql bcmath ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å®‰è£…Composer</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --from=composer:latest /usr/bin/composer /usr/bin/composer</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å¤åˆ¶åº”ç”¨ä»£ç </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /app</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> . .</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å®‰è£…Composerä¾èµ–ï¼Œ--no-devè¡¨ç¤ºä¸å®‰è£…å¼€å‘ä¾èµ–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> composer install --no-dev --optimize-autoloader</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># --- Stage 2: Final Image ---</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä½¿ç”¨ä¸€ä¸ªå¹²å‡€ã€è½»é‡çš„åŸºç¡€é•œåƒ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> php:8.2-fpm-alpine</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># åªå®‰è£…ç”Ÿäº§ç¯å¢ƒå¿…éœ€çš„PHPæ‰©å±•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> docker-php-ext-install pdo_mysql</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># åˆ›å»ºä¸€ä¸ªérootç”¨æˆ·æ¥è¿è¡Œåº”ç”¨ï¼Œå¢å¼ºå®‰å…¨æ€§</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> addgroup -S myapp &amp;&amp; adduser -S myapp -G myapp</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> myapp</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä»builderé˜¶æ®µå¤åˆ¶ä¼˜åŒ–è¿‡çš„Composerä¾èµ–å’Œåº”ç”¨ä»£ç </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --from=builder /app/vendor ./vendor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --from=builder /app .</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æš´éœ²PHP-FPMç«¯å£</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">EXPOSE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 9000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å¯åŠ¨PHP-FPM</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CMD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;php-fpm&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><p>è¿™ä¸ª<code>Dockerfile</code>é€šè¿‡ä¸¤ä¸ªé˜¶æ®µï¼Œæœ€ç»ˆç”Ÿæˆäº†ä¸€ä¸ªä¸å«æ„å»ºå·¥å…·ã€ä½“ç§¯æ›´å°ã€æ›´å®‰å…¨çš„ç”Ÿäº§é•œåƒã€‚</p><h5 id="_7-3-ci-cd-æœ€ä½³å®è·µ" tabindex="-1">7.3 CI/CD æœ€ä½³å®è·µ <a class="header-anchor" href="#_7-3-ci-cd-æœ€ä½³å®è·µ" aria-label="Permalink to &quot;7.3 CI/CD æœ€ä½³å®è·µ&quot;">â€‹</a></h5><p>æŒç»­é›†æˆï¼ˆCIï¼‰å’ŒæŒç»­éƒ¨ç½²ï¼ˆCDï¼‰æ˜¯è‡ªåŠ¨åŒ–è½¯ä»¶äº¤ä»˜æµç¨‹çš„æ ¸å¿ƒã€‚</p><p><strong>ä½¿ç”¨GitHub Actionsæ„å»ºCIæµæ°´çº¿</strong>:</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„PHPåº”ç”¨CIå·¥ä½œæµæ–‡ä»¶ï¼ˆ<code>.github/workflows/ci.yml</code>ï¼‰:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">PHP CI</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pull_request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  build-and-test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    runs-on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ubuntu-latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    steps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Checkout code</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">actions/checkout@v3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Setup PHP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shivammathur/setup-php@v2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          php-version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;8.2&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          extensions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          coverage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">xdebug</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # å¯ç”¨Xdebugç”¨äºä»£ç è¦†ç›–ç‡</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Install Composer dependencies</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">composer install --prefer-dist --no-progress</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Run Security Audit</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">composer audit</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Run All Checks (Lint, Static Analysis, Tests)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">composer ci-check</span></span></code></pre></div><p>è¿™ä¸ªæµæ°´çº¿ç¡®ä¿äº†æ¯æ¬¡ä»£ç æäº¤éƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š</p><ol><li><strong>ä¾èµ–å®‰å…¨å®¡è®¡</strong></li><li><strong>ä»£ç é£æ ¼æ£€æŸ¥ (Lint)</strong></li><li><strong>é™æ€åˆ†æ</strong></li><li><strong>è‡ªåŠ¨åŒ–æµ‹è¯•</strong></li></ol><p>åªæœ‰å½“æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡æ—¶ï¼Œä»£ç æ‰è¢«è®¤ä¸ºæ˜¯å¯åˆå¹¶çš„ï¼Œä»è€Œä¿è¯äº†ä¸»åˆ†æ”¯çš„å¥åº·ã€‚</p><hr><h4 id="ç¬¬8ç« -ç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§-observability" tabindex="-1">ç¬¬8ç« ï¼šç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§ (Observability) <a class="header-anchor" href="#ç¬¬8ç« -ç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§-observability" aria-label="Permalink to &quot;ç¬¬8ç« ï¼šç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§ (Observability)&quot;">â€‹</a></h4><p>å½“åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒå‡ºç°é—®é¢˜æ—¶ï¼Œâ€œç™»å½•æœåŠ¡å™¨çœ‹æ—¥å¿—â€çš„æ–¹å¼å·²ç»è¿‡æ—¶ã€‚ç°ä»£çš„å¯è§‚æµ‹æ€§ä½“ç³»åŒ…å«ä¸‰å¤§æ”¯æŸ±ï¼š<strong>æ—¥å¿— (Logging)</strong>ã€<strong>æŒ‡æ ‡ (Metrics)</strong> å’Œ <strong>é“¾è·¯è¿½è¸ª (Tracing)</strong>ã€‚</p><h5 id="_8-1-æ—¥å¿—-logging" tabindex="-1">8.1 æ—¥å¿— (Logging) <a class="header-anchor" href="#_8-1-æ—¥å¿—-logging" aria-label="Permalink to &quot;8.1 æ—¥å¿— (Logging)&quot;">â€‹</a></h5><ul><li><strong>æ ¸å¿ƒæ€æƒ³</strong>: å°†æ‰€æœ‰æ—¥å¿—ï¼ˆåº”ç”¨æ—¥å¿—ã€Nginxè®¿é—®æ—¥å¿—ã€æ•°æ®åº“æ—¥å¿—ç­‰ï¼‰ä»¥<strong>ç»“æ„åŒ–</strong>çš„æ ¼å¼ï¼ˆå¦‚JSONï¼‰å‘é€åˆ°ä¸€ä¸ªé›†ä¸­çš„æ—¥å¿—ç®¡ç†ç³»ç»Ÿã€‚</li><li><strong>ç»“æ„åŒ–æ—¥å¿—</strong>:<div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿ç”¨Monolog</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$log</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;User registered successfully.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;user_id&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;source&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;web_registration&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span></code></pre></div>è¿™ä¼šç”Ÿæˆç±»ä¼¼<code>{&quot;message&quot;: &quot;User registered...&quot;, &quot;context&quot;: {&quot;user_id&quot;: 123, ...}}</code>çš„JSONæ—¥å¿—ã€‚ç»“æ„åŒ–ä½¿å¾—æ—¥å¿—å¯ä»¥è¢«è½»æ¾åœ°æœç´¢ã€ç­›é€‰å’Œèšåˆã€‚</li><li><strong>å·¥å…·æ ˆ</strong>: <ul><li><strong>ELK Stack</strong>: Elasticsearch (å­˜å‚¨å’Œæœç´¢), Logstash (æ”¶é›†å’Œå¤„ç†), Kibana (å¯è§†åŒ–)ã€‚</li><li><strong>Loki</strong>: Grafanaæ¨å‡ºçš„è½»é‡çº§ã€ä½æˆæœ¬çš„æ›¿ä»£æ–¹æ¡ˆã€‚</li></ul></li></ul><h5 id="_8-2-æŒ‡æ ‡-metrics" tabindex="-1">8.2 æŒ‡æ ‡ (Metrics) <a class="header-anchor" href="#_8-2-æŒ‡æ ‡-metrics" aria-label="Permalink to &quot;8.2 æŒ‡æ ‡ (Metrics)&quot;">â€‹</a></h5><ul><li><strong>æ ¸å¿ƒæ€æƒ³</strong>: æŒ‡æ ‡æ˜¯å…³äºç³»ç»Ÿåœ¨ä¸€æ®µæ—¶é—´å†…è¡Œä¸ºçš„ã€å¯èšåˆçš„<strong>æ•°å­—</strong>æ•°æ®ã€‚ä¾‹å¦‚ï¼šQPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰ã€è¯·æ±‚å¹³å‡è€—æ—¶ã€é˜Ÿåˆ—ä»»åŠ¡æ•°é‡ã€CPUä½¿ç”¨ç‡ã€‚</li><li><strong>å·¥å…·æ ˆ</strong>: <ul><li><strong>Prometheus</strong>: ä¸€ä¸ªå¼€æºçš„ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿï¼Œå®ƒä»¥æ—¶é—´åºåˆ—çš„æ–¹å¼æ‹‰å–ï¼ˆpullï¼‰å’Œå­˜å‚¨æŒ‡æ ‡ã€‚</li><li><strong>Grafana</strong>: ä¸€ä¸ªå¼€æºçš„å¯è§†åŒ–å¹³å°ï¼Œå¯ä»¥è¿æ¥åˆ°Prometheusç­‰æ•°æ®æºï¼Œåˆ›å»ºæ¼‚äº®ã€åŠŸèƒ½å¼ºå¤§çš„ä»ªè¡¨ç›˜ã€‚</li></ul></li><li><strong>å®æˆ˜åº”ç”¨</strong>: ä½¿ç”¨<code>prom-client-php</code>ç­‰åº“ï¼Œåœ¨ä½ çš„PHPåº”ç”¨ä¸­æš´éœ²ä¸€ä¸ª<code>/metrics</code>ç«¯ç‚¹ï¼ŒPrometheusä¼šå®šæœŸè®¿é—®è¿™ä¸ªç«¯ç‚¹æ¥æŠ“å–æŒ‡æ ‡ã€‚<div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®°å½•ä¸€æ¬¡è®¢å•åˆ›å»º</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$counter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $registry</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getOrRegisterCounter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;myapp&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;orders_created&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Counts orders created&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$counter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®°å½•ä¸€æ¬¡APIè¯·æ±‚è€—æ—¶</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$histogram </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $registry</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getOrRegisterHistogram</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;myapp&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;api_request_latency_seconds&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;API request latency&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$histogram</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">observe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($duration);</span></span></code></pre></div></li></ul><h5 id="_8-3-é“¾è·¯è¿½è¸ª-tracing" tabindex="-1">8.3 é“¾è·¯è¿½è¸ª (Tracing) <a class="header-anchor" href="#_8-3-é“¾è·¯è¿½è¸ª-tracing" aria-label="Permalink to &quot;8.3 é“¾è·¯è¿½è¸ª (Tracing)&quot;">â€‹</a></h5><ul><li><strong>æ ¸å¿ƒæ€æƒ³</strong>: åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªç”¨æˆ·è¯·æ±‚å¯èƒ½ä¼šæµç»å¤šä¸ªæœåŠ¡ã€‚é“¾è·¯è¿½è¸ªå°†è¿™ä¸ªè¯·æ±‚çš„å®Œæ•´æ—…ç¨‹ï¼ˆtraceï¼‰ä¸²è”èµ·æ¥ï¼Œè®©ä½ èƒ½æ¸…æ™°åœ°çœ‹åˆ°è¯·æ±‚åœ¨æ¯ä¸ªæœåŠ¡ä¸­çš„è€—æ—¶ã€è°ƒç”¨å…³ç³»å’Œé”™è¯¯ã€‚</li><li><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>: <ul><li><strong>Trace</strong>: ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚é“¾è·¯ã€‚</li><li><strong>Span</strong>: é“¾è·¯ä¸­çš„ä¸€ä¸ªå·¥ä½œå•å…ƒï¼ˆå¦‚ä¸€æ¬¡HTTPè°ƒç”¨ã€ä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼‰ã€‚</li></ul></li><li><strong>å·¥å…·æ ˆ</strong>: <ul><li><strong>OpenTelemetry</strong>: ä¸€ä¸ªå¼€æ”¾çš„ã€å‚å•†ä¸­ç«‹çš„æ ‡å‡†å’Œå·¥å…·é›†ï¼Œç”¨äºé‡‡é›†å’Œå¯¼å‡ºé¥æµ‹æ•°æ®ï¼ˆtraces, metrics, logsï¼‰ã€‚</li><li><strong>Jaeger / Zipkin</strong>: å¼€æºçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨å’Œå¯è§†åŒ–Traceæ•°æ®ã€‚</li></ul></li><li><strong>å®æˆ˜åº”ç”¨</strong>: é€šè¿‡åœ¨åº”ç”¨ä¸­é›†æˆOpenTelemetry SDKï¼Œå®ƒå¯ä»¥è‡ªåŠ¨åœ°ä¸ºè¿›å…¥çš„HTTPè¯·æ±‚ã€å‘å‡ºçš„HTTPå®¢æˆ·ç«¯è°ƒç”¨ã€æ•°æ®åº“æŸ¥è¯¢ç­‰åˆ›å»ºSpanï¼Œå¹¶å°†å®ƒä»¬å…³è”èµ·æ¥ã€‚å½“ä½ åœ¨Jaeger UIä¸­æŸ¥çœ‹ä¸€ä¸ªTraceæ—¶ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªç€‘å¸ƒå›¾ï¼Œæ¸…æ™°åœ°å±•ç¤ºäº†â€œç”¨æˆ·è¯·æ±‚ -&gt; APIç½‘å…³ (20ms) -&gt; ç”¨æˆ·æœåŠ¡ (50ms) -&gt; æ•°æ®åº“æŸ¥è¯¢ (15ms)â€ï¼Œè®©ä½ èƒ½å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆã€‚</li></ul><p>é€šè¿‡å»ºç«‹å®Œå–„çš„å¯è§‚æµ‹æ€§ä½“ç³»ï¼Œä½ å°†ä»è¢«åŠ¨åœ°å“åº”æ•…éšœï¼Œè½¬å˜ä¸ºä¸»åŠ¨åœ°å‘ç°å’Œé¢„é˜²é—®é¢˜ï¼Œä»è€Œç¡®ä¿ç”Ÿäº§ç¯å¢ƒçš„ç¨³å®šå’Œé«˜æ•ˆã€‚</p><hr><h2 id="ğŸ‰-æ€»ç»“ä¸å±•æœ›" tabindex="-1">ğŸ‰ æ€»ç»“ä¸å±•æœ› <a class="header-anchor" href="#ğŸ‰-æ€»ç»“ä¸å±•æœ›" aria-label="Permalink to &quot;ğŸ‰ æ€»ç»“ä¸å±•æœ›&quot;">â€‹</a></h2><p>é€šè¿‡æœ¬æŒ‡å—çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ç°ä»£PHPå¼€å‘çš„æ ¸å¿ƒæŠ€èƒ½ä½“ç³»ï¼š</p><h3 id="ğŸ¯-æ ¸å¿ƒæ”¶è·" tabindex="-1">ğŸ¯ æ ¸å¿ƒæ”¶è· <a class="header-anchor" href="#ğŸ¯-æ ¸å¿ƒæ”¶è·" aria-label="Permalink to &quot;ğŸ¯ æ ¸å¿ƒæ”¶è·&quot;">â€‹</a></h3><p><strong>è¯­è¨€å±‚é¢</strong>ï¼š</p><ul><li>æ·±å…¥ç†è§£äº†PHP 8.xçš„æ–°ç‰¹æ€§ï¼ˆAttributesã€Enumsã€Fibersï¼‰</li><li>æŒæ¡äº†ç±»å‹å®‰å…¨ã€å…ƒç¼–ç¨‹å’Œåç¨‹ç¼–ç¨‹ç­‰ç°ä»£ç¼–ç¨‹èŒƒå¼</li><li>å­¦ä¼šäº†å¦‚ä½•åˆ©ç”¨è¯­è¨€ç‰¹æ€§æ„å»ºæ›´å¥å£®ã€å¯ç»´æŠ¤çš„ä»£ç </li></ul><p><strong>æ¶æ„å±‚é¢</strong>ï¼š</p><ul><li>è¶…è¶Šäº†ä¼ ç»Ÿçš„MVCæ¨¡å¼ï¼ŒæŒæ¡äº†æœåŠ¡åŒ–æ¶æ„è®¾è®¡</li><li>ç†è§£äº†Laravelç­‰æ¡†æ¶çš„é«˜çº§ç‰¹æ€§å’Œåº•å±‚åŸç†</li><li>å­¦ä¼šäº†é«˜æ€§èƒ½APIè®¾è®¡å’Œå¹¶å‘ç¼–ç¨‹çš„æœ€ä½³å®è·µ</li></ul><p><strong>å·¥ç¨‹åŒ–å±‚é¢</strong>ï¼š</p><ul><li>å»ºç«‹äº†å®Œæ•´çš„ä»£ç è´¨é‡ä¿éšœä½“ç³»</li><li>æŒæ¡äº†ç°ä»£DevOpsæµç¨‹å’Œè‡ªåŠ¨åŒ–å·¥å…·</li><li>ç†è§£äº†ç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§çš„é‡è¦æ€§å’Œå®ç°æ–¹æ³•</li></ul><h3 id="ğŸš€-ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®" tabindex="-1">ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®® <a class="header-anchor" href="#ğŸš€-ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®" aria-label="Permalink to &quot;ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®&quot;">â€‹</a></h3><ol><li><strong>å®è·µé¡¹ç›®</strong>ï¼šé€‰æ‹©ä¸€ä¸ªå°å‹é¡¹ç›®ï¼Œåº”ç”¨æœ¬æŒ‡å—ä¸­çš„æ‰€æœ‰æŠ€æœ¯ç‚¹</li><li><strong>æŠ€æœ¯æ ˆæ‰©å±•</strong>ï¼šæ¢ç´¢å®¹å™¨åŒ–ï¼ˆDockerï¼‰ã€äº‘åŸç”Ÿã€å¾®æœåŠ¡æ¶æ„</li><li><strong>æŒç»­å­¦ä¹ </strong>ï¼šå…³æ³¨PHPç¤¾åŒºçš„æœ€æ–°åŠ¨æ€ï¼Œå‚ä¸å¼€æºé¡¹ç›®</li><li><strong>çŸ¥è¯†åˆ†äº«</strong>ï¼šå°†æ‰€å­¦çŸ¥è¯†æ•´ç†æˆåšå®¢æˆ–æŠ€æœ¯åˆ†äº«ï¼Œæ•™å­¦ç›¸é•¿</li></ol><h3 id="ğŸ“š-æ¨èå­¦ä¹ èµ„æº" tabindex="-1">ğŸ“š æ¨èå­¦ä¹ èµ„æº <a class="header-anchor" href="#ğŸ“š-æ¨èå­¦ä¹ èµ„æº" aria-label="Permalink to &quot;ğŸ“š æ¨èå­¦ä¹ èµ„æº&quot;">â€‹</a></h3><ul><li><strong>å®˜æ–¹æ–‡æ¡£</strong>ï¼šPHPå®˜æ–¹æ‰‹å†Œã€Laravelæ–‡æ¡£</li><li><strong>ç¤¾åŒºèµ„æº</strong>ï¼šPHP FIG (PSRè§„èŒƒ)ã€Laravel Newsã€PHP Weekly</li><li><strong>å¼€æºé¡¹ç›®</strong>ï¼šLaravelã€Symfonyã€PHPStanã€PHP-CS-Fixerç­‰</li><li><strong>æŠ€æœ¯åšå®¢</strong>ï¼šLaracastsã€PHP The Right Wayã€Modern PHP</li></ul><hr><h2 id="ğŸ“–-é™„å½•" tabindex="-1">ğŸ“– é™„å½• <a class="header-anchor" href="#ğŸ“–-é™„å½•" aria-label="Permalink to &quot;ğŸ“– é™„å½•&quot;">â€‹</a></h2><h3 id="a-æ¨èçš„phpèµ„æº" tabindex="-1">A. æ¨èçš„PHPèµ„æº <a class="header-anchor" href="#a-æ¨èçš„phpèµ„æº" aria-label="Permalink to &quot;A. æ¨èçš„PHPèµ„æº&quot;">â€‹</a></h3><ul><li><strong>å®˜æ–¹æ–‡æ¡£</strong>ï¼š<a href="https://www.php.net/manual/zh/" target="_blank" rel="noreferrer">https://www.php.net/manual/zh/</a></li><li><strong>ç¤¾åŒºèµ„æº</strong>ï¼šPHP FIG (PSRè§„èŒƒ)ã€Laravel Newsã€PHP Weekly</li><li><strong>å¼€æºé¡¹ç›®</strong>ï¼šLaravelã€Symfonyã€PHPStanã€PHP-CS-Fixerç­‰</li></ul><h3 id="b-psr-è§„èŒƒé€ŸæŸ¥è¡¨" tabindex="-1">B. PSR è§„èŒƒé€ŸæŸ¥è¡¨ <a class="header-anchor" href="#b-psr-è§„èŒƒé€ŸæŸ¥è¡¨" aria-label="Permalink to &quot;B. PSR è§„èŒƒé€ŸæŸ¥è¡¨&quot;">â€‹</a></h3><ul><li><strong>PSR-1</strong>: åŸºç¡€ç¼–ç è§„èŒƒ</li><li><strong>PSR-4</strong>: è‡ªåŠ¨åŠ è½½è§„èŒƒ</li><li><strong>PSR-7</strong>: HTTPæ¶ˆæ¯æ¥å£</li><li><strong>PSR-12</strong>: ç¼–ç é£æ ¼è§„èŒƒ</li></ul><h3 id="c-å¸¸ç”¨è®¾è®¡æ¨¡å¼ä»£ç ç¤ºä¾‹" tabindex="-1">C. å¸¸ç”¨è®¾è®¡æ¨¡å¼ä»£ç ç¤ºä¾‹ <a class="header-anchor" href="#c-å¸¸ç”¨è®¾è®¡æ¨¡å¼ä»£ç ç¤ºä¾‹" aria-label="Permalink to &quot;C. å¸¸ç”¨è®¾è®¡æ¨¡å¼ä»£ç ç¤ºä¾‹&quot;">â€‹</a></h3><ul><li>å·¥å‚æ¨¡å¼ã€å•ä¾‹æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ç­‰</li><li>ä¾èµ–æ³¨å…¥ã€æœåŠ¡å®¹å™¨æ¨¡å¼</li><li>ä¸­é—´ä»¶æ¨¡å¼ã€è£…é¥°å™¨æ¨¡å¼</li></ul><hr><div class="text-center"><h2 id="ğŸ¯-å¼€å§‹ä½ çš„ç°ä»£åŒ–phpå¼€å‘ä¹‹æ—…" tabindex="-1">ğŸ¯ å¼€å§‹ä½ çš„ç°ä»£åŒ–PHPå¼€å‘ä¹‹æ—…ï¼ <a class="header-anchor" href="#ğŸ¯-å¼€å§‹ä½ çš„ç°ä»£åŒ–phpå¼€å‘ä¹‹æ—…" aria-label="Permalink to &quot;ğŸ¯ å¼€å§‹ä½ çš„ç°ä»£åŒ–PHPå¼€å‘ä¹‹æ—…ï¼&quot;">â€‹</a></h2><p><strong>è®°ä½</strong>ï¼šæŠ€æœ¯åªæ˜¯å·¥å…·ï¼ŒçœŸæ­£çš„ä»·å€¼åœ¨äºç”¨å®ƒä»¬è§£å†³å®é™…é—®é¢˜ã€‚ä¿æŒå¥½å¥‡å¿ƒï¼ŒæŒç»­å­¦ä¹ ï¼Œäº«å—ç¼–ç¨‹çš„ä¹è¶£ï¼</p></div>`,408)]))}const y=i(l,[["render",p]]);export{g as __pageData,y as default};
