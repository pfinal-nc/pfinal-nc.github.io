import{_ as i,c as a,o as n,a6 as t}from"./chunks/framework.DFafSIgU.js";const d=JSON.parse('{"title":"Python Coroutines","description":"Learning Python coroutines","frontmatter":{"title":"Python Coroutines","date":"2023-04-07T09:28:47.000Z","tags":["python"],"description":"Learning Python coroutines","author":"PFinal南丞","keywords":"Python, coroutine, concurrency, programming, asyncio, async IO, Future, Task","head":[["meta",{"name":"keywords","content":"Python, coroutine, concurrency, programming, asyncio, async IO, Future, Task"}]]},"headers":[],"relativePath":"Python/Python-Coroutines.md","filePath":"Python/Python-Coroutines.md","lastUpdated":1752111561000}'),e={name:"Python/Python-Coroutines.md"};function l(h,s,p,o,k,r){return n(),a("div",{"data-pagefind-body":!0},s[0]||(s[0]=[t(`<h1 id="python-coroutines" tabindex="-1">Python Coroutines <a class="header-anchor" href="#python-coroutines" aria-label="Permalink to &quot;Python Coroutines&quot;">​</a></h1><h2 id="coroutine" tabindex="-1">Coroutine <a class="header-anchor" href="#coroutine" aria-label="Permalink to &quot;Coroutine&quot;">​</a></h2><p>A coroutine, also known as a microthread, is a lightweight user-level thread. Coroutines have their own context and stack. When switching, the context and stack are saved elsewhere, and when switching back, the previously saved context and stack are restored. Therefore, coroutines can retain the state of the last call, i.e., a specific combination of all local states. Each time the process re-enters, it is equivalent to entering the state of the last call.</p><p>A simple coroutine implementation:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> coroutine_example</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;start coroutine...name:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> yield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># When next() is called, yield on the right produces a value and pauses; when send() is called, the value is assigned to x and continues execution</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;send value:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, x)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">coro </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> coroutine_example(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;PFinal&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Return value of next:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(coro))</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Return value of send:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, coro.send(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><p>When using coroutines, you need to prime (activate) them with next() before you can use send() to send values. (a = yield b): next will produce the value on the right of yield (b), send will receive the value on the left of yield (a).</p><p>Python implements coroutines mainly using the asyncio module for async IO.</p><p>Async IO in asyncio uses an event loop to drive coroutine-based concurrency. Users can actively control the program and add await (yield from) at time-consuming IO points. In the asyncio library, coroutines are decorated with @asyncio.coroutine and driven with yield from. @asyncio.coroutine -&gt; async, yield from -&gt; await</p><h4 id="important-concepts-in-asyncio" tabindex="-1">Important Concepts in asyncio <a class="header-anchor" href="#important-concepts-in-asyncio" aria-label="Permalink to &quot;Important Concepts in asyncio&quot;">​</a></h4><ol><li>Event Loop</li></ol><blockquote><p>Manages all events, continuously loops and executes during the program&#39;s runtime, tracks the order of events, puts them in a queue, and calls the corresponding event handler when idle.</p></blockquote><ol start="2"><li>Future</li></ol><blockquote><p>A Future object represents a computation that has not yet completed, an unfinished result.</p></blockquote><ol start="3"><li>Task</li></ol><blockquote><p>A subclass of Future, used to run multiple tasks concurrently. asyncio.Task is used to implement cooperative multitasking. Task objects cannot be instantiated by the user, but are created via two functions: asyncio.async(), loop.create_task(), or asyncio.ensure_future().</p></blockquote><p>Define a coroutine as follows:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -*- coding: utf-8 -*-</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># @Time    : 2023/4/7 09:02</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># @Author  : PFinal南尧</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># @Email   : lampxiezi@163.com</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># @File    : coroutine.py</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># @Software: PyCharm</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> asyncio</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Executing PFinal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">coro </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> execute()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">loop </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> asyncio.get_event_loop()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">loop.run_until_complete(coro)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">loop.close()</span></span></code></pre></div><blockquote><p>In the above code, async defines a function execute, which is called directly, but execute does not execute immediately, instead returns a coroutine object. Then, get_event_loop creates an event loop, and run_until_complete registers the coroutine to the event loop and starts it. Finally, execute prints the output result.</p></blockquote><p>Previously, we also mentioned task, which is a further encapsulation of the coroutine object, adding running states such as running, finished, etc., which can be used to get the execution status of the coroutine object. The code is as follows:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -*- coding: utf-8 -*-</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># @Time    : 2023/4/7 09:02</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># @Author  : PFinal南尧</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># @Email   : lampxiezi@163.com</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># @File    : coroutine.py</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># @Software: PyCharm</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> asyncio</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Executing PFinal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">coro </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> execute()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">loop </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> asyncio.get_event_loop()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loop.create_task(coro)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Task&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, task)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">loop.run_until_complete(task)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Task&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, task)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># loop.close()</span></span></code></pre></div><p>Running result:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Task</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Task</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pending</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name=&#39;Task-1&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Executing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PFinal</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Task</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Task</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> finished</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name=&#39;Task-1&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Process</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> finished,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><blockquote><p>In the above code, after defining the loop object, create_task is called to convert the coroutine object into a task object. Print it, and you will find it is in the pending state. Then, add the task object to the event loop for execution, print the task object again, and you will find its state has changed to finished. You can also see its result has become 1, which is the return result of the execute function.</p></blockquote>`,23)]))}const y=i(e,[["render",l]]);export{d as __pageData,y as default};
