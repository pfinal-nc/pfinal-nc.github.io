import{_ as i,c as a,o as n,ab as l}from"./chunks/framework.BHnvhWw7.js";const o=JSON.parse('{"title":"PostgreSQL性能优化实战 - 从配置到SQL调优的完整指南","description":"深入探讨PostgreSQL性能优化的各个方面，包括配置优化、SQL调优、索引策略、查询计划分析等，通过实战案例展示如何将PostgreSQL性能提升5-10倍。","frontmatter":{"title":"PostgreSQL性能优化实战 - 从配置到SQL调优的完整指南","date":"2025-12-16T00:00:00.000Z","updated":"2025-12-16T00:00:00.000Z","authors":["PFinal南丞"],"categories":["开发与系统","数据库"],"tags":["postgresql","性能优化","数据库调优","sql优化","postgresql配置"],"description":"深入探讨PostgreSQL性能优化的各个方面，包括配置优化、SQL调优、索引策略、查询计划分析等，通过实战案例展示如何将PostgreSQL性能提升5-10倍。","keywords":["PostgreSQL性能优化","PostgreSQL配置调优","SQL优化","PostgreSQL索引优化","查询计划分析","PostgreSQL调优实战","数据库性能监控","PostgreSQL最佳实践","数据库优化技巧","PostgreSQL 2025"],"head":[["link",{"rel":"canonical","href":"https://friday-go.icu/dev/system/database/PostgreSQL-Performance-Optimization-Guide"}],["meta",{"name":"keywords","content":"PostgreSQL性能优化,PostgreSQL配置调优,SQL优化,PostgreSQL索引优化,查询计划分析,PostgreSQL调优实战,数据库性能监控,PostgreSQL最佳实践,数据库优化技巧,PostgreSQL 2025, PFinalClub, Golang教程, Go后端开发, Go微服务, PHP, Python, 技术博客"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"TechArticle\\",\\"headline\\":\\"PostgreSQL性能优化实战 - 从配置到SQL调优的完整指南\\",\\"url\\":\\"https://friday-go.icu/dev/system/database/PostgreSQL-Performance-Optimization-Guide\\",\\"datePublished\\":\\"2025-12-16T00:00:00.000Z\\",\\"dateModified\\":1765850732000,\\"author\\":{\\"@type\\":\\"Person\\",\\"name\\":\\"PFinal南丞\\",\\"url\\":\\"https://friday-go.icu/about\\"},\\"publisher\\":{\\"@type\\":\\"Organization\\",\\"name\\":\\"PFinalClub\\",\\"logo\\":{\\"@type\\":\\"ImageObject\\",\\"url\\":\\"https://friday-go.icu/logo.png\\"}},\\"description\\":\\"深入探讨PostgreSQL性能优化的各个方面，包括配置优化、SQL调优、索引策略、查询计划分析等，通过实战案例展示如何将PostgreSQL性能提升5-10倍。\\",\\"inLanguage\\":\\"zh-CN\\",\\"mainEntityOfPage\\":{\\"@type\\":\\"WebPage\\",\\"@id\\":\\"https://friday-go.icu/dev/system/database/PostgreSQL-Performance-Optimization-Guide\\"},\\"keywords\\":[\\"PostgreSQL性能优化\\",\\"PostgreSQL配置调优\\",\\"SQL优化\\",\\"PostgreSQL索引优化\\",\\"查询计划分析\\",\\"PostgreSQL调优实战\\",\\"数据库性能监控\\",\\"PostgreSQL最佳实践\\",\\"数据库优化技巧\\",\\"PostgreSQL 2025\\"]}"]]},"headers":[],"relativePath":"dev/system/database/PostgreSQL-Performance-Optimization-Guide.md","filePath":"dev/system/database/PostgreSQL-Performance-Optimization-Guide.md","lastUpdated":1765850732000}'),h={name:"dev/system/database/PostgreSQL-Performance-Optimization-Guide.md"};function t(e,s,p,k,r,d){return n(),a("div",{"data-pagefind-body":!0,"data-pagefind-meta":"date:1765843200000"},s[0]||(s[0]=[l(`<h1 id="postgresql性能优化实战-从配置到sql调优的完整指南" tabindex="-1">PostgreSQL性能优化实战 - 从配置到SQL调优的完整指南 <a class="header-anchor" href="#postgresql性能优化实战-从配置到sql调优的完整指南" aria-label="Permalink to &quot;PostgreSQL性能优化实战 - 从配置到SQL调优的完整指南&quot;">​</a></h1><h2 id="_1-postgresql性能优化概述" tabindex="-1">1. PostgreSQL性能优化概述 <a class="header-anchor" href="#_1-postgresql性能优化概述" aria-label="Permalink to &quot;1. PostgreSQL性能优化概述&quot;">​</a></h2><p>PostgreSQL是一款功能强大的开源关系型数据库，但要充分发挥其性能潜力，需要进行合理的优化配置和SQL调优。性能优化是一个系统工程，涉及硬件、操作系统、数据库配置、Schema设计、索引策略、SQL编写等多个方面。</p><h3 id="_1-1-性能优化的目标" tabindex="-1">1.1 性能优化的目标 <a class="header-anchor" href="#_1-1-性能优化的目标" aria-label="Permalink to &quot;1.1 性能优化的目标&quot;">​</a></h3><ul><li><strong>提高查询响应时间</strong>：减少用户等待时间</li><li><strong>增加系统吞吐量</strong>：提高单位时间内处理的请求数量</li><li><strong>降低资源消耗</strong>：减少CPU、内存、磁盘IO等资源占用</li><li><strong>提高系统稳定性</strong>：减少系统崩溃和性能波动</li></ul><h2 id="_2-硬件与操作系统优化" tabindex="-1">2. 硬件与操作系统优化 <a class="header-anchor" href="#_2-硬件与操作系统优化" aria-label="Permalink to &quot;2. 硬件与操作系统优化&quot;">​</a></h2><h3 id="_2-1-硬件选择" tabindex="-1">2.1 硬件选择 <a class="header-anchor" href="#_2-1-硬件选择" aria-label="Permalink to &quot;2.1 硬件选择&quot;">​</a></h3><ul><li><strong>CPU</strong>：PostgreSQL对CPU核数敏感，建议选择多核CPU，如Intel Xeon或AMD EPYC系列</li><li><strong>内存</strong>：充足的内存是PostgreSQL高性能的关键，建议配置总数据量的2-4倍内存</li><li><strong>存储</strong>： <ul><li>推荐使用SSD存储，IOPS比HDD高10-100倍</li><li>考虑使用NVMe SSD进一步提高性能</li><li>对于大型数据库，考虑使用存储阵列或分布式存储</li></ul></li><li><strong>网络</strong>：使用千兆或万兆网络，减少网络延迟</li></ul><h3 id="_2-2-操作系统优化" tabindex="-1">2.2 操作系统优化 <a class="header-anchor" href="#_2-2-操作系统优化" aria-label="Permalink to &quot;2.2 操作系统优化&quot;">​</a></h3><h4 id="_2-2-1-linux内核参数优化" tabindex="-1">2.2.1 Linux内核参数优化 <a class="header-anchor" href="#_2-2-1-linux内核参数优化" aria-label="Permalink to &quot;2.2.1 Linux内核参数优化&quot;">​</a></h4><p>编辑<code>/etc/sysctl.conf</code>文件，添加以下优化参数：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 网络优化</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.somaxconn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_max_syn_backlog</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_fin_timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_keepalive_time</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1200</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_max_tw_buckets</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 400000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 内存管理</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vm.swappiness</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vm.dirty_background_ratio</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vm.dirty_ratio</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vm.overcommit_memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vm.overcommit_ratio</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 90</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 文件系统</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fs.file-max</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 65536</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fs.aio-max-nr</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1048576</span></span></code></pre></div><h4 id="_2-2-2-资源限制优化" tabindex="-1">2.2.2 资源限制优化 <a class="header-anchor" href="#_2-2-2-资源限制优化" aria-label="Permalink to &quot;2.2.2 资源限制优化&quot;">​</a></h4><p>编辑<code>/etc/security/limits.conf</code>文件，添加以下配置：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postgres</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> soft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nofile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 65536</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postgres</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> hard</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nofile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 65536</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postgres</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> soft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nproc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32768</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postgres</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> hard</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nproc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32768</span></span></code></pre></div><h4 id="_2-2-3-文件系统选择" tabindex="-1">2.2.3 文件系统选择 <a class="header-anchor" href="#_2-2-3-文件系统选择" aria-label="Permalink to &quot;2.2.3 文件系统选择&quot;">​</a></h4><ul><li><strong>ext4</strong>：稳定可靠，适合大多数场景</li><li><strong>XFS</strong>：适合大文件和高并发场景</li><li><strong>Btrfs</strong>：支持快照和校验和，适合需要高级功能的场景</li></ul><p>建议使用XFS文件系统，并启用以下挂载选项：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/dev/sdb1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/postgresql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> xfs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> defaults,noatime,nodiratime,inode64</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span></code></pre></div><h2 id="_3-postgresql配置优化" tabindex="-1">3. PostgreSQL配置优化 <a class="header-anchor" href="#_3-postgresql配置优化" aria-label="Permalink to &quot;3. PostgreSQL配置优化&quot;">​</a></h2><h3 id="_3-1-主配置文件" tabindex="-1">3.1 主配置文件 <a class="header-anchor" href="#_3-1-主配置文件" aria-label="Permalink to &quot;3.1 主配置文件&quot;">​</a></h3><p>PostgreSQL的主配置文件通常位于<code>/etc/postgresql/15/main/postgresql.conf</code>（版本15）。</p><h3 id="_3-2-关键配置参数" tabindex="-1">3.2 关键配置参数 <a class="header-anchor" href="#_3-2-关键配置参数" aria-label="Permalink to &quot;3.2 关键配置参数&quot;">​</a></h3><h4 id="_3-2-1-内存配置" tabindex="-1">3.2.1 内存配置 <a class="header-anchor" href="#_3-2-1-内存配置" aria-label="Permalink to &quot;3.2.1 内存配置&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 共享内存</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shared_buffers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8GB</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              # 建议设置为总内存的25%</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 工作内存</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">work_mem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 64MB</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   # 每个查询操作的工作内存</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">maintenance_work_mem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1GB</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 维护操作（如VACUUM）的内存</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 有效缓存大小（告诉PostgreSQL操作系统可用的缓存）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">effective_cache_size</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 24GB</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # 建议设置为总内存的75%</span></span></code></pre></div><h4 id="_3-2-2-连接配置" tabindex="-1">3.2.2 连接配置 <a class="header-anchor" href="#_3-2-2-连接配置" aria-label="Permalink to &quot;3.2.2 连接配置&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 最大连接数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_connections</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 200</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             # 根据实际需求调整</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 连接认证超时</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authentication_timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1min</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # 防止连接滥用</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># TCP配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tcp_keepalives_idle</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tcp_keepalives_interval</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tcp_keepalives_count</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span></span></code></pre></div><h4 id="_3-2-3-wal配置" tabindex="-1">3.2.3 WAL配置 <a class="header-anchor" href="#_3-2-3-wal配置" aria-label="Permalink to &quot;3.2.3 WAL配置&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># WAL缓冲区大小</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wal_buffers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 16MB</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                # 建议设置为32MB-128MB</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># WAL写入模式</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wal_writer_delay</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 200ms</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # WAL写入延迟</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查点配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkpoint_timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 30min</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 检查点间隔</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_wal_size</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10GB</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               # 最大WAL大小</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">min_wal_size</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2GB</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                # 最小WAL大小</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkpoint_completion_target</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.9</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 检查点完成目标比例</span></span></code></pre></div><h4 id="_3-2-4-优化器配置" tabindex="-1">3.2.4 优化器配置 <a class="header-anchor" href="#_3-2-4-优化器配置" aria-label="Permalink to &quot;3.2.4 优化器配置&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 统计信息收集</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   # 自动VACUUM</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum_max_workers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 自动VACUUM最大工作线程</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum_naptime</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1min</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         # 自动VACUUM间隔</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 统计信息更新阈值</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum_vacuum_threshold</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum_analyze_threshold</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 随机页面成本（SSD设置为1-2，HDD设置为4-5）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">random_page_cost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            # SSD存储</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seq_page_cost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.0</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               # 顺序扫描成本</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 有效IO吞吐量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">effective_io_concurrency</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 200</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # SSD设置为200-400，HDD设置为2-4</span></span></code></pre></div><h4 id="_3-2-5-其他重要配置" tabindex="-1">3.2.5 其他重要配置 <a class="header-anchor" href="#_3-2-5-其他重要配置" aria-label="Permalink to &quot;3.2.5 其他重要配置&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 日志配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">logging_collector</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_line_prefix</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h &#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_statement</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ddl&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             # 记录DDL语句</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_min_duration_statement</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 记录执行时间超过1秒的语句</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 死锁检测</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deadlock_timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1s</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             # 死锁检测超时</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 并行查询</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_parallel_workers_per_gather</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 每个Gather节点的最大并行工作者</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_parallel_workers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # 系统最大并行工作者数</span></span></code></pre></div><h2 id="_4-schema设计优化" tabindex="-1">4. Schema设计优化 <a class="header-anchor" href="#_4-schema设计优化" aria-label="Permalink to &quot;4. Schema设计优化&quot;">​</a></h2><h3 id="_4-1-数据类型选择" tabindex="-1">4.1 数据类型选择 <a class="header-anchor" href="#_4-1-数据类型选择" aria-label="Permalink to &quot;4.1 数据类型选择&quot;">​</a></h3><ul><li><strong>使用合适的数值类型</strong>：如使用<code>smallint</code>代替<code>integer</code>，<code>integer</code>代替<code>bigint</code>，节省存储空间</li><li><strong>避免使用<code>text</code>存储小字符串</strong>：使用<code>varchar(n)</code>或<code>char(n)</code></li><li><strong>使用<code>date</code>/<code>timestamp</code>存储日期时间</strong>：避免使用字符串</li><li><strong>使用<code>jsonb</code>代替<code>json</code></strong>：<code>jsonb</code>支持索引和更快的查询</li></ul><h3 id="_4-2-表设计优化" tabindex="-1">4.2 表设计优化 <a class="header-anchor" href="#_4-2-表设计优化" aria-label="Permalink to &quot;4.2 表设计优化&quot;">​</a></h3><ul><li><strong>避免宽表设计</strong>：将不常用的列拆分到单独的表中</li><li><strong>使用分区表</strong>：对于大表，使用分区提高查询性能</li><li><strong>合理设置主键</strong>：使用自增整数或UUID作为主键</li><li><strong>避免NULL值</strong>：为列设置合理的默认值</li></ul><h3 id="_4-3-分区表示例" tabindex="-1">4.3 分区表示例 <a class="header-anchor" href="#_4-3-分区表示例" aria-label="Permalink to &quot;4.3 分区表示例&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 创建分区表</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> orders</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bigserial</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    order_date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">date</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    customer_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">integer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">numeric</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT NULL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PARTITION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> BY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RANGE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (order_date);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 创建分区</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> orders_2024_01</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> PARTITION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> OF orders</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> VALUES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-01-01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-02-01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> orders_2024_02</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> PARTITION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> OF orders</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> VALUES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-02-01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-03-01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 创建索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_orders_order_date</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders(order_date);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_orders_customer_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders(customer_id);</span></span></code></pre></div><h2 id="_5-索引策略优化" tabindex="-1">5. 索引策略优化 <a class="header-anchor" href="#_5-索引策略优化" aria-label="Permalink to &quot;5. 索引策略优化&quot;">​</a></h2><h3 id="_5-1-索引类型" tabindex="-1">5.1 索引类型 <a class="header-anchor" href="#_5-1-索引类型" aria-label="Permalink to &quot;5.1 索引类型&quot;">​</a></h3><ul><li><strong>B-tree索引</strong>：最常用的索引类型，适合等值查询、范围查询和排序</li><li><strong>Hash索引</strong>：适合等值查询，但不支持范围查询和排序</li><li><strong>GiST索引</strong>：适合几何数据、全文搜索等复杂数据类型</li><li><strong>SP-GiST索引</strong>：适合非平衡数据结构，如前缀树</li><li><strong>GIN索引</strong>：适合数组、jsonb等多值数据类型</li><li><strong>BRIN索引</strong>：适合大数据集的范围查询，如时间序列数据</li></ul><h3 id="_5-2-索引设计原则" tabindex="-1">5.2 索引设计原则 <a class="header-anchor" href="#_5-2-索引设计原则" aria-label="Permalink to &quot;5.2 索引设计原则&quot;">​</a></h3><ul><li><strong>选择合适的索引类型</strong>：根据查询模式选择</li><li><strong>索引选择性</strong>：选择选择性高的列（重复值少）</li><li><strong>联合索引顺序</strong>：将选择性高的列放在前面</li><li><strong>避免过度索引</strong>：每个索引都会增加写入开销</li><li><strong>考虑查询模式</strong>：为经常用于WHERE、JOIN、ORDER BY的列创建索引</li></ul><h3 id="_5-3-索引优化示例" tabindex="-1">5.3 索引优化示例 <a class="header-anchor" href="#_5-3-索引优化示例" aria-label="Permalink to &quot;5.3 索引优化示例&quot;">​</a></h3><h4 id="_5-3-1-单列索引" tabindex="-1">5.3.1 单列索引 <a class="header-anchor" href="#_5-3-1-单列索引" aria-label="Permalink to &quot;5.3.1 单列索引&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 为经常查询的列创建索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_users_email</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users(email);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_products_price</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> products(price);</span></span></code></pre></div><h4 id="_5-3-2-联合索引" tabindex="-1">5.3.2 联合索引 <a class="header-anchor" href="#_5-3-2-联合索引" aria-label="Permalink to &quot;5.3.2 联合索引&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 为经常一起查询的列创建联合索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_orders_customer_date</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders(customer_id, order_date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 适合查询：WHERE customer_id = 123 ORDER BY order_date DESC</span></span></code></pre></div><h4 id="_5-3-3-部分索引" tabindex="-1">5.3.3 部分索引 <a class="header-anchor" href="#_5-3-3-部分索引" aria-label="Permalink to &quot;5.3.3 部分索引&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 只为活跃用户创建索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_users_active_email</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users(email) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;active&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 适合查询：WHERE status = &#39;active&#39; AND email LIKE &#39;%@example.com&#39;</span></span></code></pre></div><h4 id="_5-3-4-表达式索引" tabindex="-1">5.3.4 表达式索引 <a class="header-anchor" href="#_5-3-4-表达式索引" aria-label="Permalink to &quot;5.3.4 表达式索引&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 为表达式创建索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_users_lower_email</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lower</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(email));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 适合查询：WHERE lower(email) = &#39;user@example.com&#39;</span></span></code></pre></div><h4 id="_5-3-5-gin索引-jsonb" tabindex="-1">5.3.5 GIN索引（jsonb） <a class="header-anchor" href="#_5-3-5-gin索引-jsonb" aria-label="Permalink to &quot;5.3.5 GIN索引（jsonb）&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 为jsonb字段创建GIN索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_products_attributes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> products </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> GIN(attributes);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 适合查询：WHERE attributes @&gt; &#39;{&quot;color&quot;: &quot;red&quot;}&#39;</span></span></code></pre></div><h2 id="_6-sql查询优化" tabindex="-1">6. SQL查询优化 <a class="header-anchor" href="#_6-sql查询优化" aria-label="Permalink to &quot;6. SQL查询优化&quot;">​</a></h2><h3 id="_6-1-查看查询计划" tabindex="-1">6.1 查看查询计划 <a class="header-anchor" href="#_6-1-查看查询计划" aria-label="Permalink to &quot;6.1 查看查询计划&quot;">​</a></h3><p>使用<code>EXPLAIN ANALYZE</code>查看查询执行计划：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EXPLAIN ANALYZE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> email </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;user@example.com&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h3 id="_6-2-查询优化技巧" tabindex="-1">6.2 查询优化技巧 <a class="header-anchor" href="#_6-2-查询优化技巧" aria-label="Permalink to &quot;6.2 查询优化技巧&quot;">​</a></h3><h4 id="_6-2-1-避免全表扫描" tabindex="-1">6.2.1 避免全表扫描 <a class="header-anchor" href="#_6-2-1-避免全表扫描" aria-label="Permalink to &quot;6.2.1 避免全表扫描&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 不好：没有索引，会导致全表扫描</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;2024-01-01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 好：为created_at创建索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_users_created_at</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users(created_at);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;2024-01-01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h4 id="_6-2-2-避免select" tabindex="-1">6.2.2 避免SELECT * <a class="header-anchor" href="#_6-2-2-避免select" aria-label="Permalink to &quot;6.2.2 避免SELECT *&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 不好：返回所有列，增加网络传输和IO</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 好：只返回需要的列</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, email </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h4 id="_6-2-3-优化join查询" tabindex="-1">6.2.3 优化JOIN查询 <a class="header-anchor" href="#_6-2-3-优化join查询" aria-label="Permalink to &quot;6.2.3 优化JOIN查询&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 确保连接列有索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_orders_customer_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders(customer_id);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用INNER JOIN代替其他JOIN类型（如果可能）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users u</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INNER JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders o </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">customer_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;active&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h4 id="_6-2-4-优化子查询" tabindex="-1">6.2.4 优化子查询 <a class="header-anchor" href="#_6-2-4-优化子查询" aria-label="Permalink to &quot;6.2.4 优化子查询&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 不好：相关子查询，效率低</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">IN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> customer_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 好：使用JOIN代替子查询</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT DISTINCT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> u.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users u</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INNER JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders o </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">customer_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">amount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 更好：使用EXISTS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users u</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders o </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">customer_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">amount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="_6-2-5-优化聚合查询" tabindex="-1">6.2.5 优化聚合查询 <a class="header-anchor" href="#_6-2-5-优化聚合查询" aria-label="Permalink to &quot;6.2.5 优化聚合查询&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 为聚合列创建索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_orders_amount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders(amount);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用GROUP BY时，确保分组列有索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> customer_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(amount) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> customer_id </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(amount) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h4 id="_6-2-6-优化limit查询" tabindex="-1">6.2.6 优化LIMIT查询 <a class="header-anchor" href="#_6-2-6-优化limit查询" aria-label="Permalink to &quot;6.2.6 优化LIMIT查询&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 为ORDER BY列创建索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_products_created_at</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> products(created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 高效的LIMIT查询</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> products </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h2 id="_7-vacuum与analyze" tabindex="-1">7. VACUUM与ANALYZE <a class="header-anchor" href="#_7-vacuum与analyze" aria-label="Permalink to &quot;7. VACUUM与ANALYZE&quot;">​</a></h2><h3 id="_7-1-vacuum的作用" tabindex="-1">7.1 VACUUM的作用 <a class="header-anchor" href="#_7-1-vacuum的作用" aria-label="Permalink to &quot;7.1 VACUUM的作用&quot;">​</a></h3><ul><li>回收被删除行占用的空间</li><li>标记过期的行版本</li><li>防止表膨胀</li><li>更新可见性映射</li></ul><h3 id="_7-2-vacuum操作" tabindex="-1">7.2 VACUUM操作 <a class="header-anchor" href="#_7-2-vacuum操作" aria-label="Permalink to &quot;7.2 VACUUM操作&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 普通VACUUM（不阻塞查询）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">VACUUM users;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 完整VACUUM（重建表，阻塞查询）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">VACUUM FULL users;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 带有ANALYZE的VACUUM</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">VACUUM ANALYZE users;</span></span></code></pre></div><h3 id="_7-3-analyze的作用" tabindex="-1">7.3 ANALYZE的作用 <a class="header-anchor" href="#_7-3-analyze的作用" aria-label="Permalink to &quot;7.3 ANALYZE的作用&quot;">​</a></h3><ul><li>更新表的统计信息</li><li>帮助查询优化器生成更好的执行计划</li><li>统计信息存储在<code>pg_statistic</code>系统表中</li></ul><h3 id="_7-4-自动vacuum配置" tabindex="-1">7.4 自动VACUUM配置 <a class="header-anchor" href="#_7-4-自动vacuum配置" aria-label="Permalink to &quot;7.4 自动VACUUM配置&quot;">​</a></h3><p>PostgreSQL默认启用自动VACUUM，可以通过以下参数调整：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum_max_workers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum_naptime</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1min</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum_vacuum_threshold</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum_analyze_threshold</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum_vacuum_scale_factor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.02</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">autovacuum_analyze_scale_factor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.01</span></span></code></pre></div><h2 id="_8-性能监控与诊断" tabindex="-1">8. 性能监控与诊断 <a class="header-anchor" href="#_8-性能监控与诊断" aria-label="Permalink to &quot;8. 性能监控与诊断&quot;">​</a></h2><h3 id="_8-1-内置监控视图" tabindex="-1">8.1 内置监控视图 <a class="header-anchor" href="#_8-1-内置监控视图" aria-label="Permalink to &quot;8.1 内置监控视图&quot;">​</a></h3><h4 id="_8-1-1-连接监控" tabindex="-1">8.1.1 连接监控 <a class="header-anchor" href="#_8-1-1-连接监控" aria-label="Permalink to &quot;8.1.1 连接监控&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看当前连接</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_activity;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看连接数统计</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> state</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_activity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> state</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h4 id="_8-1-2-表性能监控" tabindex="-1">8.1.2 表性能监控 <a class="header-anchor" href="#_8-1-2-表性能监控" aria-label="Permalink to &quot;8.1.2 表性能监控&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看表的IO统计</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_user_tables;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看索引使用情况</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_user_indexes;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看未使用的索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> schemaname, relname, indexrelname </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_user_indexes </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> idx_scan </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h4 id="_8-1-3-系统资源监控" tabindex="-1">8.1.3 系统资源监控 <a class="header-anchor" href="#_8-1-3-系统资源监控" aria-label="Permalink to &quot;8.1.3 系统资源监控&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看系统负载</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_os_sysinfo;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看内存使用</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_bgwriter;</span></span></code></pre></div><h3 id="_8-2-第三方监控工具" tabindex="-1">8.2 第三方监控工具 <a class="header-anchor" href="#_8-2-第三方监控工具" aria-label="Permalink to &quot;8.2 第三方监控工具&quot;">​</a></h3><ul><li><strong>pgAdmin</strong>：官方图形化管理工具，内置监控功能</li><li><strong>Prometheus + Grafana</strong>：流行的监控组合，有PostgreSQL exporter</li><li><strong>pg_stat_monitor</strong>：增强版的统计信息收集工具</li><li><strong>pganalyze</strong>：云端PostgreSQL监控服务</li><li><strong>Datadog</strong>：全栈监控平台，支持PostgreSQL</li></ul><h3 id="_8-3-慢查询日志" tabindex="-1">8.3 慢查询日志 <a class="header-anchor" href="#_8-3-慢查询日志" aria-label="Permalink to &quot;8.3 慢查询日志&quot;">​</a></h3><p>启用慢查询日志：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_min_duration_statement</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 记录执行时间超过1秒的语句</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_statement</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;none&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             # 只记录慢查询</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_line_prefix</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h &#39;</span></span></code></pre></div><p>分析慢查询日志：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用pgBadger分析慢查询日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pgbadger</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pgbadger.html</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/log/postgresql/postgresql-15-main.log</span></span></code></pre></div><h2 id="_9-高级性能优化技术" tabindex="-1">9. 高级性能优化技术 <a class="header-anchor" href="#_9-高级性能优化技术" aria-label="Permalink to &quot;9. 高级性能优化技术&quot;">​</a></h2><h3 id="_9-1-连接池" tabindex="-1">9.1 连接池 <a class="header-anchor" href="#_9-1-连接池" aria-label="Permalink to &quot;9.1 连接池&quot;">​</a></h3><p>使用连接池可以减少连接创建和销毁的开销，提高系统吞吐量。</p><h4 id="_9-1-1-pgbouncer" tabindex="-1">9.1.1 PgBouncer <a class="header-anchor" href="#_9-1-1-pgbouncer" aria-label="Permalink to &quot;9.1.1 PgBouncer&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 安装PgBouncer</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pgbouncer</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 配置PgBouncer</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /etc/pgbouncer/pgbouncer.ini</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[databases]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postgres</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> host=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">127.0.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5432</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dbname=postgres</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[pgbouncer]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">listen_addr</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">listen_port</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6432</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">auth_type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> md5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">auth_file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/pgbouncer/userlist.txt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pool_mode</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> transaction</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_client_conn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">default_pool_size</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span></span></code></pre></div><h4 id="_9-1-2-pgpool-ii" tabindex="-1">9.1.2 Pgpool-II <a class="header-anchor" href="#_9-1-2-pgpool-ii" aria-label="Permalink to &quot;9.1.2 Pgpool-II&quot;">​</a></h4><p>Pgpool-II提供连接池、负载均衡、故障转移等高级功能。</p><h3 id="_9-2-读写分离" tabindex="-1">9.2 读写分离 <a class="header-anchor" href="#_9-2-读写分离" aria-label="Permalink to &quot;9.2 读写分离&quot;">​</a></h3><p>对于读多写少的场景，可以采用读写分离架构：</p><ul><li>主库处理写操作</li><li>从库处理读操作</li><li>使用流复制或逻辑复制保持数据同步</li></ul><h3 id="_9-3-分片-sharding" tabindex="-1">9.3 分片（Sharding） <a class="header-anchor" href="#_9-3-分片-sharding" aria-label="Permalink to &quot;9.3 分片（Sharding）&quot;">​</a></h3><p>对于超大规模数据库，可以使用分片技术：</p><ul><li><strong>水平分片</strong>：按行分割数据到多个节点</li><li><strong>垂直分片</strong>：按列分割数据到多个节点</li><li><strong>使用PgShard</strong>：PostgreSQL的分片扩展</li><li><strong>使用Citus</strong>：分布式PostgreSQL扩展</li></ul><h3 id="_9-4-缓存策略" tabindex="-1">9.4 缓存策略 <a class="header-anchor" href="#_9-4-缓存策略" aria-label="Permalink to &quot;9.4 缓存策略&quot;">​</a></h3><ul><li><strong>应用层缓存</strong>：使用Redis或Memcached缓存热点数据</li><li><strong>数据库缓存</strong>：充分利用PostgreSQL的shared_buffers</li><li><strong>查询缓存</strong>：对于频繁执行的相同查询，可以缓存结果</li></ul><h3 id="_9-5-并行查询" tabindex="-1">9.5 并行查询 <a class="header-anchor" href="#_9-5-并行查询" aria-label="Permalink to &quot;9.5 并行查询&quot;">​</a></h3><p>PostgreSQL 9.6+支持并行查询，可以通过以下参数启用：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_parallel_workers_per_gather</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max_parallel_workers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parallel_tuple_cost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parallel_setup_cost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span></span></code></pre></div><h2 id="_10-性能优化实战案例" tabindex="-1">10. 性能优化实战案例 <a class="header-anchor" href="#_10-性能优化实战案例" aria-label="Permalink to &quot;10. 性能优化实战案例&quot;">​</a></h2><h3 id="_10-1-案例-慢查询优化" tabindex="-1">10.1 案例：慢查询优化 <a class="header-anchor" href="#_10-1-案例-慢查询优化" aria-label="Permalink to &quot;10.1 案例：慢查询优化&quot;">​</a></h3><p><strong>问题</strong>：查询<code>SELECT * FROM orders WHERE customer_id = 123 AND order_date &gt; &#39;2024-01-01&#39; ORDER BY amount DESC LIMIT 10;</code>执行缓慢。</p><p><strong>分析</strong>：</p><ol><li>使用<code>EXPLAIN ANALYZE</code>查看执行计划</li><li>发现执行了全表扫描</li><li>customer_id和order_date列没有合适的索引</li></ol><p><strong>解决方案</strong>：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 创建联合索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_orders_customer_date_amount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders(customer_id, order_date, amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>优化效果</strong>：查询时间从5秒降低到0.1秒。</p><h3 id="_10-2-案例-表膨胀优化" tabindex="-1">10.2 案例：表膨胀优化 <a class="header-anchor" href="#_10-2-案例-表膨胀优化" aria-label="Permalink to &quot;10.2 案例：表膨胀优化&quot;">​</a></h3><p><strong>问题</strong>：users表大小异常增长，查询性能下降。</p><p><strong>分析</strong>：</p><ol><li>查看表大小：<code>SELECT pg_size_pretty(pg_total_relation_size(&#39;users&#39;));</code></li><li>查看表膨胀率：使用<code>pgstattuple</code>扩展</li><li>发现表膨胀严重，需要VACUUM FULL</li></ol><p><strong>解决方案</strong>：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 安装pgstattuple扩展</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXTENSION pgstattuple;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看表膨胀情况</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pgstattuple(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;users&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 执行完整VACUUM</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">VACUUM FULL ANALYZE users;</span></span></code></pre></div><p><strong>优化效果</strong>：表大小从10GB降低到2GB，查询性能提升3倍。</p><h2 id="_11-最佳实践总结" tabindex="-1">11. 最佳实践总结 <a class="header-anchor" href="#_11-最佳实践总结" aria-label="Permalink to &quot;11. 最佳实践总结&quot;">​</a></h2><h3 id="_11-1-硬件与系统" tabindex="-1">11.1 硬件与系统 <a class="header-anchor" href="#_11-1-硬件与系统" aria-label="Permalink to &quot;11.1 硬件与系统&quot;">​</a></h3><ul><li>选择高性能硬件，尤其是SSD存储</li><li>优化操作系统内核参数</li><li>使用合适的文件系统和挂载选项</li></ul><h3 id="_11-2-数据库配置" tabindex="-1">11.2 数据库配置 <a class="header-anchor" href="#_11-2-数据库配置" aria-label="Permalink to &quot;11.2 数据库配置&quot;">​</a></h3><ul><li>根据硬件配置调整内存参数</li><li>优化WAL配置，提高写入性能</li><li>根据查询模式调整优化器参数</li><li>启用自动VACUUM和ANALYZE</li></ul><h3 id="_11-3-schema设计" tabindex="-1">11.3 Schema设计 <a class="header-anchor" href="#_11-3-schema设计" aria-label="Permalink to &quot;11.3 Schema设计&quot;">​</a></h3><ul><li>选择合适的数据类型</li><li>合理设计表结构，避免宽表</li><li>对于大表使用分区</li></ul><h3 id="_11-4-索引策略" tabindex="-1">11.4 索引策略 <a class="header-anchor" href="#_11-4-索引策略" aria-label="Permalink to &quot;11.4 索引策略&quot;">​</a></h3><ul><li>选择合适的索引类型</li><li>为常用查询列创建索引</li><li>避免过度索引</li><li>定期清理未使用的索引</li></ul><h3 id="_11-5-sql编写" tabindex="-1">11.5 SQL编写 <a class="header-anchor" href="#_11-5-sql编写" aria-label="Permalink to &quot;11.5 SQL编写&quot;">​</a></h3><ul><li>避免全表扫描</li><li>只查询需要的列</li><li>优化JOIN和子查询</li><li>使用EXPLAIN ANALYZE分析查询计划</li></ul><h3 id="_11-6-监控与维护" tabindex="-1">11.6 监控与维护 <a class="header-anchor" href="#_11-6-监控与维护" aria-label="Permalink to &quot;11.6 监控与维护&quot;">​</a></h3><ul><li>启用慢查询日志</li><li>定期监控系统性能</li><li>定期执行VACUUM和ANALYZE</li><li>定期检查索引使用情况</li></ul><h3 id="_11-7-高级优化" tabindex="-1">11.7 高级优化 <a class="header-anchor" href="#_11-7-高级优化" aria-label="Permalink to &quot;11.7 高级优化&quot;">​</a></h3><ul><li>使用连接池减少连接开销</li><li>考虑读写分离和分片</li><li>合理使用缓存</li><li>利用并行查询提高查询性能</li></ul><h2 id="_12-结语" tabindex="-1">12. 结语 <a class="header-anchor" href="#_12-结语" aria-label="Permalink to &quot;12. 结语&quot;">​</a></h2><p>PostgreSQL性能优化是一个持续的过程，需要根据实际业务场景和数据量不断调整和优化。通过本文介绍的优化技术，你可以从硬件、操作系统、数据库配置、Schema设计、索引策略、SQL编写等多个方面入手，全面提升PostgreSQL的性能。</p><p>记住，没有放之四海而皆准的优化方案，最佳的优化策略总是基于实际的性能测试和监控数据。建议在优化前建立性能基准，优化后进行对比测试，确保优化效果符合预期。</p><p>希望本文对你的PostgreSQL性能优化之旅有所帮助！</p>`,150)]))}const F=i(h,[["render",t]]);export{o as __pageData,F as default};
